EXTMODS=@EXTMODS@
ALLEXTMODS=@ALLEXTMODS@
shared_suffix=@shared_suffix@
KNO_BRANCH=@KNO_BRANCH@
BRANCH=$(cat .branch 2>/dev/null||echo ${KNO_BRANCH})

%/.git:
	@git clone git@github.com:beingmeta/kno-$(@D).git $(@D)
	@cd $(@D); git checkout ${BRANCH} || git checkout main;
	@if test -d ../../lib/kno; then 				\
	   ("cd"  ../../lib/kno; 						\
	    ln -sf ../../src/extmods/$(@D)/$(@D).${shared_suffix}	\
	 	   $(@D).${shared_suffix}); 				\
	fi; 

hyphenate leveldb rocksdb mongodb postgres mariadb odbc nng zeromq archivetools imagetools mod_knocgi sundown tidy ziptools:
	make $@/.git

# Utility targets

default: extmods

extmods: ${EXTMODS}
allmods: ${ALLEXTMODS}
checkout update:
	@for mod in ${EXTMODS}; do 						\
	  if test -f $${mod}.skip; then 					\
	    echo > /dev/null; 							\
	  else 									\
	    if [ ! -d $${mod}/.git ]; then 					\
	      echo "Cloning $${mod} into a local .git repo"; 			\
	      git clone git@github.com:beingmeta/kno-$${mod}.git $${mod};	\
	    else 								\
	     echo "# In $${mod}";						\
	    fi; 								\
	    ("cd" $${mod}; git pull &&						\
	     (git checkout ${BRANCH} || git checkout main) &&			\
	     git pull) 								\
	  fi; 									\
	done;

commit:
	if [ ! -z "${MSG}" ]; then \
	  for dir in *; do if [ -d $${dir}/.git ]; then \
	    ("cd" ${dir}; git commit --all -m "$${MSG}"); fi; \
	  done; \
	else echo "No MSG specified"; fi

status:
	mapgit status -suno
diff:
	mapgit diff

build: extmods
	domake ${EXTMODS}
testbuild: extmods
	submake ${EXTMODS}
fresh: extmods
	domake ${EXTMODS} fresh
clean: extmods
	domake ${EXTMODS} clean
install: extmods
	domake ${EXTMODS} install

push:
	mapgit push

.PHONY: extmods build fresh clean install testbuild

# Making symlinks

symlinks: ${EXTMDOS}
	@cd ../../lib/kno;								\
	  for modname in ${EXTMODS}; do							\
	    if [ "${modname}" = "imagetools" ]; then 					\
	      for libname in qrcode exif imagick; do 					\
	        ln -sf ../../src/extmods/imagetools/$${modname}.${shared_suffix}	\
		       $${modname}.${shared_suffix}; 					\
	       done;									\
	    else 									\
	      ln -sf ../../src/extmods/$${modname}/$${modname}.${shared_suffix}		\
	  	     $${modname}.${shared_suffix};					\
	     fi;									\
	  done; 									\

.PHONY: symlinks

# Custom checkout/link rules

imagetools: imagetools/.git
imagetools/.git:
	git clone git@github.com:beingmeta/kno-$(@D).git $(@D)
	cd $(@D); git checkout ${BRANCH};
	if test -d ../../lib/kno; then \
	   cd  ../../lib/kno; \
	   for modname in qrcode exif imagick; do \
	     ln -sf ../../src/extmods/imagetools/$${modname}.${shared_suffix} $${modname}.${shared_suffix}; \
	   done; \
	 fi;
