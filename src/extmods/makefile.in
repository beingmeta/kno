EXTMODS=@EXTMODS@
shared_suffix=@shared_suffix@
BRANCH=trunk

%/.git:
	@git clone git@github.com:beingmeta/kno-$(@D).git $(@D)
	@cd $(@D); git checkout ${BRANCH};
	@if test -d ../../lib/kno; then \
	   cd  ../../lib/kno; \
	   ln -sf ../../src/extmods/$(@D)/$(@D).${shared_suffix} $(@D).${shared_suffix}; fi;

default: extmods

extmods: ${EXTMODS}
checkout update:
	for dir in ${EXTMODS}; do \
	  if test -f $${dir}.skip; then \
	    echo > /dev/null; \
	  elif test -d $${dir}/.git; then \
	    command cd $${dir}; \
	    git checkout trunk; \
	    git pull; \
	    command cd ..; \
	  else \
	    echo "Making local .git repo"; \
	    make "$${dir}/.git"; \
	  fi; \
	done

build: extmods
	domake ${EXTMODS}
testbuild: extmods
	submake ${EXTMODS}
fresh: extmods
	domake ${EXTMODS} fresh
clean: extmods
	domake ${EXTMODS} clean
install: extmods
	domake ${EXTMODS} install
alpine: extmods
	domake ${EXTMODS} alpine
debfresh: extmods
	domake ${EXTMODS} fresh
	domake ${EXTMODS} debfresh

STDMODS=hyphenate leveldb mongodb mysql nng odbc sundown tidy zeromq ziptools

symlinks:
	for dir in ${STDMODS}; do make ${dir}/.git; done;
	cd ../../lib/kno; 											\
	  for modname in ${STDMODS}; do 									\
	    ln -sf ../../src/extmods/$${modname}/$${modname}.${shared_suffix} $${modname}.${shared_suffix};	\
	  done; 												\
	  for modname in qrcode exif imagick; do 								\
	    ln -sf ../../src/extmods/imagetools/$${modname}.${shared_suffix} $${modname}.${shared_suffix}; 	\
	  done;

debclean:
	rm -f *.deb *.ddeb *.changes *.buildinfo

.PHONY: extmods build fresh clean install alpine debfresh testbuild

hyphenate leveldb mongodb mysql nng odbc sundown tidy zeromq ziptools rocksdb:
	make $@/.git

mod_knocgi mod_knocgi/.git:
	git clone git@github.com:beingmeta/mod_knocgi.git mod_knocgi

imagetools: imagetools/.git
imagetools/.git:
	git clone git@github.com:beingmeta/kno-$(@D).git $(@D)
	cd $(@D); git checkout ${BRANCH};
	if test -d ../../lib/kno; then \
	   cd  ../../lib/kno; \
	   for modname in qrcode exif imagick; do \
	     ln -sf ../../src/extmods/imagetools/$${modname}.${shared_suffix} $${modname}.${shared_suffix}; \
	   done; \
	 fi;
