#!/usr/bin/env fdexec
;;; -*- Mode: fdscript; -*-

(use-module 'gnosys)

(set-notify! #t)

(define (show% n d)
  (stringout (inexact->string (/ (* 100.0 n) d) 2) "%"))

(define (good-proper-name-key? key)
  (and (or (eq? (car key) gn/proper-names)
	   (eq? (car key) gn/compound-names))
       (< (length (cdr key)) 64)
       (< (count #\Space (cdr key)) 8)
       (char-upper-case? (elt (cdr key) 0))
       (or (find #\Space (cdr key))
	   (uppercase? (cdr key)))))

(define (doit in out)
  (let ((index (open-index in))
	(file (fopen out "a+b"))
	(i 0) (copy-count 0))
    (preload-file-index! index)
    (let ((keys (index-keys index)))
      (do-choices (key keys)
	(set! i (1+ i))
	(when (or (good-proper-name-key? key)
		  (eq? (car key) gn/noun-phrases))
	  (set! copy-count (1+ copy-count))
	  (write-dtype (cons key (index-get-size index key))
		       file)
	  (when (zero? (remainder copy-count 500))
	    (notify "Processed " copy-count
		    " (" (show% i (choice-size keys)) ")"
		    " keys: " (cdr key))))))))

(define (main . args)
  (if (= (length args) 2)
      (doit (car args) (cadr args))
    (begin (lineout "Usage: extract-terms <index file> <dtype file>")
	   (exit 1))))



