#!/bin/sh

usage (){
    echo "Usage: knomod debchangelog pkgname [distro] [status=stable] [version] < base_changelog";
}

if [ $# -lt 2 ]; then
    usage;
    exit;
fi
cmd=$1; shift;
case $cmd in
    debchangelog)
	PKGNAME=${1:-${PKG_NAME}};
	DISTRO=${2:-debian};
	STATUS=${3:-stable};
	VERSION=$4;
	if [ -z "${URGENCY}" ]; then URGENCY=medium; fi
	URGENCY=${5:-medium};
	DATE=`date -R`;
	if [ ! -z "${VERSION}" ]; then
	    version=${VERSION};
	elif which git 2>&1 > /dev/null && git describe 2>&1 > /dev/null; then
	    gitid=`git describe`;
	    version=`git describe | sed -e "s/-g[0123456789ABCDEFabcdef]*$//" | sed -e "s/^${PKGNAME}-//"`;
	elif [ ! -z "${USE_VERSION}" ]; then
	    version="${USE_VERSION}";
	elif [ -f etc/version ]; then
	    version=$(cat etc/version);
	elif [ -f etc/release ]; then
	    version=$(knoconfig major).$(knoconfig minor).$(cat etc/release);
	else
	    version=$(knoconfig version);
	fi;
	if [ -z "${STATUS}" ] || [ ${STATUS} = "stable" ]; then
	    echo ${PKGNAME} \(${version}\) ${DISTRO}\; urgency=${URGENCY}
	else
	    echo ${PKGNAME} \(${version}\) ${DISTRO}-${STATUS}\; urgency=${URGENCY}
	fi;
	echo
	echo "  * ${gitid} point release of ${PKGNAME} for ${DISTRO} (${STATUS})"
	echo
	echo " -- Repository Manager <repoman@beingmeta.com>  ${DATE}"
	echo
	cat -
	;;
    *)
	usage;
	exit;
esac
