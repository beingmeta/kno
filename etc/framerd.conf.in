# FramerD upstart config, replaces fdmanager
task

start on (net-device-up and
          local-filesystems and
	  runlevel [2345] and
          rc started)
stop on runlevel [!2345]

author "Ken Haase"
description "FramerD servlets and server daemons"
expect none
console log

pre-start script
   mkdir -p @rundir@/fdserv
   mkdir -p @logdir@/fdserv
   mkdir -p @rundir@/framerd
   mkdir -p @logdir@/framerd
   chown @webuser@ @rundir@/fdserv @logdir@/fdserv
   chown @fdaemon@ @rundir@/framerd @logdir@/framerd
   chgrp @admin_group@ @rundir@/fdserv @logdir@/fdserv
   chgrp @admin_group@ @rundir@/framerd @logdir@/framerd
   chmod g+rwx @rundir@/fdserv  @logdir@/fdserv
   chmod g+rwx @rundir@/framerd @logdir@/framerd

   for ctl in $(find @config_dir@/daemons/ -name "*.fdz" -mindepth 1 -maxdepth 1);
     do if (readlink ${ctl}>/dev/null);
        then start fdserver CTL=`readlink ${ctl}`;
        else start fdserver CTL=${ctl}; fi;
     done;
   for sock in $(find @config_dir@/servlets/ -name "*.sock" -mindepth 1 -maxdepth 1);
     do if (readlink ${sock}>/dev/null);
        then start fdservlet SOCKET=`basename ${sock}` CONFIG=`readlink ${sock}`;
        else start fdservlet SOCKET=`basename ${sock}` CONFIG=${sock}; fi;
     done;
   for sock in $(find @config_dir@/servlets/ -name "*@*" -mindepth 1 -maxdepth 1);
     do if (readlink ${sock}>/dev/null);
        then start fdservlet SOCKET=`basename ${sock}` CONFIG=`readlink ${sock}`;
        else start fdservlet SOCKET=`basename ${sock}` CONFIG=${sock}; fi;
     done;
   for sock in $(find @config_dir@/servlets/ -name "*:*" -mindepth 1 -maxdepth 1);
     do if (readlink ${sock}>/dev/null);
        then start fdservlet SOCKET=`basename ${sock}` CONFIG=`readlink ${sock}`;
        else start fdservlet SOCKET=`basename ${sock}` CONFIG=${sock}; fi;
     done;
end script

post-stop script
   for inst in `initctl list|grep "^fdserver "|awk '{print $2}'|tr -d ')'|tr -d '('`;
       do stop fdserver CTL=$inst || true; done
    for inst in `initctl list|grep "^fdservlet "|awk '{print $2}'|tr -d ')'|tr -d '('`;
       do stop fdservlet SOCKET=$inst || true; done
end script




