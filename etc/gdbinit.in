directory @abs_top_srcdir@:@abs_top_srcdir@/../libu8:@abs_top_srcdir@/../aikit/c:@extra_src@
set env UNDERGDB=yes
set env STDLOG=yes
set env FD_FOREGROUND=yes
set env FD_IGNORELEFTOVERS=yes
set env FD_STEALSOCKETS=yes
set env DUMA_ALIGNMENT=4
set env PPROF_PATH=/usr/bin/gpprof
set env MSAN_SYMBOLIZER_PATH=/usr/bin/llvm-symbolizer
set env TCMALLOC_DEBUG=3
#set env MALLOCSTATS=2
#set env HEAPPROFILE=/tmp/heap.profiles/heapprof
#set env HEAPCHECK=normal # strict|draconian
#set CPUPROFILE=/tmp/cpu-profile
set print elements 64
define vg
  target remote | vgdb
end
define vgx
  target remote | vgdb $arg0
end
define heapcheck
  set env HEAPPROFILE=/tmp/heap.profiles/heapprof
  set env HEAPCHECK=normal # strict|draconian
end
define dtype
  printf "%s\n",fd_dtype2string($arg0)
end
define showtypename
  printf "object type is 0x%x: %s\n",_fd_ptr_type($arg0),fd_type_names[_fd_ptr_type($arg0)]
end
define showtype
  print (((($arg0)&0x03)==2)?(fd_fixnum_type):((($arg0)&0x3)==3)?(fd_oid_type):((($arg0)&0x3)==0)?((enum FD_PTR_TYPE)(((((struct FD_CONS *)($arg0))->fd_conshead)&0x7F)+0x84)):((enum FD_PTR_TYPE)(((($arg0)>>25)&0x7f)+0x04)))
  printf "type is 0x%x: %s\n",_fd_ptr_type($arg0),fd_type_names[_fd_ptr_type($arg0)]
end
define dtypeout
  call _fd_dtype2stderr($arg0)
end
define dtout
  call _fd_dtype2stderr($arg0)
end
define dt
  call _fd_dtype2stderr($arg0)
end
define refcount
  if (($arg0)&3)
  print "not a cons" 
  else
  printf "object refcount=%d\n",((((struct FD_CONS *)$arg0)->fd_conshead)>>7)
  print ((struct FD_CONS *)($arg0))
  end
end
define watchcons
  watch ((struct FD_CONS *)($arg0))->fd_conshead
end
define xrefcount
  printf "cons refcount=%d\n",((((struct FD_CONS *)$arg0)->fd_conshead)>>7)
end
define showstruct 
  print *((struct $arg1 *)($arg0))
end
define showcons
  print ((struct FD_CONS *)($arg0))
end
define showfield
  print ((struct $arg1 *)($arg0))->$arg2
end
define showstring
  set print elements 0
  print ((struct FD_STRING *)($arg0))->fd_bytes
  set print elements 16
end
define showsymbol
  printf "%s\n",((struct FD_STRING *)(fd_symbol_names[((($arg0)>>2)&0x7FFFFF)]))->fd_bytes
end
define showoid
  print/x (fd_base_oids[(($arg0>>2)&0x3FF)]+($arg0>>12))
end
define showcar
  print/x (((struct FD_PAIR *)$arg0)->fd_car)
  showtype $
end
define showcdr
  print/x (((struct FD_PAIR *)$arg0)->fd_cdr)
  showtype $
end
define showvelt
   print/x ((((struct FD_VECTOR *)$arg0)->fd_vecelts)[$arg1])
   showtype $
end
define showcelt
  print/x ((&((struct FD_CHOICE *)$arg0)->choice_0)[$arg1])
  showtype $  
end
define celt
  printf "%s\n",fd_dtype2string(((&((struct FD_CHOICE *)$arg0)->choice_0)[$arg1]))
  print/x ((&((struct FD_CHOICE *)$arg0)->choice_0)[$arg1])
  showtype $
define oidinfo
  printf "oidinfo: %s\n", (_fd_oid_info($arg0))
end
define showchoice
  printf "data=%d\n",(&(((struct FD_CHOICE *)$arg0)->choice_0))
  printf "size=%d\n",((((struct FD_CHOICE *)$arg0)->choice_size)&(0x7FFFFFFF))
  print (*((struct FD_CHOICE *)$arg0))
end
define showvec
  printf "data=%d\n",(&(((struct FD_VECTOR *)$arg0)->fd_vecelts))
  printf "size=%d\n",(((struct FD_VECTOR *)$arg0)->fd_veclen)
  print (*((struct FD_VECTOR *)$arg0))
end
define showvelt
  printf "data=%d\n",(&(((struct FD_CHOICE *)$arg0)->fd_vecelts))
  printf "size=%d\n",((((struct FD_CHOICE *)$arg0)->fd_veclen)&(0x7FFFFFFF))
  print ((((struct FD_VECTOR *)$arg0)->fd_vecelts)[$arg1])
  showtype $
end
define velt
  printf "%s\n",fd_dtype2string(((((struct FD_VECTOR *)$arg0)->fd_vecelts)[$arg1]))
  print ((((struct FD_VECTOR *)$arg0)->fd_vecelts)[$arg1])
  showtype $
end
define showflo
  print (((struct FD_FLONUM *)($arg0))->fd_dblval)
end
define showschemap
  printf "schema=%d\n",(&(((struct FD_SCHEMAP *)$arg0)->fd_schema))
  printf "values=%d\n",(&(((struct FD_SCHEMAP *)$arg0)->schema_values))
  printf "size=%d\n",(((struct FD_SCHEMAP *)$arg0)->schema_length)
  print (*((struct FD_SCHEMAP *)$arg0))
end
define showschemapk
  print (((struct FD_SCHEMAP *)$arg0)->fd_schema)[$arg1]
  showtype $
end
define showschemapv
  print (((struct FD_SCHEMAP *)$arg0)->schema_values)[$arg1]
  showtype $
end
define showslotmap
  printf "keyvals=%d\n",(&(((struct FD_SLOTMAP *)$arg0)->sm_keyvals))
  printf "size=%d\n",((((struct FD_SLOTMAP *)$arg0)->table_size)&0x3FFFFFFF)
  print (*((struct FD_SLOTMAP *)$arg0))
end
define showslotmapk
  print ((((fd_slotmap)($arg0))->sm_keyvals)[($arg1)].kv_key)
  showtype $
end
define showslotmapv
  print ((((fd_slotmap)$arg0)->sm_keyvals)[($arg1)].kv_val)
  showtype $
end
define findelt
  print _fd_find_elt($arg0,$arg1,$arg2)
  showtype $
end
define inchoicep
  print _fd_find_elt($arg0,&(((struct FD_CHOICE *)$arg1)->choice_0),(((struct FD_CHOICE *)$arg1)->fd_choice_size))
  showtype $
end
define rawpos
  print u8_rawpos($arg0)
end

define fullstring
  call (void)puts($arg0)
end

set breakpoint pending on
#set disable-randomization off
set overload-resolution off

break u8_new_exception
break _fd_debug
break _u8_dbg
break u8_raise
break __msan_warning
break __msan_warning_noreturn
break __asan_report_error
#break abort
#break exit

# For LIBC
set env MALLOC_CHECK_=2
# For OS X
#set env MallocHelp=1 
set env MallocGuardEdges=1
set env MallocScribble=1
set env MallocBadFreeAbort=1
set env MallocCheckHeapAbort=1
set env MallocCorruptionAbort=1

define osx_check_heap
  set env MallocCheckHeapStart=0
  set env MallocCheckHeapEach=$arg0
  break malloc_error_break
end

define osx_trace_heap
  set env MallocStackLogging YES
end

# Init fdb print limits (init done through the config interface)
define set_fdmaxelts
  set env FD_DISPLAYMAXELTS=36
  set env FD_DISPLAYMAXCHARS=1024
end

define reset_fdmaxelts
  unset env FD_DISPLAYMAXELTS
  unset env FD_DISPLAYMAXCHARS
end

define trace_server
  set env FD_U8LOGLISTEN=yes
  set env FD_U8LOGCONNECT=yes
  set env FD_U8LOGTRANSACT=yes
  set env FD_LOGTRANSFER=yes
  set env FD_LOGLEVEL=8
end

define debug_tempsrv
  set args tempsrv.fdz
end

define trace_tempsrv
  set args tempsrv.fdz
  set env FD_U8LOGLISTEN=yes
  set env FD_U8LOGCONNECT=yes
  set env FD_U8LOGTRANSACT=yes
  set env FD_U8LOGTRANSFER=yes
  set env FD_LOGLEVEL=8
end

define useinstalledmodules
  unset environment FD_INIT_LOADPATH
  unset environment FD_INIT_DLOADPATH
  unset environment FD_INIT_SAFELOADPATH
end

define staticweb
    set args /var/run/fdserv/static.sock
end

define dotload
  unset environment FD_SKIP_DOTLOAD
end

define dontload
  set env FD_SKIP_DOTLOAD yes
end


define preload
  set env LD_PRELOAD=$1
end

define cast
  print (($2)($1))
end

define pcast
  print *(($2)($1))
end

define pfield
  print *(($1)->$2)
end

define sfield
  print *(($1).$2)
end

# Init some tracing configurations
set env FD_TRACEWEB=yes
set env FD_DLOAD:TRACE=yes
# This is for OS X > Sierra
set startup-with-shell off
