#!@prefix@/bin/sh

CLEAN=no
RAWSCRIPT=fdstartall
TARGET=all
MSG="echo `date +%T\(%a%d%b%Y\)`"
if test $# -eq 0; then
  OP=usage;
elif test $# -eq 1; then
  OP=$1;
  TARGET=all;
else
  TARGET=$1;
  OP=$2;
  shift;
  shift;
fi;
if test $OP = "usage"; then
  echo "Usage: fdctl (start|stop|clean|reload|freshstart|restart)";
  echo "Usage: fdctl [target] (restart|log|status|suspend)";
  exit;
elif test ${OP} = "stop"; then 
   RAWSCRIPT=fdstopall; 
fi;

cleanlogs( ) {
  rm -f @daemon_logdir@/*;
  rm -f @servlet_logdir@/*;
}


if test ${TARGET} != "all"; then
   if test ${OP} = "restart"; then
     exec fdrestart ${TARGET} $*;
   elif test ${OP} = "reload"; then
     exec fdreload ${TARGET} $*;
   elif test ${OP} = "log"; then
     exec fdlog ${TARGET} $*;
   elif test ${OP} = "status"; then
     exec fdstatus ${TARGET} $*;
   else ${MSG} "Unknown operation ${OP} on ${TARGET}";
   fi;
  exit;
elif test ${OP} = "cleanstart"; then
     if test -f @framerd_rundir@/_started; then
       fdctl stop;
       sudo rm -f @framerd_rundir@/_started;
     fi
     OP=start;
     sudo cleanlogs;
elif test ${OP} = "reload"; then
     exec fdreload;
     exit;
elif test ${OP} = "clean"; then
     sudo cleanlogs;
     exec fdreload;
elif test ${OP} = "zero"; then
     OP=stop;
     CLEAN=yes;
fi;

## Now, figure out what startup system is being used to run FramerD
##  e.g. systemd, upstart, sysv, or none (just fd* scripts)

if ! which systemctl 2>&1 > /dev/null; then
    ${MSG} "No systemctl";
elif test -f /lib/systemd/system/framerd.service; then
    ${MSG} "fdctl ${OP} >>> systemctl ${OP} framerd";
    sudo systemctl ${OP} framerd;
    exit;
elif test -f /usr/lib/systemd/system/framerd.service; then
    ${MSG} "fdctl ${OP} >>> systemctl ${OP} framerd";
    sudo systemctl ${OP} framerd;
    if test "${CLEAN}" = "yes"; then sudo cleanlogs; fi;
    exit;
else
    ${MSG} "No systemd FramerD configuration";
fi;

if ! which initctl 2>&1 > /dev/null; then
    ${MSG} "No initcl";
elif test -f /etc/init/framerd.conf; then
    ${MSG} "fdctl ${OP} >>> initctl ${OP} framerd";
    sudo initctl ${OP} framerd;
    if test "${CLEAN}" = "yes"; then
	sudo cleanlogs; 
    fi
    exit;
else
    ${MSG} No upstart FramerD configuration;
fi;

if test -f /etc/init.d/framerd; then
    ${MSG} "fdctl ${OP} >>> /etc/init.d/framerd ${OP}";
    sudo /etc/init.d/framerd ${OP};
else
    ${MSG} ${RAWSCRIPT};
    ${RAWSCRIPT};
fi;

if test "${CLEAN}" = "yes"; then 
    sudo cleanlogs; 
fi;
