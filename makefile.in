# -*- Mode: Makefile; -*-
# Copyright (C) 2004-2017 beingmeta, inc
# This file is a part of beingmeta's FramerD implementation

CC	= @CC@
XCFLAGS=
ARCHFLAGS = @archflags@
EXECFLAGS=@CFLAGS@ @PROFILING@ @DREENTRANT@ -I./include $(XCFLAGS) $(ARCHFLAGS)
DYNAMIC_CFLAG=@dynamic_cflag@
CFLAGS=-I./include @CFLAGS@ @PROFILING@ @DREENTRANT@ @PTHREAD_LIBS@ \
	$(DYNAMIC_CFLAG) \
       -I./include $(XCFLAGS)  $(ARCHFLAGS)
RPATH   = @rpath@
RPATHFLAGS = @RPATHFLAGS@
LDFLAGS = -L./ -L./lib @LDFLAGS@ @PTHREAD_LIBS@ $(XLDFLAGS)
DYLIB_FLAGS = -compatibility_version @FDMAJOR@.0.0 -current_version @FDMAJOR@.@FDMINOR@.@FDRELEASE@
EXELDFLAGS = @EXELDFLAGS@
XLIBS=
LIBS=$(XLIBS) @LIBS@
PATH=@BINPATH@

DESTDIR		=
prefix		= @prefix@
exec_prefix	= @exec_prefix@
datarootdir	= @datarootdir@
datadir		= @datadir@
INCINSTALLDIR	= $(DESTDIR)@prefix@/include/framerd
LIBINSTALLDIR	= $(DESTDIR)@libdir@
BININSTALLDIR	= $(DESTDIR)@exec_prefix@/bin
LOCALEDIR	= $(DESTDIR)@exec_prefix@/share/locale
DATADIR		= $(DESTDIR)@datadir@/framerd/data
CMODULES	= ${LIBINSTALLDIR}/framerd
APXS		= @APXS@ -S LIBEXECDIR=$(DESTDIR)@apache_modules_dir@
PPROF_PATH      = @GOOGLE_PPROF@
CLEAN		= @CLEAN@
ECHO		= @ECHO@
MSG		= @MSG@
SYSINSTALL	= @SUDO@@INSTALL@
SUDO	        = @SUDO@
INSTALL		= @INSTALL@
MKSTATIC	= @MKSTATIC@
CODENAME	= @CODENAME@
MKSO		= $(CC) -shared $(LDFLAGS) $(LIBS)
#MACLIBTOOL	= libtool -dynamic -single_module $(LDFLAGS) $(LIBS)
#MACOSX_DEPLOYMENT_TARGET=10.3
MACLIBTOOL	= $(CC) -dynamiclib -single_module \
			-undefined dynamic_lookup \
			$(LDFLAGS) $(LIBS)
BUILD		= `pwd`
BUILDMODE       := `cat buildmode || echo none`
DEBUG_FDSERV    = 0
RPMFLAGS	= @RPMFLAGS@
RPMDIR		= @RPMDIR@
GPG		= @GPG@
GPGID		= @GPGID@
RPMGPG		= %__gpg gpg --force-v3-sigs --digest-algo=sha1 -u \"%{_gpg_name}\" --no-armor --no-secmem-warning -sbo %{__signature_filename} %{__plaintext_filename}
APTREPO		= @APTREPO@
FDVERSION	= @FDVERSION@

DTYPE_HEADERS=\
 include/framerd/fdsource.h                          \
 include/framerd/config.h                            \
 include/framerd/common.h                            \
 include/framerd/defines.h                           \
 include/framerd/support.h                           \
 include/framerd/numbers.h                           \
 include/framerd/bigints.h                           \
 include/framerd/malloc.h                            \
 include/framerd/dtype.h    			     \
 include/framerd/ptr.h				     \
 include/framerd/cons.h        			     \
 include/framerd/choices.h			     \
 include/framerd/tables.h  			     \
 include/framerd/fdregex.h  			     \
 include/framerd/apply.h                             \
 include/framerd/dtypeio.h
DB_HEADERS=\
 include/framerd/dtypestream.h                       \
 include/framerd/fddb.h                              \
 include/framerd/pools.h                             \
 include/framerd/indices.h                           \
 include/framerd/dtproc.h                            \
 include/framerd/dtcall.h                            \
 include/framerd/frames.h                            \
 include/framerd/methods.h
DBFILE_HEADERS=include/framerd/dbfile.h
SCHEME_HEADERS=include/framerd/eval.h include/framerd/sequences.h
LIB_HEADERS   =include/framerd/texttools.h include/framerd/fdweb.h \
		include/framerd/mongodb.h

# Headers which don't live in include/framerd
SRC_HEADERS=src/dtype/biginternals.h src/scheme/eval_internals.h \
	src/exe/webcommon.h src/cmodules/fdsqlite.h 

REVISION_H=include/framerd/revision.h

DTYPE_OBJS=src/dtype/cons.o src/dtype/oids.o src/dtype/pptrs.o      \
	  src/dtype/symbols.o src/dtype/numbers.o src/dtype/apply.o \
          src/dtype/choices.o src/dtype/tables.o                    \
          src/dtype/dtypeio.o src/dtype/textio.o                    \
	  src/dtype/fdtype.o src/dtype/support.o
DB_OBJS=src/db/fddb.o src/db/dtypestream.o                                \
	src/db/indices.o src/db/netindices.o src/db/compoundindices.o     \
	src/db/pools.o src/db/netpools.o                                  \
	src/db/dtproc.o src/db/dtcall.o src/db/methods.o src/db/xtables.o \
	src/db/cachecall.o src/db/threadcache.o @ipevalo@ src/db/frames.o
DBFILE_OBJS=src/db/dbfile.o src/db/filepools.o src/db/zpools.o        \
	    src/db/hashdtype.o src/db/fileindices.o src/db/zindices.o \
	    src/db/hashindices.o src/db/oidpools.o
FDBSERV_OBJS=src/db/dbserv.o
CORE_SCHEME_OBJS=src/scheme/eval.o src/scheme/binders.o           \
                 src/scheme/threadprims.o src/scheme/quasiquote.o \
		 src/scheme/errors.o                              \
	         src/scheme/conditionals.o src/scheme/iterators.o
SCHEME_OBJS=$(CORE_SCHEME_OBJS) \
	    src/scheme/modules.o src/scheme/load.o src/scheme/history.o \
	    src/scheme/reflection.o src/scheme/compounds.o              \
	    src/scheme/coreprims.o src/scheme/dbprims.o                 \
	    src/scheme/tableprims.o src/scheme/choiceprims.o            \
	    src/scheme/seqprims.o src/scheme/stringprims.o              \
	    src/scheme/portprims.o src/scheme/timeprims.o               \
	    src/scheme/arithprims.o src/scheme/side-effects.o           \
	    src/scheme/regex.o src/scheme/reqstate.o src/scheme/extdb.o
SCHEMEIO_OBJS=src/scheme/fileprims.o src/scheme/dbfileprims.o src/scheme/loader.o
FDWEB_OBJS=src/fdweb/fdweb.o src/fdweb/xmloutput.o src/fdweb/xmlinput.o \
	src/fdweb/xmldata.o src/fdweb/mime.o src/fdweb/email.o          \
	src/fdweb/uriprims.o src/fdweb/xmleval.o src/fdweb/cgiexec.o    \
	src/fdweb/json.o @ldnso@ @curlo@
TEXTTOOLS_OBJS=src/texttools/texttools.o src/texttools/match.o \
	src/texttools/porter.o src/texttools/phonetic.o
SUNDOWN_OBJS= src/cmodules/sundown/autolink.o \
	src/cmodules/sundown/buffer.o \
	src/cmodules/sundown/houdini_href_e.o \
	src/cmodules/sundown/houdini_html_e.o \
	src/cmodules/sundown/html.o src/cmodules/sundown/html_smartypants.o \
	src/cmodules/sundown/markdown.o src/cmodules/sundown/stack.o \
	src/cmodules/sundown/sundown.o

SUNDOWN_OBJECTS=src/cmodules/sundown/autolink.o src/cmodules/sundown/buffer.o \
	src/cmodules/sundown/markdown.o src/cmodules/sundown/stack.o \
	src/cmodules/sundown/html.o src/cmodules/sundown/html_smartypants.o \
	src/cmodules/sundown/houdini_href_e.o src/cmodules/sundown/houdini_html_e.o
SUNDOWN_H_FILES=src/cmodules/sundown/autolink.h src/cmodules/sundown/buffer.h \
	src/cmodules/sundown/markdown.h src/cmodules/sundown/stack.h \
	src/cmodules/sundown/html_blocks.h src/cmodules/sundown/html.h \
	src/cmodules/sundown/houdini.h

TIDY_OBJECTS=\
	src/cmodules/tidy5/access.o 	\
	src/cmodules/tidy5/alloc.o 	\
	src/cmodules/tidy5/attrask.o 	\
	src/cmodules/tidy5/attrdict.o 	\
	src/cmodules/tidy5/attrget.o 	\
	src/cmodules/tidy5/attrs.o 	\
	src/cmodules/tidy5/buffio.o 	\
	src/cmodules/tidy5/charsets.o 	\
	src/cmodules/tidy5/clean.o 	\
	src/cmodules/tidy5/config.o 	\
	src/cmodules/tidy5/entities.o 	\
	src/cmodules/tidy5/fileio.o 	\
	src/cmodules/tidy5/gdoc.o 	\
	src/cmodules/tidy5/iconvtc.o 	\
	src/cmodules/tidy5/istack.o 	\
	src/cmodules/tidy5/language.o 	\
	src/cmodules/tidy5/lexer.o 	\
	src/cmodules/tidy5/mappedio.o 	\
	src/cmodules/tidy5/message.o 	\
	src/cmodules/tidy5/parser.o 	\
	src/cmodules/tidy5/pprint.o 	\
	src/cmodules/tidy5/sprtf.o 	\
	src/cmodules/tidy5/streamio.o 	\
	src/cmodules/tidy5/tagask.o 	\
	src/cmodules/tidy5/tags.o 	\
	src/cmodules/tidy5/tidylib.o 	\
	src/cmodules/tidy5/tmbstr.o 	\
	src/cmodules/tidy5/utf8.o 	\
	src/cmodules/tidy5/win32tc.o

TIDY_H_FILES=\
	src/cmodules/tidy5/access.h 	\
	src/cmodules/tidy5/attrdict.h 	\
	src/cmodules/tidy5/attrs.h 	\
	src/cmodules/tidy5/buffio.h 	\
	src/cmodules/tidy5/charsets.h 	\
	src/cmodules/tidy5/clean.h 	\
	src/cmodules/tidy5/config.h 	\
	src/cmodules/tidy5/entities.h 	\
	src/cmodules/tidy5/fileio.h 	\
	src/cmodules/tidy5/forward.h 	\
	src/cmodules/tidy5/gdoc.h 	\
	src/cmodules/tidy5/iconvtc.h 	\
	src/cmodules/tidy5/language_en_gb.h 	\
	src/cmodules/tidy5/language_en.h 	\
	src/cmodules/tidy5/language_es.h 	\
	src/cmodules/tidy5/language_es_mx.h 	\
	src/cmodules/tidy5/language_fr.h 	\
	src/cmodules/tidy5/language.h 	\
	src/cmodules/tidy5/language_zh_cn.h 	\
	src/cmodules/tidy5/lexer.h 	\
	src/cmodules/tidy5/mappedio.h 	\
	src/cmodules/tidy5/message.h 	\
	src/cmodules/tidy5/parser.h 	\
	src/cmodules/tidy5/platform.h 	\
	src/cmodules/tidy5/pprint.h 	\
	src/cmodules/tidy5/sprtf.h 	\
	src/cmodules/tidy5/streamio.h 	\
	src/cmodules/tidy5/tags.h 	\
	src/cmodules/tidy5/tidybuffio.h 	\
	src/cmodules/tidy5/tidyenum.h 	\
	src/cmodules/tidy5/tidy.h 	\
	src/cmodules/tidy5/tidy-int.h 	\
	src/cmodules/tidy5/tidyplatform.h 	\
	src/cmodules/tidy5/tmbstr.h 	\
	src/cmodules/tidy5/utf8.h 	\
	src/cmodules/tidy5/version.h 	\
	src/cmodules/tidy5/win32tc.h

CMODULE_OBJS=src/cmodules/odbc.o src/cmodules/sqlite.o \
	     src/modules/crypto.o src/cmodules/ldap.o \
	     src/cmodules/dbus.o src/cmodules/mysql.o \
	     src/cmodules/qrcode.o \
	     src/cmodules/ziptools.o \
	     src/cmodules/zlib.o src/cmodules/imagick.o \
	     src/cmodules/hyphenate.o \
	     ${SUNDOWN_OBJS} ${TIDY_OBJECTS}

EXECUTABLES=exe/fdexec@suffix@ exe/fdconsole@suffix@ exe/fdbatch@suffix@  \
	    exe/fdservlet@suffix@ exe/fdserver@suffix@
STATIC_EXECUTABLES=static/fdexec@suffix@ static/fdconsole@suffix@ \
	static/fdbatch@suffix@ \
	static/fdservlet@suffix@ static/fdserver@suffix@
SHELL_SCRIPTS=etc/fdsetconfig etc/fdgetconfig etc/fdconfig \
	etc/fdstart etc/fdstop etc/fdstartall etc/fdstopall \
	etc/fdsignal etc/fdinject etc/fdstatus etc/fdlog  \
	etc/fdrestart etc/fdctl \
	etc/fdcleanup
SCHEME_SCRIPTS=exe/scripts/pack-pool exe/scripts/pack-index \
               exe/scripts/make-hash-index \
               exe/scripts/make-oidpool \
	       exe/scripts/ovmerge \
	       exe/scripts/fdpkg

CONFDIRS=$(DESTDIR)@config_dir@ $(DESTDIR)@config_dir@/config $(DESTDIR)@share_dir@ \
	$(DESTDIR)@shared_module_dir@ 	$(DESTDIR)@shared_safe_module_dir@ \
	$(DESTDIR)@builtin_module_dir@ $(DESTDIR)@builtin_safe_module_dir@ \
	$(DESTDIR)@local_module_dir@ $(DESTDIR)@local_safe_module_dir@

FRAMERD_HEADERS= \
       $(DTYPE_HEADERS) $(DB_HEADERS) $(DBFILE_HEADERS) $(SCHEME_HEADERS)

FRAMERD_SOURCES=\
	src/dtype/cons.c src/dtype/oids.c src/dtype/symbols.c          \
        src/dtype/choices.c src/dtype/tables.c src/dtype/pptrs.c       \
        src/dtype/dtypeio.c src/dtype/textio.c                         \
	src/dtype/fdtype.c src/dtype/support.c src/dtype/apply.c       \
	src/db/fddb.c src/db/dtypestream.c  src/db/dbserv.c            \
	src/db/indices.c src/db/netindices.c src/db/compoundindices.c  \
	src/db/pools.c src/db/netpools.c src/db/xtables.c              \
	src/db/dtproc.c src/db/dtcall.c src/db/ipeval.c 	       \
	src/db/cachecall.c src/db/threadcache.c 			\
	src/db/frames.c src/db/methods.c          			\
	src/db/dbfile.c src/db/hashdtype.c                             \
	src/db/filepools.c src/db/zpools.c src/db/oidpools.c           \
	src/db/fileindices.c src/db/hashindices.c src/db/zindices.c    \
	src/scheme/eval.c src/scheme/binders.c src/scheme/errors.c     \
	src/scheme/conditionals.c src/scheme/iterators.c               \
        src/scheme/threadprims.c src/scheme/quasiquote.c               \
	src/scheme/modules.c src/scheme/load.c src/scheme/reflection.c \
	src/scheme/compounds.c src/scheme/coreprims.c                  \
	src/scheme/arithprims.c src/scheme/side-effects.c              \
	src/scheme/dbprims.c src/scheme/portprims.c                    \
	src/scheme/tableprims.c src/scheme/choiceprims.c               \
	src/scheme/seqprims.c src/scheme/stringprims.c                 \
	src/scheme/fileprims.c src/scheme/dbfileprims.c                \
	src/scheme/loader.c                                            \
	src/scheme/timeprims.c  src/scheme/extdb.c                     \
	src/scheme/reqstate.c                                          \
	src/fdweb/fdweb.c src/fdweb/json.c src/fdweb/ldns.c            \
	src/fdweb/xmloutput.c src/fdweb/xmlinput.c src/fdweb/xmldata.c \
	src/fdweb/xmleval.c src/fdweb/cgiexec.c src/fdweb/uriprims.c   \
	src/fdweb/mime.c src/fdweb/email.c src/fdweb/curl.c            \
	src/texttools/texttools.c src/texttools/match.c                \
	src/texttools/porter.c src/texttools/phonetic.c                \
	src/exe/fdconsole.c                                            \
	src/exe/fdexec.c src/exe/fdbatch.c                             \
	src/exe/fdservlet.c src/exe/fdcgiexec.c src/exe/fdserver.c

CMODULE_SOURCES=\
	src/cmodules/odbc.c src/cmodules/sqlite.c src/cmodules/ldap.c  \
	src/cmodules/crypto.c src/cmodules/dbus.c src/cmodules/mysql.c \
	src/cmodules/qrcode.c src/cmodules/ziptools.c                  \
	src/cmodules/tidy5/tidy.c src/cmodules/imagick.c               \
	src/cmodules/hyphenate.c src/cmodules/sundown/sundown.c

STATIC_LIBS=lib/libfdtype@suffix@.a lib/libfddb@suffix@.a      \
        lib/libfdbserv@suffix@.a lib/libfddbfile@suffix@.a     \
	lib/libfdscheme@suffix@.a lib/libfdschemeio@suffix@.a  \
	lib/libfdweb@suffix@.a lib/libtexttools@suffix@.a

SHARED_LIBS=lib/libfdtype@suffix@.@shared_suffix@  		\
	lib/libfddb@suffix@.@shared_suffix@        		\
        lib/libfddbfile@suffix@.@shared_suffix@    		\
	lib/libfdbserv@suffix@.@shared_suffix@     		\
	lib/libfdscheme@suffix@.@shared_suffix@    		\
	lib/libfdschemeio@suffix@.@shared_suffix@  		\
	lib/libfdweb@suffix@.@shared_suffix@       		\
	lib/libtexttools@suffix@.@shared_suffix@		\
	lib/libfdtype@suffix@.@mshared_suffix@  		\
	lib/libfddb@suffix@.@mshared_suffix@        		\
        lib/libfddbfile@suffix@.@mshared_suffix@    		\
	lib/libfdbserv@suffix@.@mshared_suffix@     		\
	lib/libfdscheme@suffix@.@mshared_suffix@    		\
	lib/libfdschemeio@suffix@.@mshared_suffix@  		\
	lib/libfdweb@suffix@.@mshared_suffix@       		\
	lib/libtexttools@suffix@.@mshared_suffix@

SCHEME_MODULES=src/modules/*.scm src/fdweb/xhtml/*.scm \
	src/modules/aws/*.scm src/modules/brico/*.scm \
	src/modules/facebook/*.scm src/modules/google/*.scm \
	src/modules/paypal/*.scm src/modules/twitter/*.scm \
	src/modules/dropbox/*.scm \
	src/modules/misc/*.scm src/modules/tests/*.scm \
	src/modules/safe/domutils/*.scm src/modules/safe/knodules/*.scm \
	src/modules/safe/textindex/*.scm src/modules/safe/jwt/*.scm \
	src/beingmeta/chopper/*.scm src/beingmeta/morph/*.scm \
	src/beingmeta/gnosys/*.scm

MODULE_SO=lib/libfdtype@suffix@.so lib/libfddb@suffix@.so \
	lib/libfddb@suffix@.so lib/libfdscheme@suffix@.so

ALL=testbin exe cmodules @TAGS@

# Targets

update: buildmode
	@+make `cat buildmode`
normal:
	@echo Building NORMAL configuration
	@+make testbin exe cmodules etc @TAGS@
debugging:
	@echo Building DEBUGGING configuration
	@+make XCFLAGS="@debugcflags@ $(XCFLAGS)"    \
	     XLDFLAGS="@debugldflags@ $(XLDFLAGS)" \
	     XLIBS="@debuglibs@ $(XLIBS)"          \
		testbin exe cmodules etc @TAGS@
optimizing:
	@echo Building OPTIMIZING configuration
	@+make XCFLAGS="-O3" testbin exe cmodules etc @TAGS@
nitpicking:
	@echo Building NITPICKING configuration
	@+make XCFLAGS="-Wall" testbin exe cmodules etc @TAGS@

all: testbin exe cmodules etc i18n @TAGS@

# Handy targets

debug:
	@if test $(BUILDMODE) != "debugging"; then echo debugging > buildmode; fi
	@make `cat buildmode`
standard:
	@if test $(BUILDMODE) != "normal"; then echo normal > buildmode; fi
	@make `cat buildmode`
nitpick:
	@if test $(BUILDMODE) != "nitpicking"; then echo nitpicking > buildmode; fi
	@make `cat buildmode`
fast:
	@if test $(BUILDMODE) != "optimizing"; then echo optimizing > buildmode; fi
	@make `cat buildmode`
buildmode:
	@echo normal > buildmode
showbuildmode showmode showbuild: buildmode
	@cat buildmode

# configure/autoconf stuff

makefile: makefile.in config.status
	if test -x ./config.status; then ./config.status; fi
./config.status: configure
	if test -x ./config.status; then ./config.status --recheck; fi
configure: configure.ac etc/release
	@if test -f .staticautoconf; then \
	    echo "WARNING: configure may be out of date"; \
	else echo "REBUILDING configure"; autoconf; fi
include/framerd/config.h: include/framerd/config.h.in
	if test -x ./config.status; then ./config.status; fi
	touch $@
include/framerd/fdsource.h: include/framerd/fdsource.h.in
	if test -x ./config.status; then ./config.status; fi
	touch $@

tests/dtype/makefile: tests/dtype/makefile.in ./configure
	./configure
tests/db/makefile: tests/db/makefile.in ./configure
	./configure
tests/scheme/makefile: tests/scheme/makefile.in ./configure
	./configure
tests/dtype/.gdbinit: tests/dtype/.gdbinit.in ./configure
	./configure
tests/db/.gdbinit: tests/db/.gdbinit.in ./configure
	./configure
tests/scheme/.gdbinit: tests/scheme/.gdbinit.in ./configure
	./configure
exe/.gdbinit: exe/.gdbinit.in ./configure
	./configure
etc/fdsignal: etc/fdsignal.in ./configure
	./configure
etc/fdgetconfig: etc/fdgetconfig.in ./configure
	./configure
etc/fdsetconfig: etc/fdsetconfig.in ./configure
	./configure
etc/fdconfig: etc/fdconfig.in ./configure
	./configure
etc/framerd-rc.d: etc/framerd-rc.d.in ./configure
	./configure
etc/OSXStartupItem/FramerD: etc/OSXStartupItem/FramerD.in ./configure
	./configure
etc/fdserv.conf: etc/fdserv.conf.in ./configure
	./configure
etc/fdserv.uniconf: etc/fdserv.uniconf.in ./configure
	./configure
etc/fdserv.load: etc/fdserv.load.in ./configure
	./configure
etc/logrotate: etc/logrotate.in ./configure
	./configure
etc/install-script: etc/install-script.in ./configure
	./configure

etc: etc/logrotate etc/install-script etc/framerd-rc.d \
	etc/fdsetconfig etc/fdgetconfig etc/fdconfig \
	tests/dtype/.gdbinit tests/db/.gdbinit tests/scheme/.gdbinit \
	exe/.gdbinit

# Fileinfo gets version-related information about a file to pass in
# with -D

@abs_top_srcdir@/fileinfo: etc/fileinfo.c
	$(CC) -o @abs_top_srcdir@/fileinfo etc/fileinfo.c

# Makes everything and then sudoes the install, keeping build files
# non-root

suinstall:
	make all
	@$(SUDO) make install
dbginstall:
	make XCFLAGS="-O0" all
	@$(SUDO) make install

# Make rules

%.o: %.c @abs_top_srcdir@/fileinfo include/framerd/revision.h \
		include/framerd/config.h
	@$(CC) $(CFLAGS) @definefileinfo@ -o $@ -c $<
	@$(MSG) CC $@ $<

exe/scripts/%: src/scripts/%.scm
	@$(ECHO) "#!"@prefix@/bin/fdexec | cat - $< > $@
	@chmod a+x $@
	@$(MSG) MAKESCRIPT $@ $<

exe/%@suffix@: src/exe/%.c
	$(CC) $(CFLAGS) $(LDFLAGS) $(EXELDFLAGS)                   \
		-o $@ $<                                           \
		-lfdbserv@suffix@                 	 	   \
		@xdynamic_scheme_libs@                             \
		-ltexttools@suffix@ -lfdscheme@suffix@ \
		-lfddbfile@suffix@ -lfddb@suffix@ -lfdtype@suffix@ \
	        -lu8stdio $(LIBS)
	@$(MSG) MKEXE $@ $<

src/cmodules/%.o: src/cmodules/%.c
	@$(CC) $(CFLAGS) -o $@ -c $<
	@$(MSG) CC  $@ $<
lib/framerd/%.so: src/cmodules/%.o ${MODULE_SO}
	@$(MKSO) -L./lib -L./ -o $@ $< @LIBS@ 
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO  $@ $<
lib/framerd/%.dylib: src/cmodules/%.o
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) -o $@ $<
	@$(MSG) MACLIBTOOL  $@ $<
lib/framerd/%.@FDMAJOR@.dylib: lib/framerd/%.dylib
	@ln -sf $(*F).dylib $@

# We can selectively link some executables statically to avoid 
# library dependencies with programs which will typicall run as daemons
static/%@suffix@: src/exe/%.c $(STATIC_LIBS)
	@$(CC) $(EXECFLAGS) -o $@ $^ -lu8stdio -lu8syslog $(LIBS)
	@$(MSG) MKEXE_STATIC $@

lib/%@suffix@.a:
	@$(MKSTATIC) $@ $^
	@$(MSG) MKSTATIC $@
lib/%@suffix@.so.@FDMAJOR@: lib/%@suffix@.so
	@ln -sf $(*F).so $@
lib/%@suffix@.so:
	@$(MKSO) -Wl,-soname=$(@F).@FDMAJOR@ -Wl,--as-needed -L./lib -L./ \
		-o $@ $^ -lu8 $(LIBS)
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@echo MKSO $@
lib/%@suffix@.@FDMAJOR@.dylib: lib/%@suffix@.dylib
	@ln -sf $(*F).dylib $@
lib/%@suffix@.dylib:
	@$(MACLIBTOOL) -install_name @rpath/lib/`basename $(@F) .dylib`.@FDMAJOR@.dylib $(DYLIB_FLAGS) -o $@ $^
	@ln -sf $(@F) $(@D)/`basename $(@F) .dylib`.@FDMAJOR@.dylib
	@$(MSG) MACLIBTOOL $@

$(LIBINSTALLDIR)/%.a: lib/%.a
	@$(SYSINSTALL) @install_dir_opts@ $(LIBINSTALLDIR)
	@$(SYSINSTALL) @install_file_opts@ $< $(LIBINSTALLDIR)
	@$(MSG) INSTALL $@

$(LIBINSTALLDIR)/%@suffix@.@vshared_suffix@: lib/%@suffix@.@shared_suffix@
	@echo Installing $@
	@$(SYSINSTALL) -d $(@D)
	@$(SYSINSTALL) $< $@
$(LIBINSTALLDIR)/%@suffix@.@mmshared_suffix@: $(LIBINSTALLDIR)/%@suffix@.@vshared_suffix@
	@$(SUDO) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@
$(LIBINSTALLDIR)/%@suffix@.@mshared_suffix@: $(LIBINSTALLDIR)/%@suffix@.@vshared_suffix@
	@$(SUDO) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@
$(LIBINSTALLDIR)/%@suffix@.@shared_suffix@: $(LIBINSTALLDIR)/%@suffix@.@vshared_suffix@
	@$(SUDO) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@

${CMODULES}/%@suffix@.@vshared_suffix@: lib/framerd/%@suffix@.@shared_suffix@
	@echo Installing $@
	@$(SYSINSTALL) -d $(@D)
	@$(SYSINSTALL) $< $@
${CMODULES}/%@suffix@.@mmshared_suffix@: ${CMODULES}/%@suffix@.@vshared_suffix@
	@$(SUDO) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@
${CMODULES}/%@suffix@.@mshared_suffix@: ${CMODULES}/%@suffix@.@vshared_suffix@ 
	@$(SUDO) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@
${CMODULES}/%@suffix@.@shared_suffix@: ${CMODULES}/%@suffix@.@vshared_suffix@ 
	@make ${CMODULES}/$(*F)@suffix@.@mmshared_suffix@ \
		${CMODULES}/$(*F)@suffix@.@mshared_suffix@
	@$(SUDO) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG) Linking $@ to $(*F).@vshared_suffix@

$(BININSTALLDIR)/%: exe/%

$(BININSTALLDIR)/%: src/scripts/%.scm
	@$(MSG) Installing script $@
	@etc/install-script $<

$(DESTDIR)@config_dir@/boot/%: etc/% $(DESTDIR)@config_dir@/boot
	@$(SYSINSTALL) @install_file_opts@ $< $(DESTDIR)@config_dir@/boot

dist/%.changelog: dist/equivs.changelog
	etc/make-equivs-changelog `basename $@ .changelog` dist/equivs.changelog > $@

src/cmodules/sundown/%.o: src/cmodules/sundown/%.c $(SUNDOWN_H_FILES)
	@$(CC) $(CFLAGS) -I./src/cmodules/sundown/ -o $@ -c $<
	@$(MSG) CC "(SUNDOWN)" $@

src/cmodules/tidy5/%.o: src/cmodules/tidy5/%.c $(SUNDOWN_H_FILES)
	@$(CC) $(CFLAGS) -I./src/cmodules/tidy5/ -o $@ -c $<
	@$(MSG) CC "(TIDY5)" $@

exe/fdexec@suffix@ exe/fdbatch@suffix@ exe/fdconsole@suffix@: \
	$(STATIC_LIBS) $(SHARED_LIBS)
exe/fdcgiexec@suffix@ exe/fdserver@suffix@ exe/fdservlet@suffix@: \
	$(STATIC_LIBS) $(SHARED_LIBS)
exe/fdcgiexec@suffix@ exe/fdservlet@suffix@: src/exe/webcommon.h

# Custom rules for making include files with CSS headers
src/fdweb/xmloutput.o: src/fdweb/backtrace_css.h src/fdweb/backtrace_js.h
src/fdweb/backtrace_css.h: src/fdweb/backtrace.css etc/text2include
	./etc/text2include FD_BACKTRACE_CSS $< $@
src/fdweb/backtrace_js.h: src/fdweb/backtrace.js etc/text2include
	./etc/text2include FD_BACKTRACE_JS $< $@

# This can be helpful for some debugging 
etc/usememory: etc/usememory.c

# Library targets

libs: static-libs @SHARED_LIB_TARGET@
static-libs: $(STATIC_LIBS)
shared-libs: $(SHARED_LIBS)
testbin: dtypetestbin dbtestbin schemetestbin etc/usememory
dtypetestbin: libs tests/dtype/makefile tests/dtype/.gdbinit
	@make -s XCFLAGS="$(XCFLAGS)" XLDFLAGS="$(XLDFLAGS)" XLIBS="$(XLIBS)" \
		-C tests/dtype
dbtestbin: libs tests/db/makefile tests/db/.gdbinit
	@make -s  XCFLAGS="$(XCFLAGS)" XLDFLAGS="$(XLDFLAGS)" XLIBS="$(XLIBS)" \
		-C tests/db
schemetestbin: libs tests/scheme/makefile tests/scheme/.gdbinit src/exe/main.h
	@make -s  XCFLAGS="$(XCFLAGS)" XLDFLAGS="$(XLDFLAGS)" XLIBS="$(XLIBS)" \
		-C tests/scheme testbin
exe: $(EXECUTABLES) exe/.gdbinit
static-exe: $(STATIC_EXECUTABLES)

cmodules: @CMODULES@

# Uninstall

LIBBASE=libfdtype libfddb libfddbfile libfdbserv \
	libfdscheme libfdschemeio libfdweb libtexttools

uninstall-core:
	./etc/uninstall $(DESTDIR)$(BININSTALLDIR) "" $(EXECUTABLES) fdcgiexec
	./etc/uninstall $(DESTDIR)$(BININSTALLDIR) "" $(SHELL_SCRIPTS)
	./etc/uninstall $(DESTDIR)$(BININSTALLDIR) "" $(SCHEME_SCRIPTS)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.a" $(LIBBASE)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.@FDVERSION@.@shared_suffix@" $(LIBBASE)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.@FDMAJOR@.@shared_suffix@" $(LIBBASE)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.@FDMAJOR@.@FDMINOR@.@shared_suffix@" $(LIBBASE)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.@shared_suffix@" $(LIBBASE)
	rm -rf $(DESTDIR)${CMODULES}
uninstall-all: uninstall-core
	rm -rf $(DESTDIR)@share_dir@ $(DESTDIR)@config_dir@ \
		$(DESTDIR)@local_config@ $(DESTDIR)@shared_config@ \
		$(DESTDIR)@builtin_module_dir@ \
		$(DESTDIR)@builtin_safe_module_dir@
uninstall: uninstall-core
	@if (test -d $(DESTDIR)@share_dir@); then \
	  $(MSG) $(DESTDIR)@share_dir@ "still exists"; fi
	@if (test -d $(DESTDIR)@config_dir@); then \
	  $(MSG) $(DESTDIR)@config_dir@ "still exists"; fi
	@if (test -d $(DESTDIR)@local_config@); then \
	  $(MSG) $(DESTDIR)@local_config@ "still exists"; fi
	@if (test -d $(DESTDIR)@shared_config@); then \
	  $(MSG) $(DESTDIR)@shared_config@ "still exists"; fi
	@if (test -d $(DESTDIR)@module_dir@); then \
	  $(MSG) $(DESTDIR)@module_dir@ "still exists"; fi
	@if (test -d $(DESTDIR)@safe_module_dir@); then \
	  $(MSG) $(DESTDIR)@safe_module_dir@ "still exists"; fi

# Utility targets

TAGS: makefile.in configure.ac include/framerd/config.h.in                \
		tests/dtype/*.c tests/db/*.c tests/scheme/*.c src/exe/*.c \
		src/dtype/*.c src/db/*.c src/scheme/*.c src/fdweb/*.c     \
		src/texttools/*.c src/cmodules/*.c         \
		src/cmodules/sundown/sundown.c include/framerd/*.h        \
		etc/*.in ${SRC_HEADERS} ${SCHEME_MODULES} tests/scheme/*.scm 
	@echo Building TAGS file
	@etags makefile.in configure.ac include/framerd/config.h.in      \
	      tests/dtype/*.c tests/db/*.c tests/scheme/*.c src/exe/*.c \
	      src/dtype/*.c src/db/*.c src/scheme/*.c src/fdweb/*.c     \
	      src/texttools/*.c src/cmodules/*.c         \
	      src/cmodules/sundown/sundown.c include/framerd/*.h        \
	      etc/*.in ${SRC_HEADERS} tests/scheme/*.scm 
	@# We skip module.scm files because they are always links
	@#  to other files (with more distinctive names).
	@find src/modules src/modules/safe src/fdweb/xhtml -name "*.scm" | \
		grep -v module.scm | \
		xargs etags -o TAGS -a

CTAGS: makefile.in configure.ac include/framerd/config.h.in                \
		tests/dtype/*.c tests/db/*.c tests/scheme/*.c src/exe/*.c \
		src/dtype/*.c src/db/*.c src/scheme/*.c src/fdweb/*.c     \
		src/texttools/*.c src/cmodules/*.c         \
		src/cmodules/sundown/sundown.c include/framerd/*.h        \
		etc/*.in ${SRC_HEADERS}
	@echo Building C TAGS file
	@etags -o CTAGS makefile.in configure.ac include/framerd/config.h.in      \
	      tests/dtype/*.c tests/db/*.c tests/scheme/*.c src/exe/*.c \
	      src/dtype/*.c src/db/*.c src/scheme/*.c src/fdweb/*.c     \
	      src/texttools/*.c src/cmodules/*.c         \
	      src/cmodules/sundown/sundown.c include/framerd/*.h        \
	      etc/*.in ${SRC_HEADERS}

SCHEMETAGS: ${SCHEME_MODULES}
	@echo Building SCHEMETAGS file
	@rm -f SCHEMETAGS
	@# We skip module.scm files because they are always links
	@#  to other files (with more distinctive names)
	@find src/modules src/fdweb/xhtml -name "*.scm" | \
		grep -v module.scm | \
		xargs etags -o SCHEMETAGS -a
	@ls -l SCHEMETAGS

profile-clean:
	find . -name "*.gcda" | xargs rm -f
	find . -name "*.gcno" | xargs rm -f
	find . -name "*.gcov" | xargs rm -f
	find . -name "*.bb" | xargs rm -f
	find . -name "*.bbg" | xargs rm -f
	find . -name "*.da" | xargs rm -f
	find . -name "gmon.out" | xargs rm -f
tidy: profile-clean
	rm -f src/dtype/*~ src/db/*~ src/scheme/*~ src/fdweb/*~
	rm -f include/framerd/*~
	rm -f tests/dtype/*~ tests/db/*.o tests/scheme/*.o
	rm -f config.log
clean: tidy
	rm -f buildmode
	rm -f src/dtype/*.o src/db/*.o src/scheme/*.o src/fdweb/*.o 
	rm -f src/cmodules/*.o src/texttools/*.o exe/*.o
	rm -f src/cmodules/sundown/*.o
	rm -rf etc/*.o etc/.libs
	rm -f lib/*.a lib/*@suffix@.so lib/*.dylib
	rm -f lib/*@suffix@.so.*
	rm -f lib/framerd/*@suffix@.so lib/framerd/*@suffix@.so.* 
	rm -f lib/framerd/*.dylib
	rm -f exe/fdexec@suffix@ exe/fdbatch@suffix@
	rm -f exe/fdservlet@suffix@ exe/fdserver@suffix@
	rm -f exe/fdconsole@suffix@ exe/fdcgiexec@suffix@
	rm -f TAGS
	cd tests/dtype; make clean
	cd tests/db; make clean
	cd tests/scheme; make clean
	find . -name "*.dSYM" | xargs rm -rf
distclean: clean
	rm -f makefile config.log config.status config.cache
	rm -f tests/dtype/makefile tests/db/makefile tests/scheme/makefile
	rm -f tests/dtype/.gdbinit tests/db/.gdbinit tests/scheme/.gdbinit
	rm -f etc/fdgetconfig etc/fdsetconfig etc/framerd-rc.d
	rm -f exe/.gdbinit include/framerd/config.h include/framerd/revision.h

commit:
	git commit
	touch makefile
pull:
	git pull
	touch makefile

# Custom dependencies

src/scheme/eval.o: src/scheme/eval.c src/scheme/opcodes.c \
	src/scheme/eval_internals.h \
	$(DTYPE_HEADERS) $(DB_HEADERS) $(SCHEME_HEADERS)
src/scheme/binders.o src/scheme/conditionals.o src/scheme/iterators.o: \
	src/scheme/eval_internals.h

src/dtype/dtypeio.o src/dtype/apply.o : XCFLAGS="-O3"
src/db/dtypestream.o : XCFLAGS="-O3"
src/scheme/eval.o src/scheme/binders.o : XCFLAGS="-O3"
src/scheme/conditionals.o src/scheme/iterators.o : XCFLAGS="-O3"
src/scheme/opcodes.o : XCFLAGS="-O3"

# Library targets

lib/libfdtype@suffix@.a: $(DTYPE_OBJS)
lib/libfdtype@suffix@.so: $(DTYPE_OBJS)
lib/libfdtype@suffix@.dylib: $(DTYPE_OBJS)

lib/libfddb@suffix@.a: $(DB_OBJS)
lib/libfddb@suffix@.so: $(DB_OBJS) lib/libfdtype@suffix@.so
lib/libfddb@suffix@.dylib: $(DB_OBJS) lib/libfdtype@suffix@.dylib

lib/libfddbfile@suffix@.a: $(DBFILE_OBJS)
lib/libfddbfile@suffix@.so: $(DBFILE_OBJS) \
	lib/libfdtype@suffix@.so lib/libfddb@suffix@.so
lib/libfddbfile@suffix@.dylib: $(DBFILE_OBJS) \
	lib/libfddb@suffix@.dylib lib/libfdtype@suffix@.dylib

lib/libfdbserv@suffix@.a: $(FDBSERV_OBJS)
lib/libfdbserv@suffix@.so: $(FDBSERV_OBJS) \
	lib/libfdtype@suffix@.so lib/libfddb@suffix@.so \
	lib/libfddb@suffix@.so
lib/libfdbserv@suffix@.dylib: $(FDBSERV_OBJS) \
	lib/libfdscheme@suffix@.dylib         \
	lib/libfddbfile@suffix@.dylib         \
	lib/libfddb@suffix@.dylib             \
	lib/libfdtype@suffix@.dylib
	@$(MACLIBTOOL) -install_name @rpath/lib/`basename $(@F) .dylib`.@FDMAJOR@.dylib $(DYLIB_FLAGS) -o $@ $^
	@$(MSG) MACLIBTOOL $@

lib/libfdscheme@suffix@.a: $(SCHEME_OBJS)
lib/libfdscheme@suffix@.so: $(SCHEME_OBJS) \
	lib/libfdtype@suffix@.so lib/libfddb@suffix@.so \
	lib/libfddb@suffix@.so
lib/libfdscheme@suffix@.dylib: $(SCHEME_OBJS) \
	lib/libfddb@suffix@.dylib             \
        lib/libfdtype@suffix@.dylib

lib/libfdschemeio@suffix@.a: $(SCHEMEIO_OBJS)
lib/libfdschemeio@suffix@.so: $(SCHEMEIO_OBJS) \
	lib/libfdtype@suffix@.so lib/libfddb@suffix@.so \
	lib/libfddb@suffix@.so lib/libfddbfile@suffix@.so \
	lib/libfdscheme@suffix@.so
lib/libfdschemeio@suffix@.dylib: $(SCHEMEIO_OBJS) \
	lib/libfdscheme@suffix@.dylib             \
	lib/libfddbfile@suffix@.dylib             \
	lib/libfddb@suffix@.dylib                 \
	lib/libfdtype@suffix@.dylib 

lib/libfdweb@suffix@.a: $(FDWEB_OBJS)
lib/libfdweb@suffix@.so: $(FDWEB_OBJS) \
	lib/libfdtype@suffix@.so lib/libfddb@suffix@.so \
	lib/libfddb@suffix@.so lib/libfdscheme@suffix@.so \
	lib/libfdschemeio@suffix@.so
lib/libfdweb@suffix@.dylib: $(FDWEB_OBJS) \
	lib/libfdscheme@suffix@.dylib     \
	lib/libfddbfile@suffix@.dylib     \
	lib/libfddb@suffix@.dylib         \
        lib/libfdtype@suffix@.dylib
	@$(MACLIBTOOL) -install_name \
		@rpath/lib/`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ $(FDWEB_OBJS)
	@$(MSG) MACLIBTOOL $@

lib/libtexttools@suffix@.a: $(TEXTTOOLS_OBJS)
lib/libtexttools@suffix@.so: $(TEXTTOOLS_OBJS) \
	lib/libfdtype@suffix@.so lib/libfddb@suffix@.so \
	lib/libfddb@suffix@.so lib/libfdscheme@suffix@.so \
	lib/libfdschemeio@suffix@.so
lib/libtexttools@suffix@.dylib: $(TEXTTOOLS_OBJS) \
	lib/libfdscheme@suffix@.dylib \
	lib/libfddbfile@suffix@.dylib \
	lib/libfddb@suffix@.dylib \
	lib/libfdtype@suffix@.dylib
	@$(MACLIBTOOL) -install_name \
		@rpath/lib/`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ $(TEXTTOOLS_OBJS)
	@$(MSG) MACLIBTOOL $@


src/cmodules/mysql.o: src/cmodules/mysql.c
	@$(CC) @MYSQL_CFLAGS@ $(CFLAGS)  -o $@ -c $<
	@$(MSG) CC "(MYSQL)" $@
lib/framerd/mysql.so: src/cmodules/mysql.o ${MODULE_SO}
	@$(MKSO) -L./ -L./lib \
		-o $@ $< ${MODULE_SO} @MYSQL_LDFLAGS@ @LIBS@
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO "(MYSQL)" $@
lib/framerd/mysql.dylib: src/cmodules/mysql.o
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ src/cmodules/mysql.o @MYSQL_LDFLAGS@
	@$(MSG) MACLIBTOOL "(MYSQL)" $@

src/cmodules/mongodb.o: src/cmodules/mongodb.c
	@$(CC) @MONGODB_CFLAGS@ $(CFLAGS)  -o $@ -c $<
	@$(MSG) CC "(MONGODB)" $@
lib/framerd/mongodb.so: src/cmodules/mongodb.o ${MODULE_SO}
	@$(MKSO) -L./ -L./lib \
		-o $@ $< ${MODULE_SO} @MONGODB_LDFLAGS@ @LIBS@
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO "(MONGODB)" $@
lib/framerd/mongodb.dylib: src/cmodules/mongodb.o
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ src/cmodules/mongodb.o @MONGODB_LDFLAGS@
	@$(MSG) MACLIBTOOL "(MONGODB)" $@

src/cmodules/imagick.o: src/cmodules/imagick.c
	@$(CC) @IMAGICK_CFLAGS@ $(CFLAGS)  -o $@ -c $<
	@$(MSG) CC "(IMAGICK)" $@
lib/framerd/imagick.so: src/cmodules/imagick.o ${MODULE_SO}
	$(MKSO) -L./ -L./lib \
		-o $@ $< ${MODULE_SO} @IMAGICK_LDFLAGS@ @LIBS@
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO "(IMAGICK)" $@
lib/framerd/imagick.dylib: src/cmodules/imagick.o
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ src/cmodules/imagick.o @IMAGICK_LDFLAGS@
	@$(MSG) MACLIBTOOL "(IMAGICK)" $@

src/cmodules/ziptools.o: src/cmodules/ziptools.c
	@$(CC) $(CFLAGS) @LIBZIP_CFLAGS@ -o $@ -c $<
	@$(MSG) CC "(ZIPTOOLS)"  $@ $<
lib/framerd/ziptools.so: src/cmodules/ziptools.o ${MODULE_SO}
	@$(MKSO) -L./ -L./lib \
		-o $@ $< ${MODULE_SO} @LIBZIP_LDFLAGS@ @LIBS@
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO "(ZIPTOOLS)"  $@ $<
lib/framerd/ziptools.dylib: src/cmodules/ziptools.o
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ $<
	@$(MSG) MACLIBTOOL "(ZIPTOOLS)" $@

lib/framerd/exif.so: src/cmodules/exif.o ${MODULE_SO}
	@$(MKSO) -L./ -L./lib -o $@ $^ ${MODULE_SO} $(LIBS) -lexif
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO $@
lib/framerd/exif.dylib: src/cmodules/exif.o
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-lexif -o $@ $^
	@$(MSG) MACLIBTOOL $@

src/cmodules/crypto.o: src/cmodules/crypto.c
lib/framerd/crypto.so: src/cmodules/crypto.o ${MODULE_SO}
lib/framerd/crypto.dylib: src/cmodules/crypto.o

lib/framerd/odbc.so: src/cmodules/odbc.o ${MODULE_SO}
lib/framerd/odbc.dylib: src/cmodules/odbc.o

lib/framerd/sqlite.so: src/cmodules/sqlite.o ${MODULE_SO}
lib/framerd/sqlite.dylib: src/cmodules/sqlite.o

lib/framerd/qrcode.so: src/cmodules/qrcode.o ${MODULE_SO}
lib/framerd/qrcode.dylib: src/cmodules/qrcode.o

lib/framerd/zlib.so: src/cmodules/zlib.o ${MODULE_SO}
lib/framerd/zlib.dylib: src/cmodules/zlib.o

lib/framerd/sundown.so: src/cmodules/sundown/sundown.c \
		$(SUNDOWN_OBJECTS) $(MODULE_SO)
	@$(MKSO) $(CFLAGS) -o $@ src/cmodules/sundown/sundown.c \
		$(SUNDOWN_OBJECTS) $(MODULE_SO)
	@$(MSG) MKSO  $@ $<
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
lib/framerd/sundown.dylib: src/cmodules/sundown/sundown.c $(SUNDOWN_OBJECTS)
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		${CFLAGS} -o $@ $(DYLIB_FLAGS) \
		src/cmodules/sundown/sundown.c $(SUNDOWN_OBJECTS)
	@$(MSG) MACLIBTOOL  $@ $<

lib/framerd/tidy.so: src/cmodules/tidy5/tidy.c \
			$(TIDY_OBJECTS) $(MODULE_SO)
	@$(MKSO) $(CFLAGS) -o $@ src/cmodules/tidy5/tidy.c \
		$(TIDY_OBJECTS) $(MODULE_SO)
	@$(MSG) MKSO  $@ $<
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
lib/framerd/tidy.dylib: src/cmodules/tidy5/tidy.c $(TIDY_OBJECTS)
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		${CFLAGS} -o $@ $(DYLIB_FLAGS) \
		src/cmodules/tidy5/tidy.c $(TIDY_OBJECTS)
	@$(MSG) MACLIBTOOL  $@ $<

# Internationalization stuff

$(LOCALEDIR)/%/LC_MESSAGES/framerd.mo: etc/intl/%.gmo
	@$(SUDO) install -D $^ $@

etc/intl/framerd.pot:
	@XGETTEXT@ --from-code=utf-8 -dfdb -oetc/intl/framerd.pot -k_ \
		$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
etc/intl/%.po: etc/intl/framerd.pot
	@MSGMERGE@ -U $@ $<
etc/intl/%.gmo: etc/intl/%.po
	@MSGFMT@ $^ -o $@ 

install-i18n: $(LOCALEDIR)/fr/LC_MESSAGES/framerd.mo   \
		$(LOCALEDIR)/es/LC_MESSAGES/framerd.mo \
		$(LOCALEDIR)/nl/LC_MESSAGES/framerd.mo
i18n: etc/intl/fr.gmo etc/intl/nl.gmo etc/intl/es.gmo

# Packaging targets

rpms: dist/rpms.done
debian deb debs: dist/debs.done

cleandist cleanrpms cleandeb rpmclean debclean: 
	rm -rf dist/rpms.done dist/rpms.ready
	rm -f dist/debs.signed dist/debs.built dist/debs.done
	rm -f dist/*.deb dist/*.tar dist/*.gz dist/*.dsc dist/*.changes
	find dist -name "*.rpm" | xargs -r rm
	rm -rf staging/framerd*

debfresh freshdeb:
	make debclean
	make debian

# Creating staging areas from GIT

staging/framerd-@FDVERSION@: \
	$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
	@git archive --prefix=framerd-@FDVERSION@/ \
	            -o staging/framerd-@FDVERSION@.tar HEAD
	cd staging; tar -xf framerd-@FDVERSION@.tar; rm framerd-@FDVERSION@.tar
	$(ECHO) "#define FRAMERD_REVISION \""`git describe`"\"" \
		> staging/framerd-@FDVERSION@/etc/revision.h;
staging/framerd_@FDVERSION@: \
	$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
	@git archive --prefix=framerd_@FDVERSION@/ \
	            -o staging/framerd_@FDVERSION@.tar HEAD;
	cd src/modules; git archive --prefix=framerd_@FDVERSION@/src/modules/ \
	            -o ../../staging/framerd_modules_@FDVERSION@.tar HEAD;
	cd staging; tar -xf framerd_@FDVERSION@.tar; rm framerd_@FDVERSION@.tar;
	cd staging; tar -xf framerd_modules_@FDVERSION@.tar; rm framerd_modules_@FDVERSION@.tar;
	$(ECHO) "#define FRAMERD_REVISION \""`git describe`"\"" \
		> staging/framerd_@FDVERSION@/etc/revision.h;
	cd staging; tar -czvf framerd_@FDVERSION@.orig.tar.gz \
		framerd_@FDVERSION@;
	mv staging/framerd_@FDVERSION@/dist/debian \
	   staging/framerd_@FDVERSION@/debian;
	etc/gitchangelog framerd ${CODENAME} < dist/debian/changelog \
	   > staging/framerd_@FDVERSION@/debian/changelog;
staging/framerd-@FDVERSION@.tar.gz: \
	$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
	make staging/framerd-@FDVERSION@
	tar -czvf $@ -C staging framerd-@FDVERSION@
staging/framerd_@FDVERSION@.orig.tar.gz: \
	$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
	make staging/framerd_@FDVERSION@
	tar -czvf $@ -C staging framerd_@FDVERSION@

# RPM rules

dist/rpms.ready: staging/framerd-@FDVERSION@ \
	staging/framerd_@FDVERSION@.orig.tar.gz \
	staging/framerd-@FDVERSION@.tar.gz
	@buildrpm@ $(RPMFLAGS)  			\
	   --define="_rpmdir $(RPMDIR)"			\
	   --define="_srcrpmdir $(RPMDIR)" 		\
	   --nodeps -ta 				\
	    staging/framerd-@FDVERSION@.tar.gz && 	\
	touch dist/rpms.ready
dist/rpms.done: dist/rpms.ready
	@if (test "x$(GPGID)" = "xnone"); then 			\
	    touch dist/rpms.done;				\
	elif (test "x$(GPGID)" = "x"); then 			\
	   echo "Enter passphrase for the RPM signing key:"; 	\
	   @rpm@ --addsign 					\
		--define="__gpg_sign_cmd $(RPMGPG)"		\
		$(RPMDIR)/framerd-@FDVERSION@-*.src.rpm 	\
		$(RPMDIR)/*/framerd*-@FDVERSION@-*.rpm; 	\
	   else 						\
	     echo "Enter passphrase for '$(GPGID)':"; 		\
	     @rpm@ --addsign --define="_gpg_name $(GPGID)" 	\
		--define="__gpg_sign_cmd $(RPMGPG)"		\
		$(RPMDIR)/framerd-@FDVERSION@*.src.rpm 		\
		$(RPMDIR)/*/framerd*-@FDVERSION@-*.rpm; fi && 	\
	@CREATEREPO@ -p -d $(RPMDIR) && 			\
	touch dist/rpms.done;
	@ls -l $(RPMDIR)/framerd-@FDVERSION@-*.src.rpm \
		$(RPMDIR)/*/framerd*-@FDVERSION@-*.rpm;

rpmupdate update-rpms freshrpms: cleanrpms
	rm -f dist/rpms.done dist/rpms.ready
	make dist/rpms.done
dist/rpms.zip: dist/rpms.done
	@rm -f dist/rpms.zip
	@zip dist/rpms.zip \
		$(RPMDIR)/framerd*-@FDVERSION@-*.src.rpm \
		$(RPMDIR)/*/framerd-*-@FDVERSION@-*.rpm

# Rules for Debian building

DEBINSTALL=framerd framerd-core framerd-builtin		\
	framerd-mysql framerd-sqlite framerd-mongodb 	\
	framerd-imagetools framerd-sundown 		\
	framerd-full framerd-dev elpa-fdconsole 

dist/debs.built: staging/framerd_@FDVERSION@
	(cd staging/framerd_@FDVERSION@; \
	 dpkg-buildpackage -sa -us -uc -b -rfakeroot) && \
	touch dist/debs.built;
dist/debs.signed: dist/debs.built
	(cd staging; debsign -p${GPG} --re-sign -k${GPGID} 	\
		framerd_@FDVERSION@*.changes) && 		\
	(cd staging; cp framerd_@FDVERSION@*.tar.?z ../dist) && \
	(cd staging; mv framerd*_@FDVERSION@*.*               	\
			libapache2-mod-fdserv_@FDVERSION@*.deb  \
			elpa-fdconsole_@FDVERSION@*.deb  \
			../dist) &&                             \
	touch dist/debs.signed;

dist/debs.done: dist/debs.signed
	touch dist/debs.done

install-debian install-debs debinstall installdebs: dist/debs.done
	for pkg in ${DEBINSTALL}; do 				\
	  if test -f dist/$${pkg}_@FDVERSION@*.deb; then 	\
	    @SUDO@ dpkg -i dist/$${pkg}_@FDVERSION@*.deb;	\
	  fi;							\
	done;

update-local-apt-repo: dist/debs.done
	for change in dist/*.changes; do \
	  reprepro -Vb ${APTREPO} include ${CODENAME} $${change} && \
	  rm -f $${change}; \
	done

update-remote-apt-repo: dist/debs.done
	cd dist; for change in *.changes; do \
	  dupload -c --nomail --to ${CODENAME} $${change} && \
	  rm -f $${change}; \
	done

update-apt update-apt-repo: dist/debs.done
	if test -d ${APTREPO}; then	\
	  make update-local-apt-repo;	\
	else				\
	  make update-remote-apt-repo;	\
	fi;

apt-upload upload-apt upload-deb: update-remote-apt-repo

.PHONY: apt-upload upload-apt upload-deb
.PHONY: update-apt-repo update-remote-apt-repo update-local-apt-repo

# Installation targets

install: install-core install-cmodules install-modules @setup_target@
install-core: confdirs workdirs @INSTALLI18N@           \
	 install-static install-shared install-headers  \
         install-exe install-scripts install-data 	\
	 install-support

$(INCINSTALLDIR):
	@$(SYSINSTALL) @install_dir_opts@ $(INCINSTALLDIR)
$(BININSTALLDIR):
	@$(SYSINSTALL) @install_dir_opts@ $(BININSTALLDIR)
$(LIBINSTALLDIR):
	@$(SYSINSTALL) @install_dir_opts@ $(LIBINSTALLDIR)
${CMODULES}:
	@$(SYSINSTALL) @install_dir_opts@ ${CMODULES}
$(DESTDIR)@config_dir@ $(DESTDIR)@share_dir@ $(DATADIR):
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@
$(DESTDIR)@local_config@ $(DESTDIR)@shared_config@:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@
$(DESTDIR)@config_dir@/daemons $(DESTDIR)@config_dir@/servlets: $(DESTDIR)@config_dir@
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@

install-static: static-libs $(LIBINSTALLDIR)
	make $(LIBINSTALLDIR)/libfdtype@suffix@.a        \
		$(LIBINSTALLDIR)/libfddb@suffix@.a       \
		$(LIBINSTALLDIR)/libfddbfile@suffix@.a   \
		$(LIBINSTALLDIR)/libfdbserv@suffix@.a    \
		$(LIBINSTALLDIR)/libfdscheme@suffix@.a   \
		$(LIBINSTALLDIR)/libfdschemeio@suffix@.a \
		$(LIBINSTALLDIR)/libfdweb@suffix@.a      \
		$(LIBINSTALLDIR)/libtexttools@suffix@.a
install-shared: shared-libs $(LIBINSTALLDIR) 				\
    $(LIBINSTALLDIR)/libfdtype@suffix@.@vshared_suffix@			\
    $(LIBINSTALLDIR)/libfdtype@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libfdtype@suffix@.@mshared_suffix@			\
    $(LIBINSTALLDIR)/libfdtype@suffix@.@shared_suffix@			\
    $(LIBINSTALLDIR)/libfddb@suffix@.@vshared_suffix@			\
    $(LIBINSTALLDIR)/libfddb@suffix@.@mmshared_suffix@			\
    $(LIBINSTALLDIR)/libfddb@suffix@.@mshared_suffix@			\
    $(LIBINSTALLDIR)/libfddb@suffix@.@shared_suffix@			\
    $(LIBINSTALLDIR)/libfdbserv@suffix@.@vshared_suffix@		\
    $(LIBINSTALLDIR)/libfdbserv@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libfdbserv@suffix@.@mshared_suffix@		\
    $(LIBINSTALLDIR)/libfdbserv@suffix@.@shared_suffix@			\
    $(LIBINSTALLDIR)/libfddbfile@suffix@.@vshared_suffix@		\
    $(LIBINSTALLDIR)/libfddbfile@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libfddbfile@suffix@.@mshared_suffix@		\
    $(LIBINSTALLDIR)/libfddbfile@suffix@.@shared_suffix@		\
    $(LIBINSTALLDIR)/libfdscheme@suffix@.@vshared_suffix@		\
    $(LIBINSTALLDIR)/libfdscheme@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libfdscheme@suffix@.@mshared_suffix@		\
    $(LIBINSTALLDIR)/libfdscheme@suffix@.@shared_suffix@		\
    $(LIBINSTALLDIR)/libfdschemeio@suffix@.@vshared_suffix@		\
    $(LIBINSTALLDIR)/libfdschemeio@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libfdschemeio@suffix@.@mshared_suffix@		\
    $(LIBINSTALLDIR)/libfdschemeio@suffix@.@shared_suffix@		\
    $(LIBINSTALLDIR)/libfdweb@suffix@.@vshared_suffix@			\
    $(LIBINSTALLDIR)/libfdweb@suffix@.@mmshared_suffix@			\
    $(LIBINSTALLDIR)/libfdweb@suffix@.@mshared_suffix@			\
    $(LIBINSTALLDIR)/libfdweb@suffix@.@shared_suffix@			\
    $(LIBINSTALLDIR)/libtexttools@suffix@.@vshared_suffix@		\
    $(LIBINSTALLDIR)/libtexttools@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libtexttools@suffix@.@mshared_suffix@		\
    $(LIBINSTALLDIR)/libtexttools@suffix@.@shared_suffix@

install-headers: $(INCINSTALLDIR)
	@$(SYSINSTALL) -p @install_file_opts@		\
		   $(DTYPE_HEADERS) $(DB_HEADERS)	\
		   $(DBFILE_HEADERS) $(SCHEME_HEADERS)	\
		   $(LIB_HEADERS) $(REVISION_H)		\
		$(INCINSTALLDIR)

install-data: $(DATADIR)
	@$(SYSINSTALL) @install_file_opts@ docs/misc/data.README \
		$(DATADIR)/README
	@$(SYSINSTALL) @install_file_opts@ @DATAFILES@ $(DATADIR)

install-exe: $(BININSTALLDIR) $(EXECUTABLES)
	@$(SYSINSTALL) -p @install_exe_opts@ $(EXECUTABLES) $(BININSTALLDIR)
	@cd $(BININSTALLDIR); $(SUDO) rm -f fdbserver; 	$(SUDO) ln -s fdserver fdbserver
	@cd $(BININSTALLDIR); $(SUDO) rm -f fdserv; $(SUDO) ln -s fdservlet fdserv

install-scripts: install-shell-scripts install-scheme-scripts
install-shell-scripts:
	@$(SYSINSTALL) @install_exe_opts@ $(SHELL_SCRIPTS) $(BININSTALLDIR)
install-scheme-scripts: $(BININSTALLDIR) $(SCHEME_SCRIPTS)
	@$(SYSINSTALL) @install_exe_opts@ $(SCHEME_SCRIPTS) $(BININSTALLDIR)

install-data: \
	$(DESTDIR)@config_dir@/boot/framerd.service	\
	$(DESTDIR)@config_dir@/boot/framerd-rc.d 	\
	$(DESTDIR)@config_dir@/boot/framerd.conf 	\
	$(DESTDIR)@config_dir@/boot/fdserver.conf 	\
	$(DESTDIR)@config_dir@/boot/fdservlet.conf 	\
	$(DESTDIR)@config_dir@/boot/logrotate

install-fastcgi: $(BININSTALLDIR)/fdcgiexec@suffix@
$(BININSTALLDIR)/fdcgiexec@suffix@:
	@$(SYSINSTALL) -p @install_exe_opts@ exe/fdcgiexec@suffix@ $(BININSTALLDIR)

install-cmodules: @INSTALLCMODULES@ install-sundown
install-odbc: ${CMODULES}/odbc.@shared_suffix@ ${CMODULES}/odbc.@vshared_suffix@
install-sqlite: ${CMODULES}/sqlite.@shared_suffix@ ${CMODULES}/sqlite.@vshared_suffix@
install-dbus: ${CMODULES}/dbus.@shared_suffix@ ${CMODULES}/dbus.@vshared_suffix@
install-ldap: ${CMODULES}/ldap.@shared_suffix@ ${CMODULES}/ldap.@vshared_suffix@
install-crypto: ${CMODULES}/crypto.@shared_suffix@ ${CMODULES}/crypto.@vshared_suffix@
install-mysql: ${CMODULES}/mysql.@shared_suffix@ ${CMODULES}/mysql.@vshared_suffix@
install-qrcode: ${CMODULES}/qrcode.@shared_suffix@ ${CMODULES}/qrcode.@vshared_suffix@
install-hyphenate: ${CMODULES}/hyphenate.@shared_suffix@ ${CMODULES}/hyphenate.@vshared_suffix@
install-ziptools: ${CMODULES}/ziptools.@shared_suffix@ ${CMODULES}/ziptools.@vshared_suffix@
install-tidy: ${CMODULES}/tidy.@shared_suffix@ ${CMODULES}/tidy.@vshared_suffix@
install-imagick: ${CMODULES}/imagick.@shared_suffix@ ${CMODULES}/imagick.@vshared_suffix@
install-mongodb: ${CMODULES}/mongodb.@shared_suffix@ ${CMODULES}/mongodb.@vshared_suffix@
install-exif: ${CMODULES}/exif.@shared_suffix@ ${CMODULES}/exif.@vshared_suffix@
install-zlib: ${CMODULES}/zlib.@shared_suffix@ ${CMODULES}/zlib.@vshared_suffix@
install-sundown: ${CMODULES}/sundown.@shared_suffix@ ${CMODULES}/sundown.@vshared_suffix@

# Setup targets

workdirs: $(DESTDIR)@framerd_rundir@ $(DESTDIR)@framerd_logdir@ \
	$(DESTDIR)@daemon_rundir@ $(DESTDIR)@daemon_logdir@ \
	$(DESTDIR)@servlet_rundir@ $(DESTDIR)@servlet_logdir@ \
	$(DESTDIR)@bugjar@

confdirs: $(DESTDIR)@builtin_module_dir@ $(DESTDIR)@builtin_safe_module_dir@ \
	  $(DESTDIR)@installed_module_dir@ $(DESTDIR)@installed_safe_module_dir@ \
	  $(DESTDIR)@local_module_dir@ $(DESTDIR)@local_safe_module_dir@ \
	  $(DESTDIR)@unpackage_dir@ \
	  $(DESTDIR)@local_config@ $(DESTDIR)@shared_config@ \
	  $(DESTDIR)@config_dir@ $(DESTDIR)@config_dir@/daemons \
	  $(DESTDIR)@config_dir@/servlets \
	  $(DESTDIR)@config_dir@/config
	@$(MSG) Setting up configuration directories
	@if test ! -f $(DESTDIR)@config_dir@/servers; then \
		$(SYSINSTALL) @install_file_opts@ /dev/null \
			$(DESTDIR)@config_dir@/servers; fi

$(DESTDIR)@builtin_module_dir@ $(DESTDIR)@builtin_safe_module_dir@ \
  $(DESTDIR)@installed_module_dir@ $(DESTDIR)@installed_safe_module_dir@ \
  $(DESTDIR)@shared_module_dir@ $(DESTDIR)@shared_safe_module_dir@ \
  $(DESTDIR)@local_module_dir@ $(DESTDIR)@local_safe_module_dir@:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@
$(DESTDIR)@unpackage_dir@:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@

upstartdirs: $(DESTDIR)@config_dir@/daemons $(DESTDIR)@config_dir@/servlets

MODULE_DIRS=aws brico bugjar facebook misc paypal tests twitter dropbox google \
	jwt domutils knodules textindex
MODULE_DATA_DIRS=textindex/data brico/data knodules/data \
		 aws/templates bugjar/websrc

install-modules: install-builtin-modules install-web-modules
install-builtin-modules: install-standard-modules install-safe-modules

install-standard-modules: install-module-source install-module-data

install-module-source: $(DESTDIR)@builtin_module_dir@
	@$(ECHO) Copying standard Scheme modules to @builtin_module_dir@
	@$(SYSINSTALL) @install_file_opts@ $(BUILD)/src/modules/*.scm 		\
		$(DESTDIR)@builtin_module_dir@;
	@for dir in $(MODULE_DIRS); do						\
	  install_dir="$(DESTDIR)@builtin_module_dir@/$${dir}";			\
	  echo "Installing $${dir} module at $${install_dir}";			\
	  $(SYSINSTALL) @install_dir_opts@ $${install_dir};			\
	  $(SYSINSTALL) @install_file_opts@ $(BUILD)/src/modules/$${dir}/*.scm	\
	      $${install_dir};							\
	done;

install-module-data: $(DESTDIR)@builtin_module_dir@
	@$(ECHO) Copying module data to @builtin_module_dir@;
	@for dir in $(MODULE_DATA_DIRS); do					\
	  src_dir="$(BUILD)/src/modules/$${dir}";				\
	  install_dir="$(DESTDIR)@builtin_module_dir@/$${dir}";			\
	  echo Installing data from $${src_dir} to $${install_dir};		\
	  $(SYSINSTALL) @install_dir_opts@ $${install_dir};			\
	  $(SYSINSTALL) @install_file_opts@ $${src_dir}/* $${install_dir};	\
	done

install-safe-modules: $(DESTDIR)@builtin_safe_module_dir@ install-standard-modules
	@$(ECHO) Linking 'safe' Scheme modules from @builtin_module_dir@ 	\
			to @builtin_safe_module_dir@
	@for safe_link in $(BUILD)/src/modules/safe/*; do 			\
          ${SUDO} ln -sf `readlink $${safe_link}` 				\
		          $(DESTDIR)@builtin_safe_module_dir@; 			\
	 done

install-web-modules: $(DESTDIR)@builtin_module_dir@
	@$(SYSINSTALL) @install_dir_opts@ $(DESTDIR)@builtin_module_dir@/xhtml
	@$(SYSINSTALL) @install_dir_opts@ $(DESTDIR)@builtin_module_dir@/fdxml;
	@$(SYSINSTALL) @install_file_opts@ $(BUILD)/src/fdweb/xhtml/*.scm \
		$(DESTDIR)@builtin_module_dir@/xhtml;
	@$(SYSINSTALL) @install_file_opts@ $(BUILD)/src/fdweb/fdxml/*.scm \
		$(DESTDIR)@builtin_module_dir@/fdxml;
	${SUDO} ln -sf ../xhtml $(DESTDIR)@builtin_safe_module_dir@;
	${SUDO} ln -sf ../fdxml $(DESTDIR)@builtin_safe_module_dir@;

install-support: $(DESTDIR)@share_dir@
	cd $(BUILD)/etc; $(SYSINSTALL) @install_file_opts@ 	\
		gdbinit makefile.include fdconsole.el 		\
		$(DESTDIR)@share_dir@

logdirs: $(DESTDIR)@framerd_logdir@ $(DESTDIR)@servlet_logdir@ \
	$(DESTDIR)@daemon_logdir@

statedirs: $(DESTDIR)@rundir@/framerd \
	$(DESTDIR)@daemon_rundir@ \
	$(DESTDIR)@servlet_rundir@ \
	logdirs
$(DESTDIR)/etc/init.d:
	@$(SYSINSTALL) -m 0755 -d $(DESTDIR)/etc/init.d
$(DESTDIR)/etc/init.d/framerd: etc/framerd-rc.d $(DESTDIR)/etc/init.d
	@$(MSG) Installing FramerD init.d
	@$(SYSINSTALL) -m 0555 @admininstall@ \
		   etc/framerd-rc.d $(DESTDIR)/etc/init.d/framerd
$(DESTDIR)@framerd_rundir@:
	@$(MSG) Installing FramerD run directory
	@$(SYSINSTALL) -m 0775  @fdaemoninstall@ @admininstall@ -d \
		   $(DESTDIR)@framerd_rundir@
$(DESTDIR)@daemon_rundir@: $(DESTDIR)@framerd_rundir@
	@$(MSG) Installing FramerD daemon run directory
	@$(SYSINSTALL) -m 0775  @fdaemoninstall@ @admininstall@ -d \
		   $(DESTDIR)@daemon_rundir@
$(DESTDIR)@servlet_rundir@: $(DESTDIR)@framerd_rundir@
	@$(MSG) Installing FramerD servlet run directory
	@$(SYSINSTALL) -m 0775  @wwwinstall@ @admininstall@ -d \
		   $(DESTDIR)@servlet_rundir@
$(DESTDIR)@framerd_logdir@:
	@$(MSG) Installing FramerD log directory
	@$(SYSINSTALL) -m 0775 @fdaemoninstall@  @admininstall@ -d \
		   $(DESTDIR)@framerd_logdir@
$(DESTDIR)@bugjar@: $(DESTDIR)@framerd_logdir@
	@$(MSG) Installing FramerD bugjar directory
	@$(SYSINSTALL) -m 0777 @fdaemoninstall@  @admininstall@ -d \
		   $(DESTDIR)@bugjar@
$(DESTDIR)@daemon_logdir@:  $(DESTDIR)@framerd_logdir@
	@$(SYSINSTALL) -m 0775 @fdaemoninstall@ @admininstall@ \
		-d $(DESTDIR)@daemon_logdir@
$(DESTDIR)@servlet_logdir@: $(DESTDIR)@framerd_logdir@
	@$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
		-d $(DESTDIR)@servlet_logdir@

$(DESTDIR)@config_dir@/boot:
	@$(SYSINSTALL) @install_dir_opts@ $@

setup-sysv: $(DESTDIR)/etc/init.d/framerd statedirs
enable-sysv: setup-sysv
	@if which update-rc.d; then \
		$(MSG) Updating rc.d; \
		$(SUDO) update-rc.d framerd defaults; \
	 fi

startupdirs: $(DESTDIR)@config_dir@/daemons $(DESTDIR)@config_dir@/servlets

setup-upstart: $(DESTDIR)/etc/init/fdserver.conf \
	$(DESTDIR)/etc/init/fdservlet.conf \
	$(DESTDIR)/etc/init/framerd.conf \
	startupdirs
$(DESTDIR)/etc/init:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $(DESTDIR)/etc/init
$(DESTDIR)/etc/init/fdserver.conf: etc/fdserver.conf $(DESTDIR)/etc/init
	@$(MSG) Installing fdserver Upstart config to $(DESTDIR)/etc/init/fdserver.conf
	@$(SYSINSTALL) -m 0555 @admininstall@ \
		   etc/fdserver.conf $(DESTDIR)/etc/init/fdserver.conf
$(DESTDIR)/etc/init/fdservlet.conf: etc/fdservlet.conf $(DESTDIR)/etc/init
	@$(MSG) Installing fdservlet Upstart config to $(DESTDIR)/etc/init/fdservlet.conf
	@$(SYSINSTALL) -m 0555 @admininstall@ \
		   etc/fdservlet.conf $(DESTDIR)/etc/init/fdservlet.conf
$(DESTDIR)/etc/init/framerd.conf: etc/framerd.conf $(DESTDIR)/etc/init
	@$(MSG) Installing framerd Upstart config to $(DESTDIR)/etc/init/framerd.conf
	@$(SYSINSTALL) -m 0555 @admininstall@ \
		   etc/framerd.conf $(DESTDIR)/etc/init/framerd.conf

$(DESTDIR)@systemd_loc@:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $(DESTDIR)@systemd_loc@
setup-systemd: $(DESTDIR)@systemd_loc@/framerd.service startupdirs
$(DESTDIR)@systemd_loc@/framerd.service: $(DESTDIR)@systemd_loc@ etc/framerd.service
	@$(MSG) Installing framerd systemd config to $(DESTDIR)@systemd_loc@/framerd.service
	@$(SYSINSTALL) -m 0444 @admininstall@ \
		   etc/framerd.service $(DESTDIR)@systemd_loc@/framerd.service
	@if test -z "${DESTDIR}" && test ! -z "${SUDO}"; then 	\
	   ${MSG} systemctl daemon-reload; 			\
	   ${SUDO} systemctl daemon-reload; 			\
	fi

setup-logrotate: etc/logrotate $(DESTDIR)/etc/logrotate.d/framerd logdirs
$(DESTDIR)/etc/logrotate.d:
	@$(SYSINSTALL) -m 0755 -d $@
$(DESTDIR)/etc/logrotate.d/framerd: etc/logrotate $(DESTDIR)/etc/logrotate.d
	@$(MSG) Installing logrotate script
	@$(SYSINSTALL) -T -m 0644 etc/logrotate $(DESTDIR)/etc/logrotate.d/framerd

setup-allboot: setup-sysv setup-upstart setup-systemd

setup-unix: @BOOTSETUP@ setup-logrotate
setup-linux: setup-unix

setup-osx: @share_dir@ startupdirs statedirs logdirs 
	@$(MSG) Setting up OSX system configuration
	@$(SUDO) etc/setup-osx "@share_dir@" \
		"${INSTALL} @install_dir_opts@" \
		"${INSTALL} @install_exe_opts@" \
		"${INSTALL} @install_exe_opts@" \
		/Library /etc

setup-none:
	@echo "Not setting up a boot system"

.PHONY: setup-none setup-osx setup-linux setup-unix setup-allboot setup-logrotate \
	setup-sysv setup-upstart setup-systemd

# Build setups

build-setup.debian:
	sudo apt-get install -m libcurl4-openssl-dev libssl-dev libldns-dev \
		libmysqlclient-dev libmongoc-dev unixodbc-dev sqlite3 \
		libzip-dev apache2-dev libedit-dev libhyphen-dev \
		libmagickwand-dev libqrencode-dev libexif-dev \
		libgoogle-perftools-dev \
		dh-make devscripts dpkg-dev
build-setup.redhat:
	sudo rpm -Uvh libedit-devel

.PHONY: debian-build-setup rpm-build-setup

# The mod_fdserv module

etc/mod_fdserv.so: etc/mod_fdserv.c @abs_top_srcdir@/fileinfo
	@$(ECHO) "#define _FILEINFO \""`@abs_top_srcdir@/fileinfo etc/mod_fdserv.c .`"\"" \
		> etc/mod_fdserv_fileinfo.h
	${APXS} -DUSEDTBLOCK=@USEDTBLOCK@ -DDEBUG_FDSERV=$(DEBUG_FDSERV) \
		-c etc/mod_fdserv.c

mod_fdserv: etc/mod_fdserv.so

# For OSX, try this
# apxs -Wc,'-arch x86_64' -Wl,'-arch x86_64'  -a -i -c etc/mod_fdserv.c
install-fdserv: etc/mod_fdserv.so $(DESTDIR)@apache_modinfo@ \
	$(DESTDIR)@apache_modules_dir@ $(DESTDIR)@servlet_logdir@
	@cd etc; $(SYSINSTALL) @install_file_opts@ fdserv.conf \
			$(DESTDIR)@apache_modinfo@;
	@cd etc; $(SYSINSTALL) @install_file_opts@ fdserv.load \
			$(DESTDIR)@apache_modinfo@;
	@$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
			-d $(DESTDIR)@rundir@/fdserv;
	@cd etc; if test -f mod_fdserv.so; \
		then @SUDO@ ${APXS} -i mod_fdserv.so; \
		else @SUDO@ ${APXS} -i mod_fdserv.la; \
		fi
	@echo Installed fdserv module with @rundir@/fdserv @logdir@/fdserv

$(DESTDIR)@apache_modules_dir@:
	@$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
		-d $(DESTDIR)@apache_modules_dir@
$(DESTDIR)@apache_modinfo@:
	@$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
		-d $(DESTDIR)@apache_modinfo@

update-fdserv: etc/mod_fdserv.so $(DESTDIR)@apache_modinfo@ \
		$(DESTDIR)@apache_modules_dir@
	@$(MSG) "STOPPING and STARTING Apache to INSTALL NEW mod_fdserv"
	@$(MSG) "THIS REQUIRES sudo PRIVILEGES; you may be prompted for your password"
	sudo apachectl stop
	cd etc; sudo ${INSTALL} @install_file_opts@ fdserv.conf fdserv.load \
			$(DESTDIR)@apache_modinfo@;
	$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
			-d $(DESTDIR)@rundir@/fdserv;
	$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
			-d $(DESTDIR)@logdir@/fdserv;
	cd etc; if test -f mod_fdserv.so; \
		then sudo ${APXS} -i mod_fdserv.so; \
		else sudo ${APXS} -i mod_fdserv.la; fi
	sleep 5; sudo apachectl start

# Meta operations

update-modules:
	git submodule update --remote --merge --recursive

.PHONY: fdserv update-fdserv install-fdserv update-modules

# Tracking revision information

include/framerd/revision.h: $(FRAMERD_SOURCES) $(FRAMERD_HEADERS) makefile
	@if test -f etc/revision.h; then				\
	    cp etc/revision.h etc/use_revision.h; 			\
	elif $(GITDESCRIBE) > /dev/null 2>&1; then			\
	    echo "#define FRAMERD_REVISION \""`@GITDESCRIBE@`"\"" 	\
		> etc/use_revision.h; 					\
	else echo "#define FRAMERD_REVISION \"@U8VERSION@-exported\""	\
		> etc/use_revision.h; 					\
	fi
	@if test ! -f $@; then 						\
	  mv etc/use_revision.h $@; 					\
	elif diff etc/use_revision.h $@>/dev/null; then			\
	  rm etc/use_revision.h; 					\
	else 								\
	  echo "Revision changed to "`@GITDESCRIBE@`; 			\
	  mv $@ etc/old_revision.h; 					\
	  mv etc/use_revision.h $@;					\
	fi

# Depending on the buildmode
$(EXECUTABLES) $(STATIC_EXECUTABLES): buildmode $(REVISION_H)
#$(STATIC_LIBS) $(SHARED_LIBS): buildmode
$(DTYPE_OBJS): $(DTYPE_HEADERS) $(REVISION_H)
$(DB_OBJS): $(DTYPE_HEADERS) $(DB_HEADERS) $(REVISION_H)
$(DBFILE_OBJS): $(DTYPE_HEADERS) $(DB_HEADERS) $(DBFILE_HEADERS) $(REVISION_H)
$(SCHEME_OBJS): $(DTYPE_HEADERS) $(DB_HEADERS) $(DBFILE_HEADERS) \
	$(SCHEME_HEADERS) $(REVISION_H)
$(FDWEB_OBJS): $(DTYPE_HEADERS) $(DB_HEADERS) $(DBFILE_HEADERS) \
	$(SCHEME_HEADERS) $(REVISION_H) ./include/framerd/fdweb.h
$(TEXTTOOLS_OBJS): $(DTYPE_HEADERS) $(DB_HEADERS) $(DBFILE_HEADERS) \
	 $(REVISION_H) $(SCHEME_HEADERS) ./include/framerd/texttools.h
$(DTYPE_OBJS) $(DB_OBJS) $(DBFILE_OBJS):  buildmode
$(SCHEME_OBJS) $(SCHEMEIO_OBJS): buildmode
$(FDWEB_OBJS) $(TEXTTOOLS_OBJS): buildmode
$(CMODULE_OBJS): buildmode

# We've stopped using makedpend for the time being

# Making dependency information

#depend:
#	makedepend -- $(CFLAGS) -- $(FRAMERD_SOURCES) $(CMODULE_SOURCES)
#depend.in:
#	makedepend -fmakefile.in -Y -- $(CFLAGS) -- $(FRAMERD_SOURCES) $(CMODULE_SOURCES)


# DO NOT DELETE THIS LINE -- make depend depends on it.

