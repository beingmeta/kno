# -*- Mode: Makefile; -*-
# Copyright Â© 2004-2019 beingmeta, inc
# This file is a part of beingmeta's FramerD implementation

CC	      = @CC@
XCFLAGS       =
OPTFLAGS      = "@OPTFLAGS@"
XOPTFLAGS     = "@XOPTFLAGS@"
ARCHFLAGS     = @archflags@
EXECFLAGS     = @CFLAGS@ ${OPTFLAGS} @MALLOC_FLAGS@ @PROFILING@ @DREENTRANT@ \
		-I./include $(XCFLAGS) $(ARCHFLAGS)
DYNAMIC_CFLAG = @dynamic_cflag@
CFLAGS        = -I./include @CFLAGS@ ${OPTFLAGS} \
		@MALLOC_FLAGS@ @PROFILING@ @DREENTRANT@ \
		@PTHREAD_LIBS@ $(DYNAMIC_CFLAG) \
		-I./include $(XCFLAGS)  $(ARCHFLAGS)
RPATH         = @rpath@
RPATHFLAGS    = @RPATHFLAGS@
LDFLAGS       = -L./ -L./lib @LDFLAGS@ @PTHREAD_LIBS@ $(XLDFLAGS)
DYLIB_FLAGS   = -compatibility_version @FDMAJOR@.0.0 \
		-current_version @FDMAJOR@.@FDMINOR@.@FDRELEASE@
EXEFLAGS      = @EXEFLAGS@
EXELIBS       = @EXELIBS@
STATIC_CFLAGS = -I./include @CFLAGS@ @PROFILING@ @DREENTRANT@ \
		$(DYNAMIC_CFLAG) -I./include $(XCFLAGS)
TEST_CFLAGS   = -DFD_TESTCONFIG=1 ${STATIC_CFLAGS}
STATIC_LDFLAGS= -L./lib @LDFLAGS@ $(EFENCE) @TESTLDFLAGS@ -L./lib
TEST_LDFLAGS  = ${STATIC_LDFLAGS}
TEST_EXEFLAGS = @EXEFLAGS@
XLIBS         =
LIBS          = $(XLIBS) @LIBS@
PATH          = @BINPATH@
DEBBUILD      = -b
INDENTOPTS    = -br -ce -psl -Tfdtype -Tu8_string -Tfd_stream -Tfd_inbuf \
		-Tfd_outbuf -Tfd_rawbuf -Tfd_function -Tfd_pair -Tfd_choice

DESTDIR		=
prefix		= @prefix@
exec_prefix	= @exec_prefix@
datarootdir	= @datarootdir@
datadir		= @datadir@
INCINSTALLDIR	= $(DESTDIR)@prefix@/include/framerd
LIBINSTALLDIR	= $(DESTDIR)@libdir@
BININSTALLDIR	= $(DESTDIR)@exec_prefix@/bin
LOCALEDIR	= $(DESTDIR)@exec_prefix@/share/locale
DATADIR		= $(DESTDIR)@datadir@/framerd/data
CMODULES	= ${LIBINSTALLDIR}/framerd
APXS		= @APXS@ -S LIBEXECDIR=$(DESTDIR)@apache_modules_dir@
PPROF_PATH      = @GOOGLE_PPROF@
CLEAN		= @CLEAN@
ECHO		= @ECHO@
MSG		= @MSG@
SUINSTALL	= @SUINSTALL@
SYSINSTALL	= @SUINSTALL@@INSTALL@
SUDO	        = @SUDO@
INSTALL		= @INSTALL@
MKSTATIC	= @MKSTATIC@ -o 
CODENAME	= @CODENAME@
MKSO		= $(CC) -shared $(LDFLAGS)
MACLIBTOOL	= $(CC) -dynamiclib -single_module -undefined dynamic_lookup \
			$(LDFLAGS)
BUILD		= `pwd`
BUILDMODE       := `cat .buildmode || echo none`
LINKEDWITH      := `cat .malloc || echo standard libraries`
DEBUG_FDSERV    = 0
RPMFLAGS	= @RPMFLAGS@
RPMDIR		= @RPMDIR@
GPG		= @GPG@
GPGID		= @GPGID@
RPMGPG		= %__gpg gpg --force-v3-sigs --digest-algo=sha1 -u \"%{_gpg_name}\" --no-armor --no-secmem-warning -sbo %{__signature_filename} %{__plaintext_filename}
APTREPO		= @APTREPO@
FDVERSION	= @FDVERSION@
DEBNAME		:= $(shell etc/dpkgname framerd)
APTVERSION	:= $(shell etc/aptversion framerd)
REVISION	:= $(shell etc/gitrev)
GITBRANCH	:= $(shell etc/gitbranch)
LIBSCM	 	= @LIBSCM@
LISP_HEADERS=\
 include/framerd/fdsource.h                          \
 include/framerd/config.h                            \
 include/framerd/common.h                            \
 include/framerd/errobjs.h                          \
 include/framerd/defines.h                           \
 include/framerd/support.h                           \
 include/framerd/numbers.h                           \
 include/framerd/bigints.h                           \
 include/framerd/malloc.h                            \
 include/framerd/dtype.h    			     \
 include/framerd/pprint.h    			     \
 include/framerd/ptr.h				     \
 include/framerd/cons.h        			     \
 include/framerd/compounds.h			     \
 include/framerd/choices.h			     \
 include/framerd/tables.h  			     \
 include/framerd/sequences.h  			     \
 include/framerd/fdregex.h  			     \
 include/framerd/bufio.h			     \
 include/framerd/dtypeio.h
APPLY_HEADERS=\
 include/framerd/apply.h   \
 include/framerd/cprims.h   \
 include/framerd/stacks.h  \
 include/framerd/lexenv.h  \
 include/framerd/ffi.h
STORAGE_HEADERS=\
 include/framerd/components/storage_layer.h	\
 include/framerd/streams.h			\
 include/framerd/storage.h			\
 include/framerd/pools.h			\
 include/framerd/indexes.h			\
 include/framerd/bloom.h  			\
 include/framerd/dtproc.h			\
 include/framerd/dtcall.h			\
 include/framerd/frames.h			\
 include/framerd/methods.h

DRIVERS_H=include/framerd/drivers.h
SCHEME_HEADERS=include/framerd/eval.h include/framerd/threads.h \
	include/framerd/opcodes.h include/framerd/seqprims.h \
	include/framerd/procprims.h
LIB_HEADERS=include/framerd/texttools.h include/framerd/fdweb.h \
		include/framerd/mongodb.h \
	        include/framerd/leveldb.h \
	        include/framerd/rocksdb.h

# Headers which don't live in include/framerd
SRC_HEADERS=src/lisp/biginternals.h 		\
	src/eval/eval_internals.h 		\
	src/exe/webcommon.h 			\
	src/drivers/headers/zcompress.h 	\
	src/drivers/headers/filepool.h 		\
	src/drivers/headers/fileindex.h 	\
	src/drivers/headers/memindex.h	 	\
	src/drivers/headers/bigpool.h	 	\
	src/drivers/headers/oidpool.h	 	\
	src/drivers/headers/hashindex.h		\
	src/drivers/headers/netindex.h		\
	src/drivers/headers/netpool.h		\
	src/cmodules/fdsqlite.h			\

LISP_OBJS=\
	src/lisp/oids.o src/lisp/fcnids.o 			\
	src/lisp/symbols.o src/lisp/cons.o 			\
	src/lisp/recycle.o src/lisp/copy.o 			\
	src/lisp/compare.o src/lisp/walk.o			\
	src/lisp/tables.o src/lisp/sequences.o			\
	src/lisp/choices.o src/lisp/numbers.o 			\
	src/lisp/compounds.o src/lisp/misctypes.o		\
	src/lisp/parse.o src/lisp/unparse.o			\
	src/lisp/bufio.o src/lisp/pprint.o  			\
	src/lisp/listing.o src/lisp/consblocks.o		\
	src/lisp/dtread.o src/lisp/dtwrite.o			\
	src/lisp/lisp.o

SUPPORT_OBJS=						\
	src/support/buildinfo.o src/support/support.o	\
	src/support/config.o src/support/errobjs.o	\
	src/support/logging.o src/support/getopt.o	\
	src/support/startup.o src/support/fluid.o 	\
	src/support/signals.o src/support/posix.o 	\
	src/support/sourcebase.o

APPLY_OBJS=\
	src/apply/apply.o src/apply/stacks.o 			\
	src/apply/ffi.o src/apply/cprims.o			\
	src/apply/lexenv.o

REVISION_H   =include/framerd/revision.h
CONFIG_H     =include/framerd/config.h
CONFIG_HDRS  =${REVISION_H} ${CONFIG_H}

STORAGE_OBJS=\
	src/storage/storage.o src/storage/streams.o 		\
	src/storage/hashdtype.o src/storage/compress.o 	\
	src/storage/pools.o src/storage/indexes.o 		\
	src/storage/aggregates.o				\
	src/storage/dtproc.o src/storage/dtcall.o 		\
	src/storage/bloom.o src/storage/alcor.o			\
	src/storage/methods.o src/storage/oidstore.o 		\
	src/storage/cachecall.o src/storage/threadcache.o	\
	src/storage/extindex.o src/storage/extpool.o		\
	src/storage/procpool.o src/storage/procindex.o		\
	src/storage/mempool.o src/storage/tempindex.o		\
	src/storage/frames.o src/storage/slotindexes.o 		\
	src/storage/drivers.o					\
	@ipevalo@ 

DRIVER_OBJS=\
	src/drivers/builtin_drivers.o			\
	src/drivers/filepool.o src/drivers/oidpool.o	\
	src/drivers/netpool.o src/drivers/bigpool.o	\
	src/drivers/fileindex.o src/drivers/hashindex.o	\
	src/drivers/memindex.o src/drivers/netindex.o

DBSERV_OBJS=src/storage/dbserv.o

CORE_SCHEME_OBJS=\
	src/eval/eval.o\
	src/eval/debug.o\
	src/eval/options.o\
	src/eval/testops.o\
	src/eval/appenv.o\
	src/eval/binders.o\
	src/eval/lambda.o\
	src/eval/macros.o\
	src/eval/threads.o\
	src/eval/quasiquote.o \
	src/eval/struct_eval.o \
	src/eval/errfns.o\
	src/eval/conditionals.o\
	src/eval/iterators.o

SCHEME_OBJS=\
	$(CORE_SCHEME_OBJS) \
	src/eval/modules.o \
	src/eval/load.o \
	src/eval/reflection.o \
	src/eval/compoundfns.o \
	src/eval/choiceops.o \
	src/eval/coreops.o \
	src/eval/arith.o \
	src/eval/side-effects.o \
	src/eval/regex.o \
	src/eval/reqstate.o \
	src/prims/dbprims.o \
	src/prims/tableprims.o \
	src/prims/seqprims.o \
	src/prims/stringprims.o \
	src/prims/portprims.o \
	src/prims/logprims.o \
	src/prims/streamprims.o \
	src/prims/timeprims.o \
	src/prims/sysprims.o \
	src/prims/procprims.o \
	@ipevalprimso@ \
	src/prims/extdbprims.o \
	src/prims/fileprims.o \
	src/prims/driverprims.o \
	src/eval/loader.o \
	src/eval/history.o

WEB_OBJS=\
	src/web/fdweb.o \
	src/web/xmloutput.o \
	src/web/htmlout.o \
	src/web/xmlinput.o \
	src/web/xmldata.o \
	src/web/mime.o \
	src/web/email.o \
	src/web/uriprims.o \
	src/web/xmleval.o \
	src/web/cgiexec.o \
	src/web/json.o \
	@ldnso@ @curlo@

TEXT_OBJS=\
	src/text/texttools.o \
	src/text/match.o \
	src/text/porter.o \
	src/text/phonetic.o
SUNDOWN_OBJS=\
	src/cmodules/ext/sundown/autolink.o \
	src/cmodules/ext/sundown/buffer.o \
	src/cmodules/ext/sundown/houdini_href_e.o \
	src/cmodules/ext/sundown/houdini_html_e.o \
	src/cmodules/ext/sundown/html.o src/cmodules/ext/sundown/html_smartypants.o \
	src/cmodules/ext/sundown/markdown.o \
	src/cmodules/ext/sundown/stack.o \
	src/cmodules/sundown.o

SUNDOWN_OBJECTS=src/cmodules/ext/sundown/autolink.o src/cmodules/ext/sundown/buffer.o \
	src/cmodules/ext/sundown/markdown.o src/cmodules/ext/sundown/stack.o \
	src/cmodules/ext/sundown/html.o src/cmodules/ext/sundown/html_smartypants.o \
	src/cmodules/ext/sundown/houdini_href_e.o src/cmodules/ext/sundown/houdini_html_e.o
SUNDOWN_H_FILES=src/cmodules/ext/sundown/autolink.h src/cmodules/ext/sundown/buffer.h \
	src/cmodules/ext/sundown/markdown.h src/cmodules/ext/sundown/stack.h \
	src/cmodules/ext/sundown/html_blocks.h src/cmodules/ext/sundown/html.h \
	src/cmodules/ext/sundown/houdini.h

TIDY_OBJECTS=\
	src/cmodules/ext/tidy5/access.o 	\
	src/cmodules/ext/tidy5/alloc.o 	\
	src/cmodules/ext/tidy5/attrask.o 	\
	src/cmodules/ext/tidy5/attrdict.o 	\
	src/cmodules/ext/tidy5/attrget.o 	\
	src/cmodules/ext/tidy5/attrs.o 	\
	src/cmodules/ext/tidy5/buffio.o 	\
	src/cmodules/ext/tidy5/charsets.o 	\
	src/cmodules/ext/tidy5/clean.o 	\
	src/cmodules/ext/tidy5/config.o 	\
	src/cmodules/ext/tidy5/entities.o 	\
	src/cmodules/ext/tidy5/fileio.o 	\
	src/cmodules/ext/tidy5/gdoc.o 	\
	src/cmodules/ext/tidy5/iconvtc.o 	\
	src/cmodules/ext/tidy5/istack.o 	\
	src/cmodules/ext/tidy5/language.o 	\
	src/cmodules/ext/tidy5/lexer.o 	\
	src/cmodules/ext/tidy5/mappedio.o 	\
	src/cmodules/ext/tidy5/message.o 	\
	src/cmodules/ext/tidy5/parser.o 	\
	src/cmodules/ext/tidy5/pprint.o 	\
	src/cmodules/ext/tidy5/sprtf.o 	\
	src/cmodules/ext/tidy5/streamio.o 	\
	src/cmodules/ext/tidy5/tagask.o 	\
	src/cmodules/ext/tidy5/tags.o 	\
	src/cmodules/ext/tidy5/tidylib.o 	\
	src/cmodules/ext/tidy5/tmbstr.o 	\
	src/cmodules/ext/tidy5/utf8.o 	\
	src/cmodules/ext/tidy5/win32tc.o

TIDY_H_FILES=\
	src/cmodules/ext/tidy5/access.h 	\
	src/cmodules/ext/tidy5/attrdict.h 	\
	src/cmodules/ext/tidy5/attrs.h 	\
	src/cmodules/ext/tidy5/buffio.h 	\
	src/cmodules/ext/tidy5/charsets.h 	\
	src/cmodules/ext/tidy5/clean.h 	\
	src/cmodules/ext/tidy5/config.h 	\
	src/cmodules/ext/tidy5/entities.h 	\
	src/cmodules/ext/tidy5/fileio.h 	\
	src/cmodules/ext/tidy5/forward.h 	\
	src/cmodules/ext/tidy5/gdoc.h 	\
	src/cmodules/ext/tidy5/iconvtc.h 	\
	src/cmodules/ext/tidy5/language_en_gb.h 	\
	src/cmodules/ext/tidy5/language_en.h 	\
	src/cmodules/ext/tidy5/language_es.h 	\
	src/cmodules/ext/tidy5/language_es_mx.h 	\
	src/cmodules/ext/tidy5/language_fr.h 	\
	src/cmodules/ext/tidy5/language.h 	\
	src/cmodules/ext/tidy5/language_zh_cn.h 	\
	src/cmodules/ext/tidy5/lexer.h 	\
	src/cmodules/ext/tidy5/mappedio.h 	\
	src/cmodules/ext/tidy5/message.h 	\
	src/cmodules/ext/tidy5/parser.h 	\
	src/cmodules/ext/tidy5/platform.h 	\
	src/cmodules/ext/tidy5/pprint.h 	\
	src/cmodules/ext/tidy5/sprtf.h 	\
	src/cmodules/ext/tidy5/streamio.h 	\
	src/cmodules/ext/tidy5/tags.h 	\
	src/cmodules/ext/tidy5/tidybuffio.h 	\
	src/cmodules/ext/tidy5/tidyenum.h 	\
	src/cmodules/ext/tidy5/tidy.h 	\
	src/cmodules/ext/tidy5/tidy-int.h 	\
	src/cmodules/ext/tidy5/tidyplatform.h 	\
	src/cmodules/ext/tidy5/tmbstr.h 	\
	src/cmodules/ext/tidy5/utf8.h 	\
	src/cmodules/ext/tidy5/version.h 	\
	src/cmodules/ext/tidy5/win32tc.h

CMODULE_OBJS=src/cmodules/odbc.o src/cmodules/sqlite.o \
	     src/cmodules/mysql.o src/cmodules/mongodb.o \
	     src/cmodules/rocksdb.o src/cmodules/leveldb.o \
	     src/cmodules/crypto.o src/cmodules/zlib.o \
	     src/cmodules/qrcode.o src/cmodules/exif.o \
	     src/cmodules/imagick.o src/cmodules/libarchive.o \
	     src/cmodules/ziptools.o \
	     src/cmodules/hyphenate.o src/cmodules/hunspell.o \
	     ${SUNDOWN_OBJS} ${TIDY_OBJECTS}

EXECUTABLES=exe/fdexec@suffix@ exe/fdconsole@suffix@ exe/fdbatch@suffix@  \
	    exe/fdservlet@suffix@ exe/fdserver@suffix@
STATIC_EXECUTABLES=static/fdexec@suffix@ static/fdconsole@suffix@ \
	static/fdbatch@suffix@ \
	static/fdservlet@suffix@ static/fdserver@suffix@
DEBUG_EXECUTABLES=dbg/fdexec dbg/fdconsole \
	dbg/fdbatch dbg/fdservlet dbg/fdserver
SHELL_SCRIPTS=etc/fdsetconfig etc/fdgetconfig etc/fdconfig \
	etc/fdstart etc/fdstop etc/fdstartall etc/fdstopall \
	etc/fd_start_daemons etc/fd_start_servlets etc/fd_stop_jobs \
	etc/fdsignal etc/fdinject etc/fdstatus etc/fdlog  \
	etc/fdrestart etc/fdctl etc/fdgdb etc/fdbgexec \
	etc/fdcleanup etc/fdjob
SCHEME_SCRIPTS=exe/scripts/pack-pool exe/scripts/pack-index \
	       exe/scripts/hashindexop exe/scripts/reset-pool \
               exe/scripts/make-oidpool exe/scripts/split-pool \
	       exe/scripts/copy-pool exe/scripts/merge-indexes \
	       exe/scripts/fdpkg

CONFDIRS=$(DESTDIR)@config_dir@ $(DESTDIR)@config_dir@/config $(DESTDIR)@share_dir@ \
	$(DESTDIR)@builtin_module_dir@ $(DESTDIR)@builtin_safe_module_dir@ \
	$(DESTDIR)@local_module_dir@ $(DESTDIR)@local_safe_module_dir@

CLEANDIRS=include/framerd src/drivers/headers 		\
	src/lisp src/apply src/storage src/drivers	\
	src/eval src/prims				\
	src/text src/web src/extmods			\
	src/cmodules					\
	src/cmodules/ext/sundown 			\
	src/cmodules/ext/tidy5 				\
	etc

FRAMERD_HEADERS= \
	$(LISP_HEADERS) $(STORAGE_HEADERS) \
	$(APPLY_HEADERS) $(SCHEME_HEADERS) \
	$(DRIVERS_H) $(SRC_HEADERS)

FRAMERD_SOURCES=\
	src/lisp/cons.c src/lisp/oids.c src/lisp/symbols.c           		\
	src/lisp/copy.c src/lisp/recycle.c src/lisp/misctypes.c       		\
        src/lisp/compare.c src/lisp/walk.c src/lisp/fcnids.c			\
	src/lisp/choices.c src/lisp/sequences.c					\
	src/lisp/tables.c src/lisp/compounds.c src/lisp/consblocks.c		\
        src/lisp/bufio.c src/lisp/dtread.c src/lisp/dtread.c 			\
	src/lisp/parse.c src/lisp/unparse.c src/lisp/lisp.c 			\
	src/support/buildinfo.c src/support/sourcebase.c			\
	src/support/support.c src/support/config.c src/support/posix.c		\
	src/support/errobjs.c src/support/logging.c src/support/getopt.c	\
	src/support/startup.c src/support/fluid.c src/support/signals.c		\
	src/apply/apply.c src/apply/stacks.c src/apply/lexenv.c 		\
	src/apply/ffi.c								\
	src/storage/storage.c src/storage/streams.c src/storage/hashdtype.c	\
	src/storage/drivers.c src/storage/indexes.c src/storage/pools.c		\
	src/storage/oidstore.c  src/storage/frames.c src/storage/slotindexes.c  \
	src/storage/aggregates.c src/storage/cachecall.c src/storage/methods.c	\
	src/storage/alcor.c src/storage/compress.c src/storage/threadcache.c  	\
	src/storage/bloom.c src/storage/dtproc.c src/storage/dtcall.c      	\
	src/storage/ipeval.c 	       						\
	src/drivers/builtin_drivers.c  						\
	src/drivers/filepool.c src/drivers/oidpool.c 				\
	src/drivers/bigpool.c 							\
	src/drivers/fileindex.c src/drivers/hashindex.c				\
	src/storage/extindex.c src/storage/tempindex.c				\
	src/storage/mempool.c src/storage/extpool.c				\
	src/drivers/netpool.c src/drivers/netindex.c 				\
	src/storage/procpool.c src/storage/procindex.c 				\
	src/drivers/memindex.c							\
	src/drivers/netpool.c src/drivers/netindex.c				\
	src/eval/eval.c src/eval/opcode_defs.c src/eval/opcode_names.h		\
	src/eval/options.c src/eval/appenv.c					\
	src/eval/testops.c src/eval/debug.c					\
	src/eval/binders.c src/eval/lambda.c 					\
	src/eval/macros.c src/eval/errfns.c     				\
	src/eval/conditionals.c src/eval/iterators.c               		\
        src/eval/threads.c src/eval/quasiquote.c src/eval/struct_eval.c		\
	src/eval/modules.c src/eval/load.c src/eval/reflection.c 		\
	src/eval/compoundfns.c 							\
	src/eval/coreops.c                  					\
	src/eval/arith.c src/eval/side-effects.c              			\
	src/prims/dbprims.c 							\
	src/prims/logprims.c							\
	src/prims/portprims.c							\
	src/prims/streamprims.c                    				\
	src/prims/tableprims.c src/eval/choiceops.c               		\
	src/prims/seqprims.c src/prims/stringprims.c                 		\
	src/prims/fileprims.c src/prims/driverprims.c                		\
	src/eval/loader.c                                            		\
	src/prims/timeprims.c src/prims/sysprims.c 				\
	src/prims/extdbprims.c                    				\
	src/eval/reqstate.c                                          		\
	src/web/fdweb.c src/web/json.c src/web/ldns.c            		\
	src/web/xmloutput.c src/web/xmlinput.c src/web/xmldata.c 		\
	src/web/xmleval.c src/web/cgiexec.c src/web/htmlout.c 			\
	src/web/uriprims.c src/web/mime.c src/web/email.c src/web/curl.c	\
	src/text/texttools.c src/text/match.c                			\
	src/text/porter.c src/text/phonetic.c                			\
	src/exe/fdconsole.c                                            		\
	src/exe/fdexec.c src/exe/fdbatch.c                             		\
	src/exe/fdservlet.c src/exe/fdcgiexec.c src/exe/fdserver.c

CMODULE_SOURCES=\
	src/cmodules/odbc.c src/cmodules/sqlite.c 				\
	src/cmodules/mysql.c src/cmodules/mongodb.c  				\
	src/cmodules/leveldb.c src/cmodules/rocksdb.c  				\
	src/cmodules/ziptools.c src/cmodules/libarchive.c			\
	src/cmodules/tidy.c src/cmodules/sundown.c 				\
	src/cmodules/hyphenate.c src/cmodules/hunspell.c 			\
	src/cmodules/qrcode.c src/cmodules/exif.c src/cmodules/imagick.c	\
	src/cmodules/gperftools.c 						\
	src/cmodules/crypto.c

STATIC_LIBS=lib/libfdcore@suffix@.a 	\
	lib/libfdstorage@suffix@.a	\
        lib/libfddbserv@suffix@.a 	\
	lib/libfddrivers@suffix@.a  	\
	lib/libfdscheme@suffix@.a 	\
	lib/libfdweb@suffix@.a 		\
	lib/libtexttools@suffix@.a

SHARED_LIBS=lib/libfdcore@suffix@.@shared_suffix@  		\
	lib/libfdstorage@suffix@.@shared_suffix@        	\
        lib/libfddrivers@suffix@.@shared_suffix@    		\
	lib/libfddbserv@suffix@.@shared_suffix@     		\
	lib/libfdscheme@suffix@.@shared_suffix@    		\
	lib/libfdweb@suffix@.@shared_suffix@       		\
	lib/libtexttools@suffix@.@shared_suffix@		\
	lib/libfdcore@suffix@.@mshared_suffix@  		\
	lib/libfdstorage@suffix@.@mshared_suffix@        	\
        lib/libfddrivers@suffix@.@mshared_suffix@    		\
	lib/libfddbserv@suffix@.@mshared_suffix@     		\
	lib/libfdscheme@suffix@.@mshared_suffix@    		\
	lib/libfdweb@suffix@.@mshared_suffix@       		\
	lib/libtexttools@suffix@.@mshared_suffix@

SCHEME_MODULES=src/extmods/*.scm \
	src/extmods/aws/*.scm \
	src/extmods/facebook/*.scm src/extmods/google/*.scm \
	src/extmods/paypal/*.scm src/extmods/twitter/*.scm \
	src/extmods/dropbox/*.scm src/extmods/twilio/*.scm \
	src/extmods/misc/*.scm src/extmods/tests/*.scm \
	src/extmods/safe/domutils/*.scm src/extmods/safe/knodules/*.scm \
	src/extmods/safe/textindex/*.scm src/extmods/safe/jwt/*.scm \
	src/beingmeta/chopper/*.scm src/beingmeta/morph/*.scm \
	src/beingmeta/gnosys/*.scm

# These might be neccessary on MacOS
CMODULE_DEPENDS=lib/libfdcore@suffix@.@shared_suffix@	\
	lib/libfdstorage@suffix@.@shared_suffix@ 	\
	lib/libfdstorage@suffix@.@shared_suffix@ 	\
	 lib/libfdscheme@suffix@.@shared_suffix@

ALL=testbin exe cmodules @TAGS@

# Targets

default: @DEFAULTMAKETARGET@

update: .buildmode
	@if test -f .malloc && test -f .buildmode; then \
	  echo "Updating" $(shell cat .buildmode) "build linked with" \
		$(shell cat .malloc); \
	fi;
	@+make -s `cat .buildmode`
normal:
	@echo Building NORMAL configuration
	@if test -f .malloc; then \
	  echo With $(shell cat .malloc) malloc; fi;
	@+make -s testbin exe cmodules etc @TAGS@
debugging:
	@echo Building DEBUGGING configuration
	@if test -f .malloc; then \
	  echo With $(shell cat .malloc) malloc; fi;
	@+make -s XCFLAGS="@debugcflags@ -O0 -Wall -Wno-unknown-pragmas $(XCFLAGS)"	\
	          XLDFLAGS="@debugldflags@ $(XLDFLAGS)"		\
	          XOPTFLAGS="-O0" OPTFLAGS="-O0" 		\
		  XLIBS="@debuglibs@ $(XLIBS)" 			\
	  testbin exe cmodules etc @TAGS@
optimizing:
	@echo Building OPTIMIZING configuration
	@if test -f .malloc; then \
	  echo With $(shell cat .malloc) malloc; fi;
	@+make -s XCFLAGS="-O3" testbin exe cmodules etc @TAGS@
nitpicking:
	@echo Building NITPICKING configuration
	@if test -f .malloc; then \
	  echo With $(shell cat .malloc) malloc; fi;
	@+make -s XCFLAGS="-Wall -Wno-unknown-pragmas ${XCFLAGS}" testbin exe cmodules etc @TAGS@

all: testbin debug-exe exe cmodules etc i18n @TAGS@
packaged: exe cmodules etc i18n

fresh: clean
	make -s update

# Handy targets

debug:
	@if test $(BUILDMODE) != "debugging"; then echo debugging > .buildmode; fi
	@make -s `cat .buildmode`
nodebug standard usable working:
	@if test $(BUILDMODE) != "normal"; then echo normal > .buildmode; fi
	@make -s `cat .buildmode`
nitpick:
	@if test $(BUILDMODE) != "nitpicking"; then echo nitpicking > .buildmode; fi
	@make -s `cat .buildmode`
fast:
	@if test $(BUILDMODE) != "optimizing"; then echo optimizing > .buildmode; fi
	@make -s `cat .buildmode`
.buildmode:
	@echo normal > .buildmode
showbuildmode showmode showbuild: .buildmode
	@cat .buildmode
cleandebug: clean
	make debug

# configure/autoconf stuff

makefile: makefile.in config.status
	if test -x ./config.status; then ./config.status; fi
./config.status: configure
	if test -x ./config.status; then ./config.status --recheck; fi
configure: configure.ac etc/release
	@if test -f .staticautoconf; then \
	    echo "WARNING: configure may be out of date"; \
	else echo "REBUILDING configure"; autoconf; fi
include/framerd/config.h: include/framerd/config.h.in
	if test -x ./config.status; then ./config.status; fi
	touch $@
include/framerd/fdsource.h: include/framerd/fdsource.h.in
	if test -x ./config.status; then ./config.status; fi
	touch $@

tests/lisp/makefile: tests/lisp/makefile.in ./config.status
	./config.status
tests/storage/makefile: tests/storage/makefile.in ./config.status
	./config.status
tests/makefile: tests/makefile.in ./config.status
	./config.status
tests/lisp/.gdbinit: tests/lisp/.gdbinit.in ./config.status
	./config.status
tests/storage/.gdbinit: tests/storage/.gdbinit.in ./config.status
	./config.status
dbg/.gdbinit: dbg/.gdbinit.in ./config.status
	./config.status
exe/.gdbinit: exe/.gdbinit.in ./config.status
	./config.status

etc: etc/logrotate etc/install-script etc/framerd-rc.d etc/logrotate    \
        etc/fdconfig etc/fdsetconfig etc/fdgetconfig                    \
        etc/fdjob etc/fdsignal etc/fdsignal                             \
        tests/lisp/.gdbinit tests/storage/.gdbinit dbg/.gdbinit         \
        exe/.gdbinit

# Fileinfo gets version-related information about a file to pass in
# with -D

@abs_top_srcdir@/fileinfo: etc/fileinfo.c
	$(CC) -o @abs_top_srcdir@/fileinfo etc/fileinfo.c

# Makes everything and then sudoes the install, keeping build files
# non-root

suinstall:
	make all
	@$(SUDO) make install
dbginstall:
	make XCFLAGS="-O0" all
	@$(SUDO) make install

# Make rules

%.o: %.c @abs_top_srcdir@/fileinfo ${CONFIG_HDRS}
	@$(CC) $(CFLAGS) @definefileinfo@ -o $@ -c $<
	@$(MSG) CC $@ $<

exe/scripts/%: src/scripts/%.scm
	@$(ECHO) "#!"@prefix@/bin/fdexec | cat - $< > $@
	@chmod a+x $@
	@$(MSG) MAKESCRIPT $@ $<

exe/%@suffix@: src/exe/%.c ${CONFIG_HDRS}
	$(CC) $(CFLAGS) $(LDFLAGS) $(EXEFLAGS)                  \
		-o $@ $<                                           \
		-lfddbserv@suffix@                 	 	   \
		@xdynamic_scheme_libs@                             \
		-ltexttools@suffix@ -lfdscheme@suffix@ \
		-lfddrivers@suffix@ -lfdstorage@suffix@ -lfdcore@suffix@ \
	        -lu8stdio $(LIBS) $(EXELIBS)
	@$(MSG) MKEXE $@ $<

src/cmodules/%.o: src/cmodules/%.c ${CONFIG_HDRS}
	@$(CC) $(CFLAGS) -o $@ -c $< ${MODLIBS}
	@$(MSG) CC_MODULE  $@ $<
lib/framerd/%.so: src/cmodules/%.o # ${CMODULE_DEPENDS}
	@$(MKSO) -L./lib -L./ -o $@ $< ${MODLIBS}
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO  $@ $<
lib/framerd/%.dylib: src/cmodules/%.o ${CMODULE_DEPENDS}
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) ${MODLIBS} -o $@ $< 
	@$(MSG) MACLIBTOOL  $@ $<
lib/framerd/%.@FDMAJOR@.dylib: lib/framerd/%.dylib
	@ln -sf $(*F).dylib $@

dbg/%: src/exe/%.c $(STATIC_LIBS)
	@echo MKEXE_DEBUG $@
	$(CC) $(TEST_CFLAGS) -o $@ $^ 		\
	      @STATICLDFLAGS@ $(TEST_LDFLAGS) $(TEST_EXEFLAGS) 	\
	      -lu8stdio -lu8syslog 		\
	      $(LIBS) $(EXELIBS)
dbg/%: ${REVISION_H} ${CONFIG_H} src/exe/main.h src/exe/webcommon.h

etc/%: etc/%.in ./config.status
	@echo "Configuring $@"
	@./config.status

# We can selectively link some executables statically to avoid 
# library dependencies with programs which will typicall run as daemons
static/%@suffix@: src/exe/%.c $(STATIC_LIBS) ${REVISION_H} ${CONFIG_H}
	@echo MKEXE_STATIC $@
	$(CC) $(STATIC_CFLAGS) -o $@ $^ $(STATIC_LDFLAGS) -lu8stdio -lu8syslog $(LIBS) $(EXELIBS)
	@$(MSG) MKEXE_STATIC $@

lib/%@suffix@.a:
	@$(MKSTATIC) $@ $^
	@$(MSG) MKSTATIC $@
lib/%@suffix@.so.@FDMAJOR@: lib/%@suffix@.so
	@ln -sf $(*F).so $@
lib/%@suffix@.so:
	@$(MKSO) -Wl,-soname=$(@F).@FDMAJOR@ -Wl,--as-needed -L./lib -L./ \
		-o $@ $^ -lu8 $(MODLIBS)
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@echo MKSO $@
lib/%@suffix@.@FDMAJOR@.dylib: lib/%@suffix@.dylib
	@ln -sf $(*F).dylib $@
lib/%@suffix@.dylib:
	@$(MACLIBTOOL) -install_name @rpath/lib/`basename $(@F) .dylib`.@FDMAJOR@.dylib $(DYLIB_FLAGS) -o $@ $^
	@ln -sf $(@F) $(@D)/`basename $(@F) .dylib`.@FDMAJOR@.dylib
	@$(MSG) MACLIBTOOL $@

$(LIBINSTALLDIR)/%.a: lib/%.a
	@$(SYSINSTALL) @install_dir_opts@ $(LIBINSTALLDIR)
	@$(SYSINSTALL) @install_file_opts@ $< $(LIBINSTALLDIR)
	@$(MSG) INSTALL $@

$(LIBINSTALLDIR)/%@suffix@.@vshared_suffix@: lib/%@suffix@.@shared_suffix@
	@echo Installing $@
	@$(SYSINSTALL) -d $(@D)
	@$(SYSINSTALL) $< $@
$(LIBINSTALLDIR)/%@suffix@.@mmshared_suffix@: $(LIBINSTALLDIR)/%@suffix@.@vshared_suffix@
	@$(SUINSTALL) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@
$(LIBINSTALLDIR)/%@suffix@.@mshared_suffix@: $(LIBINSTALLDIR)/%@suffix@.@vshared_suffix@
	@$(SUINSTALL) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@
$(LIBINSTALLDIR)/%@suffix@.@shared_suffix@: $(LIBINSTALLDIR)/%@suffix@.@vshared_suffix@
	@$(SUINSTALL) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@

${CMODULES}/%@suffix@.@vshared_suffix@: lib/framerd/%@suffix@.@shared_suffix@
	@echo Installing $@
	@$(SYSINSTALL) -d $(@D)
	@$(SYSINSTALL) $< $@
${CMODULES}/%@suffix@.@mmshared_suffix@: ${CMODULES}/%@suffix@.@vshared_suffix@
	@$(SUINSTALL) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@
${CMODULES}/%@suffix@.@mshared_suffix@: ${CMODULES}/%@suffix@.@vshared_suffix@ 
	@$(SUINSTALL) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG)  Linking $@ to $(*F).@vshared_suffix@
${CMODULES}/%@suffix@.@shared_suffix@: ${CMODULES}/%@suffix@.@vshared_suffix@ 
	@make -s ${CMODULES}/$(*F)@suffix@.@mmshared_suffix@ \
		 ${CMODULES}/$(*F)@suffix@.@mshared_suffix@
	@$(SUINSTALL) ln -sf $(*F).@vshared_suffix@ $@
	@$(MSG) Linking $@ to $(*F).@vshared_suffix@

$(BININSTALLDIR)/%: exe/%

$(BININSTALLDIR)/%: src/scripts/%.scm
	@$(MSG) Installing script $@
	@etc/install-script $<

$(DESTDIR)@config_dir@/boot/%: etc/% $(DESTDIR)@config_dir@/boot
	@$(SYSINSTALL) @install_file_opts@ $< $(DESTDIR)@config_dir@/boot

dist/%.changelog: dist/equivs.changelog
	etc/make-equivs-changelog `basename $@ .changelog` dist/equivs.changelog > $@

src/cmodules/ext/sundown/%.o: src/cmodules/ext/sundown/%.c $(SUNDOWN_H_FILES)
	@$(CC) $(CFLAGS) -I./src/cmodules/ext/sundown/ -o $@ -c $<
	@$(MSG) CC "(SUNDOWN)" $@

src/cmodules/ext/tidy5/%.o: src/cmodules/ext/tidy5/%.c $(SUNDOWN_H_FILES)
	@$(CC) $(CFLAGS) -I./src/cmodules/ext/tidy5/ -o $@ -c $<
	@$(MSG) CC "(TIDY5)" $@

exe/fdexec@suffix@ exe/fdbatch@suffix@ exe/fdconsole@suffix@: \
	$(STATIC_LIBS) $(SHARED_LIBS)
exe/fdcgiexec@suffix@ exe/fdserver@suffix@ exe/fdservlet@suffix@: \
	$(STATIC_LIBS) $(SHARED_LIBS)
exe/fdcgiexec@suffix@ exe/fdservlet@suffix@: src/exe/webcommon.h

# Custom rules for making include files with CSS headers
src/web/htmlout.o: src/web/backtrace_css.h src/web/backtrace_js.h src/web/backtrace.css src/web/backtrace.js
src/web/backtrace_css.h: src/web/backtrace.css etc/text2include
	@echo Generating $@ from text in $<
	@./etc/text2include FD_BACKTRACE_CSS $< $@
src/web/backtrace_js.h: src/web/backtrace.js etc/text2include
	@echo Generating $@ from text in $<
	@./etc/text2include FD_BACKTRACE_JS $< $@

# This can be helpful for some debugging 
etc/usememory: etc/usememory.c

# Library targets

libs: static-libs @SHARED_LIB_TARGET@
static-libs: $(STATIC_LIBS)
shared-libs: $(SHARED_LIBS)

exe: $(EXECUTABLES) exe/.gdbinit
static-exe: $(STATIC_EXECUTABLES)
debug-exe: $(DEBUG_EXECUTABLES) dbg/.gdbinit

testbin: constestbin dbtestbin debug-exe etc/usememory
constestbin: libs tests/lisp/makefile tests/lisp/.gdbinit
	@make -s XCFLAGS="$(XCFLAGS)" XLDFLAGS="$(XLDFLAGS)" XLIBS="$(XLIBS)" \
		-C tests/lisp
dbtestbin: libs tests/storage/makefile tests/storage/.gdbinit
	@make -s  XCFLAGS="$(XCFLAGS)" XLDFLAGS="$(XLDFLAGS)" XLIBS="$(XLIBS)" \
		-C tests/storage
cmodules: dbmodules @CMODULES@
dbmodules: @DBMODULES@

dbg/fdservlet.webuser: dbg/fdservlet
	@echo "Making" $@
	@cp dbg/fdservlet dbg/fdservlet.webuser
	@sudo chown @webuser@:@admin_group@ dbg/fdservlet.webuser
	@sudo chmod ug+s dbg/fdservlet.webuser

# Uninstall

LIBBASE=libfdcore libfdstorage libfddrivers libfddbserv \
	libfdscheme libfdweb libtexttools

uninstall-core:
	./etc/uninstall $(DESTDIR)$(BININSTALLDIR) "" $(EXECUTABLES) fdcgiexec
	./etc/uninstall $(DESTDIR)$(BININSTALLDIR) "" $(SHELL_SCRIPTS)
	./etc/uninstall $(DESTDIR)$(BININSTALLDIR) "" $(SCHEME_SCRIPTS)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.a" $(LIBBASE)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.@FDVERSION@.@shared_suffix@" $(LIBBASE)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.@FDMAJOR@.@shared_suffix@" $(LIBBASE)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.@FDMAJOR@.@FDMINOR@.@shared_suffix@" $(LIBBASE)
	./etc/uninstall $(DESTDIR)$(LIBINSTALLDIR) "@suffix@.@shared_suffix@" $(LIBBASE)
	rm -rf $(DESTDIR)${CMODULES}
uninstall-all: uninstall-core
	rm -rf $(DESTDIR)@share_dir@ $(DESTDIR)@config_dir@ \
		$(DESTDIR)@local_config@ $(DESTDIR)@shared_config@ \
		$(DESTDIR)@builtin_module_dir@ \
		$(DESTDIR)@builtin_safe_module_dir@
uninstall: uninstall-core
	@if (test -d $(DESTDIR)@share_dir@); then \
	  $(MSG) $(DESTDIR)@share_dir@ "still exists"; fi
	@if (test -d $(DESTDIR)@config_dir@); then \
	  $(MSG) $(DESTDIR)@config_dir@ "still exists"; fi
	@if (test -d $(DESTDIR)@local_config@); then \
	  $(MSG) $(DESTDIR)@local_config@ "still exists"; fi
	@if (test -d $(DESTDIR)@shared_config@); then \
	  $(MSG) $(DESTDIR)@shared_config@ "still exists"; fi
	@if (test -d $(DESTDIR)@module_dir@); then \
	  $(MSG) $(DESTDIR)@module_dir@ "still exists"; fi
	@if (test -d $(DESTDIR)@safe_module_dir@); then \
	  $(MSG) $(DESTDIR)@safe_module_dir@ "still exists"; fi

# Utility targets

TAGS: makefile.in configure.ac include/framerd/config.h.in		\
		tests/lisp/*.c tests/storage/*.c  			\
		src/exe/*.c src/exe/*.h include/framerd/*.h 		\
		src/lisp/*.c src/support/*.c src/apply/*.c		\
		src/storage/*.c src/drivers/*.c 			\
		src/eval/*.c src/prims/*.c     				\
		src/text/*.c src/web/*.c 				\
		src/cmodules/*.c 					\
		src/libscm/*.scm src/libscm/*/*.scm			\
		include/framerd/components/*.h				\
		etc/*.in ${SRC_HEADERS} 				\
		dbg/.gdbinit.in tests/*.scm 
	@echo Building TAGS file
	@etags makefile.in configure.ac 		\
		include/framerd/config.h.in     	\
	        tests/*/*.in tests/*.in dbg/*.in 	\
		etc/*.in include/framerd/*.h 		\
		include/framerd/components/*.h		\
		${SRC_HEADERS};
	@etags -o TAGS -a src/exe/*.c src/exe/*.h 
	@etags -o TAGS -a src/lisp/*.c src/support/*.c src/apply/*.c 
	@etags -o TAGS -a src/storage/*.c
	@etags -o TAGS -a src/drivers/*.c src/drivers/headers/*.h
	@etags -o TAGS -a src/eval/*.c src/prims/*.c
	@etags -o TAGS -a src/web/*.c src/text/*.c;
	@etags -o TAGS -a tests/lisp/*.c tests/storage/*.c tests/*.scm;
	@etags -o TAGS -a src/cmodules/*.c;
	@etags -o TAGS -a src/scripts/*.scm;
	@find src/libscm/ -name "*.scm" -type f | grep -v /module.scm | \
		xargs etags -a -o TAGS;

CTAGS: makefile.in configure.ac include/framerd/config.h.in	\
	tests/lisp/*.c tests/storage/*.c tests/*.c	\
	src/lisp/*.c src/support/*.c src/apply/*.c src/storage/*.c 		\
	src/eval/*.c src/prims/*.c src/web/*.c src/text/*.c 	\
	include/framerd/*.h ${SRC_HEADERS} etc/*.in 		\
	include/framerd/components/*.h				\
	src/exe/*.c src/cmodules/*.c
	@echo Building C TAGS file
	@etags -o CTAGS 
	      makefile.in configure.ac include/framerd/config.h.in      \
	      tests/lisp/*.c tests/apply/*.c tests/storage/*.c 		\
	      tests/eval/*.c tests/prims/*.c src/exe/*.c src/exe/*.h	\
	      src/lisp/*.c src/support/*.c src/storage/*.c 		\
	      src/eval/*.c src/prims/*.c src/web/*.c src/text/*.c	\
	      src/cmodules/*.c src/cmodules/*.h				\
	      include/framerd/*.h etc/*.in 				\
	      include/framerd/components/*.h				\
	      ${SRC_HEADERS}

CSOURCETAGS: src/lisp/*.c src/support/*.c src/apply/*.c	\
	src/storage/*.c src/eval/*.c src/prims/*.c 	\
	src/web/*.c src/text/*.c 			\
	src/drivers/*.c src/drivers/headers/*.h		\
	src/exe/*.c src/exe/*.h
	@echo Building FRAMERD_SOURCE TAGS file
	@etags -o $@ $^

SCHEMETAGS: ${SCHEME_MODULES}
	@echo Building SCHEMETAGS file
	@rm -f SCHEMETAGS
	@# We skip module.scm files because they are always links
	@#  to other files (with more distinctive names)
	@find src/libscm -name "*.scm" -readable | \
		grep -v module.scm | \
		xargs etags -o SCHEMETAGS -a
	@find src/extmods -name "*.scm" -readable | \
		grep -v module.scm | \
		xargs etags -o SCHEMETAGS -a
	@ls -l SCHEMETAGS

profile-clean:
	@find . -name "*.gcda" -writable | xargs rm -f
	@find . -name "*.gcno" -writable | xargs rm -f
	@find . -name "*.gcov" -writable | xargs rm -f
	@find . -name "*.bb" -writable | xargs rm -f
	@find . -name "*.bbg" -writable | xargs rm -f
	@find . -name "*.da" -writable | xargs rm -f
	@find . -name "gmon.out" -writable | xargs rm -f
tidy: profile-clean
	@for dir in ${CLEANDIRS}; do \
	  rm -f $${dir}/*~ $${dir}/*.o; \
	done
	make testclean
	rm -f config.log
clean: tidy
	rm -f .buildmode
	@for dir in ${CLEANDIRS}; do rm -f ${dir}/*.o; done
	rm -rf etc/*.o etc/.libs
	rm -f lib/*.a lib/*@suffix@.so lib/*.dylib
	rm -f lib/*@suffix@.so.*
	rm -f lib/framerd/*@suffix@.so lib/framerd/*@suffix@.so.* 
	rm -f lib/framerd/*.dylib
	rm -f exe/fdexec@suffix@ exe/fdbatch@suffix@
	rm -f exe/fdservlet@suffix@ exe/fdserver@suffix@
	rm -f exe/fdconsole@suffix@ exe/fdcgiexec@suffix@
	rm -f TAGS
	cd tests/lisp; make -s clean
	cd tests/storage; make -s clean
	cd tests; make -s clean
	find . -name "*.dSYM" -writable | xargs rm -rf
distclean: clean
	rm -f makefile config.log config.status config.cache
	rm -f tests/lisp/makefile tests/storage/makefile tests/makefile
	rm -f tests/lisp/.gdbinit tests/storage/.gdbinit tests/.gdbinit
	rm -f dbg/gdbinit
	rm -f etc/fdgetconfig etc/fdsetconfig etc/framerd-rc.d
	rm -f exe/.gdbinit include/framerd/config.h include/framerd/revision.h

commit:
	git commit
	touch makefile
pull:
	git pull
	touch makefile

# Custom dependencies

src/eval/binders.o src/eval/conditionals.o src/eval/iterators.o: \
	src/eval/eval_internals.h
src/eval/eval.o: src/eval/eval_internals.h src/eval/opcode_defs.c src/eval/opcode_names.h

# Custom rules

src/lisp/dtread.o src/lisp/dtwrite.o src/lisp/bufio.o : XCFLAGS="${XOPTFLAGS}"
src/lisp/choices.o : XCFLAGS="${XOPTFLAGS}"
src/lisp/tables.o src/storage/bloom.o src/lisp/sequences.o : XCFLAGS="${XOPTFLAGS}"
src/lisp/numbers.o src/lisp/compare.o : XCFLAGS="${XOPTFLAGS}"
src/apply/apply.o : XCFLAGS="${XOPTFLAGS}"
src/storage/streams.o src/storage/pools.o src/storage/indexes.o : XCFLAGS="${XOPTFLAGS}"
src/eval/eval.o src/eval/choiceops.o : XCFLAGS="${XOPTFLAGS}"
src/eval/conditionals.o src/eval/iterators.o : XCFLAGS="${XOPTFLAGS}"
src/eval/lambda.o : XCFLAGS="${XOPTFLAGS}"
src/text/matcher.o src/text/texttools.o : XCFLAGS="${XOPTFLAGS}"

# Library targets

lib/libfdcore@suffix@.a: $(LISP_OBJS) $(SUPPORT_OBJS) $(APPLY_OBJS)
lib/libfdcore@suffix@.so: $(LISP_OBJS) $(SUPPORT_OBJS) $(APPLY_OBJS)
lib/libfdcore@suffix@.dylib: $(LISP_OBJS) $(SUPPORT_OBJS) $(APPLY_OBJS)

lib/libfdstorage@suffix@.a: $(STORAGE_OBJS)
lib/libfdstorage@suffix@.so: $(STORAGE_OBJS) lib/libfdcore@suffix@.so
lib/libfdstorage@suffix@.dylib: $(STORAGE_OBJS) lib/libfdcore@suffix@.dylib

lib/libfddrivers@suffix@.a: $(DRIVER_OBJS)
lib/libfddrivers@suffix@.so: $(DRIVER_OBJS) \
	lib/libfdcore@suffix@.so lib/libfdstorage@suffix@.so
lib/libfddrivers@suffix@.dylib: $(DRIVER_OBJS) \
	lib/libfdstorage@suffix@.dylib lib/libfdcore@suffix@.dylib

lib/libfddbserv@suffix@.a: $(DBSERV_OBJS)
lib/libfddbserv@suffix@.so: $(DBSERV_OBJS) \
	lib/libfdcore@suffix@.so lib/libfdstorage@suffix@.so \
	lib/libfddrivers@suffix@.so
lib/libfddbserv@suffix@.dylib: $(DBSERV_OBJS) 	\
	lib/libfdscheme@suffix@.dylib         	\
	lib/libfddrivers@suffix@.dylib		\
	lib/libfdstorage@suffix@.dylib		\
	lib/libfdcore@suffix@.dylib
	@$(MACLIBTOOL) -install_name @rpath/lib/`basename $(@F) .dylib`.@FDMAJOR@.dylib $(DYLIB_FLAGS) -o $@ $^
	@$(MSG) MACLIBTOOL $@

lib/libfdscheme@suffix@.a: $(SCHEME_OBJS)
lib/libfdscheme@suffix@.so: $(SCHEME_OBJS) 		\
	lib/libfdcore@suffix@.so lib/libfdstorage@suffix@.so	\
	lib/libfddrivers@suffix@.so
lib/libfdscheme@suffix@.dylib: $(SCHEME_OBJS) 			\
	lib/libfdcore@suffix@.dylib  lib/libfdstorage@suffix@.dylib	\
        lib/libfddrivers@suffix@.dylib

lib/libfdweb@suffix@.a: $(WEB_OBJS)
lib/libfdweb@suffix@.so: $(WEB_OBJS) \
	lib/libfdcore@suffix@.so \
	lib/libfdstorage@suffix@.so \
	lib/libfddrivers@suffix@.so \
	lib/libfdscheme@suffix@.so
lib/libfdweb@suffix@.dylib: $(WEB_OBJS) \
	lib/libfdscheme@suffix@.dylib     \
	lib/libfddrivers@suffix@.dylib     \
	lib/libfdstorage@suffix@.dylib         \
        lib/libfdcore@suffix@.dylib
	@$(MACLIBTOOL) -install_name \
		@rpath/lib/`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ $(WEB_OBJS)
	@$(MSG) MACLIBTOOL $@

lib/libtexttools@suffix@.a: $(TEXT_OBJS)
lib/libtexttools@suffix@.so: $(TEXT_OBJS) \
	lib/libfdcore@suffix@.so lib/libfdstorage@suffix@.so \
	lib/libfdstorage@suffix@.so lib/libfdscheme@suffix@.so
lib/libtexttools@suffix@.dylib: $(TEXT_OBJS) \
	lib/libfdscheme@suffix@.dylib \
	lib/libfddrivers@suffix@.dylib \
	lib/libfdstorage@suffix@.dylib \
	lib/libfdcore@suffix@.dylib
	@$(MACLIBTOOL) -install_name \
		@rpath/lib/`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ $(TEXT_OBJS)
	@$(MSG) MACLIBTOOL $@

src/cmodules/mysql.o: src/cmodules/mysql.c ${CONFIG_HDRS}
	@$(CC) @MYSQL_CFLAGS@ $(CFLAGS)  -o $@ -c $<
	@$(MSG) CC "(MYSQL)" $@
lib/framerd/mysql.so: src/cmodules/mysql.o # ${CMODULE_DEPENDS}
	@$(MKSO) -L./ -L./lib \
		-o $@ $< @MYSQL_LDFLAGS@ # ${CMODULE_DEPENDS}
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO "(MYSQL)" $@
lib/framerd/mysql.dylib: src/cmodules/mysql.o ${CMODULE_DEPENDS}
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ src/cmodules/mysql.o @MYSQL_LDFLAGS@
	@$(MSG) MACLIBTOOL "(MYSQL)" $@

src/cmodules/mongodb.o: src/cmodules/mongodb.c ${CONFIG_HDRS} @MONGODB_BUNDLED@
	@$(CC) @MONGODB_CFLAGS@ $(CFLAGS)  -o $@ -c $<
	@$(MSG) CC "(MONGODB)" $@
lib/framerd/mongodb.so: src/cmodules/mongodb.o @MONGODB_BUNDLED@
	@$(MKSO) -L./ -L./lib@ -o $@ $< @MONGODB_LDFLAGS@
	@ln -sf $(@F) $(@D)/$(@F).4
	@$(MSG) MKSO "(MONGODB)" $@
lib/framerd/mongodb.dylib: src/cmodules/mongodb.o ${CMODULE_DEPENDS} @MONGODB_BUNDLED@
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ src/cmodules/mongodb.o @MONGODB_LDFLAGS@
	@$(MSG) MACLIBTOOL "(MONGODB)" $@

src/cmodules/imagick.o: src/cmodules/imagick.c ${CONFIG_HDRS}
	@$(CC) @IMAGICK_CFLAGS@ $(CFLAGS)  -o $@ -c $<
	@$(MSG) CC "(IMAGICK)" $@
lib/framerd/imagick.so: src/cmodules/imagick.o
	$(MKSO) -L./ -L./lib -o $@ $< @IMAGICK_LDFLAGS@
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO "(IMAGICK)" $@
lib/framerd/imagick.dylib: src/cmodules/imagick.o ${CMODULE_DEPENDS}
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ src/cmodules/imagick.o @IMAGICK_LDFLAGS@
	@$(MSG) MACLIBTOOL "(IMAGICK)" $@

src/cmodules/ziptools.o: src/cmodules/ziptools.c ${CONFIG_HDRS}
	@$(CC) $(CFLAGS) @LIBZIP_CFLAGS@ -o $@ -c $<
	@$(MSG) CC "(ZIPTOOLS)"  $@ $<
lib/framerd/ziptools.so: src/cmodules/ziptools.o
	@$(MKSO) -L./ -L./lib -o $@ $< @LIBZIP_LDFLAGS@
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO "(ZIPTOOLS)"  $@ $<
lib/framerd/ziptools.dylib: src/cmodules/ziptools.o ${CMODULE_DEPENDS}
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ $<
	@$(MSG) MACLIBTOOL "(ZIPTOOLS)" $@

src/cmodules/libarchive.o: src/cmodules/libarchive.c ${CONFIG_HDRS}
	@$(CC) $(CFLAGS) @LIBZIP_CFLAGS@ -o $@ -c $<
	@$(MSG) CC "(LIBARCHIVE)"  $@ $<
lib/framerd/libarchive.so: src/cmodules/libarchive.o
	@$(MKSO) -L./ -L./lib -o $@ $< -larchive
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO "(LIBARCHIVE)"  $@ $<
lib/framerd/libarchive.dylib: src/cmodules/libarchive.o ${CMODULE_DEPENDS}
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-o $@ $<
	@$(MSG) MACLIBTOOL "(LIBARCHIVE)" $@

lib/framerd/exif.so: src/cmodules/exif.o
	@$(MKSO) -L./ -L./lib -o $@ $^ $(MODLIBS) -lexif
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO $@
lib/framerd/exif.dylib: src/cmodules/exif.o ${CMODULE_DEPENDS}
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) \
		-lexif -o $@ $^
	@$(MSG) MACLIBTOOL $@

src/cmodules/crypto.o: src/cmodules/crypto.c
lib/framerd/crypto.so: src/cmodules/crypto.o
lib/framerd/crypto.dylib: src/cmodules/crypto.o ${CMODULE_DEPENDS}

lib/framerd/odbc.o: src/cmodules/odbc.c
lib/framerd/odbc.so: src/cmodules/odbc.o
lib/framerd/odbc.dylib: src/cmodules/odbc.o ${CMODULE_DEPENDS}
lib/framerd/odbc.so : MODLIBS="@ODBC_LIBS@"
lib/framerd/odbc.dylib : MODLIBS="@ODBC_LIBS@"

lib/framerd/sqlite.o: src/cmodules/sqlite.c
lib/framerd/sqlite.so: src/cmodules/sqlite.o
lib/framerd/sqlite.dylib: src/cmodules/sqlite.o ${CMODULE_DEPENDS}

lib/framerd/libarchive.o: src/cmodules/libarchive.c
lib/framerd/libarchive.so: src/cmodules/libarchive.o
lib/framerd/libarchive.dylib: src/cmodules/libarchive.o ${CMODULE_DEPENDS}

lib/framerd/qrcode.so : MODLIBS=-lqrencode -lpng
lib/framerd/qrcode.o: src/cmodules/qrcode.c
lib/framerd/qrcode.so: src/cmodules/qrcode.o
lib/framerd/qrcode.dylib: src/cmodules/qrcode.o ${CMODULE_DEPENDS}

lib/framerd/hyphenate.so : MODLIBS=-lhyphen
lib/framerd/hyphenate.o: src/cmodules/hyphenate.c
lib/framerd/hyphenate.so: src/cmodules/hyphenate.o
lib/framerd/hyphenate.dylib: src/cmodules/hyphenate.o ${CMODULE_DEPENDS}

lib/framerd/hunspell.so : MODLIBS=-lhunspell
lib/framerd/hunspell.o: src/cmodules/hunspell.c
lib/framerd/hunspell.so: src/cmodules/hunspell.o
lib/framerd/hunspell.dylib: src/cmodules/hunspell.o ${CMODULE_DEPENDS}

lib/framerd/zlib.so : MODLIBS="-lz"
lib/framerd/zlib.o: src/cmodules/zlib.c
lib/framerd/zlib.so: src/cmodules/zlib.o
lib/framerd/zlib.dylib: src/cmodules/zlib.o

lib/framerd/leveldb.so : MODLIBS="-lleveldb"
lib/framerd/leveldb.o: src/cmodules/leveldb.c
lib/framerd/leveldb.so: src/cmodules/leveldb.o
lib/framerd/leveldb.dylib: src/cmodules/leveldb.o ${CMODULE_DEPENDS}

lib/framerd/rocksdb.so : MODLIBS="-lrocksdb"
lib/framerd/rocksdb.o: src/cmodules/rocksdb.c
lib/framerd/rocksdb.so: src/cmodules/rocksdb.o
lib/framerd/rocksdb.dylib: src/cmodules/rocksdb.o ${CMODULE_DEPENDS}

lib/framerd/gperftools.so : MODLIBS="-lprofiler"
lib/framerd/gperftools.o: src/cmodules/gperftools.c
lib/framerd/gperftools.so: src/cmodules/gperftools.o
lib/framerd/gperftools.dylib: src/cmodules/gperftools.o ${CMODULE_DEPENDS}

lib/framerd/sundown.so: src/cmodules/sundown.c $(SUNDOWN_OBJECTS)
	@$(MKSO) $(CFLAGS) -o $@ src/cmodules/sundown.c $(SUNDOWN_OBJECTS)
	@$(MSG) MKSO  $@ $<
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
lib/framerd/sundown.dylib: \
	src/cmodules/sundown.c $(SUNDOWN_OBJECTS) ${CMODULE_DEPENDS}
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		${CFLAGS} -o $@ $(DYLIB_FLAGS) \
		src/cmodules/sundown.c $(SUNDOWN_OBJECTS)
	@$(MSG) MACLIBTOOL  $@ $<

lib/framerd/tidy.so: src/cmodules/tidy.c $(TIDY_OBJECTS)
	@$(MKSO) $(CFLAGS) -o $@ src/cmodules/tidy.c $(TIDY_OBJECTS)
	@$(MSG) MKSO  $@ $<
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
lib/framerd/tidy.dylib: \
	src/cmodules/tidy.c $(TIDY_OBJECTS) ${CMODULE_DEPENDS}
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		${CFLAGS} -o $@ $(DYLIB_FLAGS) \
		src/cmodules/tidy.c $(TIDY_OBJECTS)
	@$(MSG) MACLIBTOOL  $@ $<

# Parseltongue
lib/framerd/parseltongue.so: src/python/parseltongue.o
	@$(MKSO) -L./lib -L./ -o $@ $< ${MODLIBS} -l@PYTHON2_LIB@
	@ln -sf $(@F) $(@D)/$(@F).@FDMAJOR@
	@$(MSG) MKSO  $@ $<
lib/framerd/parseltongue.dylib: src/python/parseltongue.o ${CMODULE_DEPENDS}
	@$(MACLIBTOOL) -install_name \
		`basename $(@F) .dylib`.@FDMAJOR@.dylib \
		$(DYLIB_FLAGS) ${MODLIBS} -l@PYTHON2_LIB@ -o $@ $< 
	@$(MSG) MACLIBTOOL  $@ $<
lib/framerd/parseltongue.@FDMAJOR@.dylib: lib/framerd/parseltongue.dylib
	@ln -sf $(*F).dylib $@

src/python/parseltongue.o: src/python/parseltongue.c
	$(CC) "-I@PYTHON2_INCLUDE_DIR@" $(CFLAGS) -o $@ -c $< ${MODLIBS}
	@$(MSG) CC_PYTHON $@ $<


parseltongue: lib/framerd/parseltongue.@shared_suffix@

install-parseltongue: ${CMODULES}/parseltongue.@shared_suffix@ \
	${CMODULES}/parseltongue.@vshared_suffix@

# Internationalization stuff

$(LOCALEDIR)/%/LC_MESSAGES/framerd.mo: etc/intl/%.gmo
	@$(SUINSTALL) install -D $^ $@

etc/intl/framerd.pot:
	@XGETTEXT@ --from-code=utf-8 -dfdstorage -oetc/intl/framerd.pot -k_ \
		$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
etc/intl/%.po: etc/intl/framerd.pot
	@MSGMERGE@ -U $@ $<
etc/intl/%.gmo: etc/intl/%.po
	@MSGFMT@ $^ -o $@ 

install-i18n: $(LOCALEDIR)/fr/LC_MESSAGES/framerd.mo   \
		$(LOCALEDIR)/es/LC_MESSAGES/framerd.mo \
		$(LOCALEDIR)/nl/LC_MESSAGES/framerd.mo
i18n: etc/intl/fr.gmo etc/intl/nl.gmo etc/intl/es.gmo

# Packaging targets

rpms: dist/rpms.done
debian deb debs: dist/debs.done
debsource: dist/debsource.done

cleandist cleanrpms cleandeb rpmclean debclean: 
	rm -rf dist/rpms.done dist/rpms.ready
	rm -f dist/debs.signed dist/debs.built dist/debs.done
	rm -f dist/*.deb dist/*.tar dist/*.gz dist/*.dsc dist/*.changes dist/*.buildinfo
	find dist -name "*.rpm" -writable | xargs -r rm
	rm -rf staging/framerd*

debfresh freshdeb:
	make -s debclean
	rm -f include/framerd/revision.h; make include/framerd/revision.h
	make -s debian

debupdate:
	@if [ "${DEBNAME}" = "framerd_${APTVERSION}" ]; then 	\
	  echo "Debian build of FramerD is up to date"; 		\
	else make debfresh; fi;

# Creating staging areas from GIT

staging/framerd-@FDVERSION@: include/framerd/revision.h \
	$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
	@git archive --prefix=framerd-@FDVERSION@/ \
	            -o staging/framerd-@FDVERSION@.tar HEAD
	cd src/extmods; git archive --prefix=framerd-@FDVERSION@/src/extmods/ \
	            -o ../../staging/framerd_modules-@FDVERSION@.tar HEAD;
	cd staging; tar -xf framerd-@FDVERSION@.tar; rm framerd-@FDVERSION@.tar
	cd staging; tar -xf framerd_modules-@FDVERSION@.tar; rm framerd_modules-@FDVERSION@.tar;
	cp include/framerd/revision.h staging/framerd-@FDVERSION@/etc/revision.h;
	cp dist/framerd-@FDMAJOR@.@FDMINOR@.spec staging/framerd-@FDVERSION@/dist
staging/framerd_@FDVERSION@: include/framerd/revision.h \
	$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
	@git archive --prefix=framerd_@FDVERSION@/ \
	            -o staging/framerd_@FDVERSION@.tar HEAD;
	cd src/extmods; git archive --prefix=framerd_@FDVERSION@/src/extmods/ \
	            -o ../../staging/framerd_modules_@FDVERSION@.tar HEAD;
	cd staging; tar -xf framerd_@FDVERSION@.tar; rm framerd_@FDVERSION@.tar;
	cd staging; tar -xf framerd_modules_@FDVERSION@.tar; rm framerd_modules_@FDVERSION@.tar;
	cp include/framerd/revision.h staging/framerd_@FDVERSION@/etc/revision.h;
	cd staging; tar -czf $(DEBNAME).orig.tar.gz framerd_@FDVERSION@;
	mv staging/framerd_@FDVERSION@/dist/debian staging/framerd_@FDVERSION@/debian;
	etc/gitchangelog framerd ${CODENAME} < dist/debian/changelog \
	   > staging/framerd_@FDVERSION@/debian/changelog;
staging/framerd-@FDVERSION@.tar.gz: \
	$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
	make -s staging/framerd-@FDVERSION@
	tar -czf staging/framerd-@FDVERSION@.tar.gz -C staging framerd-@FDVERSION@
	cd staging; ln -s ${DEBNAME}.tar.gz framerd_@FDVERSION@.tar.gz

staging/framerd_@FDVERSION@.orig.tar.gz: \
	$(FRAMERD_SOURCES) $(CMODULE_SOURCES) $(FRAMERD_HEADERS)
	make -s staging/framerd_@FDVERSION@
	tar -czf staging/$(DEBNAME).orig.tar.gz -C staging framerd-@FDVERSION@
	cd staging; ln -s ${DEBNAME}.orig.tar.gz framerd_@FDVERSION@.orig.tar.gz

# RPM rules

dist/rpms.ready: staging/framerd-@FDVERSION@ \
	staging/framerd-@FDVERSION@.tar.gz
	@buildrpm@ $(RPMFLAGS)  			\
	   --define="_rpmdir $(RPMDIR)"			\
	   --define="_srcrpmdir $(RPMDIR)" 		\
	   --nodeps -ta 				\
	    staging/framerd-@FDVERSION@.tar.gz && 	\
	touch dist/rpms.ready
dist/rpms.done: dist/rpms.ready
	@if (test "x$(GPGID)" = "xnone"); then 			\
	    touch dist/rpms.done;				\
	elif (test "x$(GPGID)" = "x"); then 			\
	   echo "Enter passphrase for the RPM signing key:"; 	\
	   @rpm@ --addsign 					\
		--define="__gpg_sign_cmd $(RPMGPG)"		\
		$(RPMDIR)/framerd-@FDVERSION@-*.src.rpm 	\
		$(RPMDIR)/*/framerd*-@FDVERSION@-*.rpm; 	\
	   else 						\
	     echo "Enter passphrase for '$(GPGID)':"; 		\
	     @rpm@ --addsign --define="_gpg_name $(GPGID)" 	\
		--define="__gpg_sign_cmd $(RPMGPG)"		\
		$(RPMDIR)/framerd-@FDVERSION@*.src.rpm 		\
		$(RPMDIR)/*/framerd*-@FDVERSION@-*.rpm; 	\
	fi && touch dist/rpms.done;
	@ls -l $(RPMDIR)/framerd-@FDVERSION@-*.src.rpm \
		$(RPMDIR)/*/framerd*-@FDVERSION@-*.rpm;

rpmupdate update-rpms freshrpms: cleanrpms
	rm -f dist/rpms.done dist/rpms.ready
	make -s dist/rpms.done
dist/rpms.zip: dist/rpms.done
	@rm -f dist/rpms.zip
	@zip dist/rpms.zip \
		$(RPMDIR)/framerd*-@FDVERSION@-*.src.rpm \
		$(RPMDIR)/*/framerd-*-@FDVERSION@-*.rpm

# Rules for Debian building

dist/debs.built: staging/framerd_@FDVERSION@
	(cd staging/framerd_@FDVERSION@; \
	 dpkg-buildpackage -sa -us -uc -b -rfakeroot) && \
	touch dist/debs.built;
dist/debsource.built: staging/framerd_@FDVERSION@
	(cd staging/framerd_@FDVERSION@; \
	 dpkg-buildpackage -sa -us -uc -F -rfakeroot) && \
	touch dist/debs.built dist/debsource.built;

dist/debs.signed: dist/debs.built
	(cd staging; debsign -p${GPG} --re-sign -k${GPGID} 	\
		framerd_@FDVERSION@*.changes) && 		\
	(cd staging; cp framerd_@FDVERSION@*.tar.?z ../dist) && \
	(cd staging; mv framerd*_@FDVERSION@*.*               	\
			sysv-framerd_@FDVERSION@*.deb  		\
			upstart-framerd_@FDVERSION@*.deb  	\
			systemd-framerd_@FDVERSION@*.deb  	\
			libapache2-mod-fdserv_@FDVERSION@*.deb  \
			elpa-fdconsole_@FDVERSION@*.deb  \
			../dist) &&                             \
	touch dist/debs.signed;
dist/debsource.signed: dist/debsource.built
	(cd staging; debsign -p${GPG} --re-sign -k${GPGID} 	\
		framerd_@FDVERSION@*.changes) && 		\
	(cd staging; cp framerd_@FDVERSION@*.tar.?z ../dist) && \
	(cd staging; mv framerd*_@FDVERSION@*.*               	\
			sysv-framerd_@FDVERSION@*.deb  		\
			upstart-framerd_@FDVERSION@*.deb  	\
			systemd-framerd_@FDVERSION@*.deb  	\
			libapache2-mod-fdserv_@FDVERSION@*.deb  \
			elpa-fdconsole_@FDVERSION@*.deb  \
			../dist) &&                             \
	touch dist/debsource.signed;
	touch dist/debs.signed;

dist/debs.done: dist/debs.signed
	touch dist/debs.done
dist/debsource.done: dist/debsource.signed
	touch dist/debsource.done dist/debs.done

install-debian install-debs debinstall installdebs: dist/debs.done
	@cd dist; @SUDO@ dpkg -i framerd*@FDVERSION@*.deb \
		elpa-fdconsole*@FDVERSION@*.deb libapache2-mod-fdserv_@FDVERSION@*.deb \
		systemd-framerd_@FDVERSION@*.deb

update-local-apt-repo: dist/debs.done
	for change in dist/*.changes; do \
	  reprepro -Vb ${APTREPO} include ${CODENAME} $${change} && \
	  rm -f $${change}; \
	done

update-remote-apt-repo: dist/debs.done
	cd dist; for change in *.changes; do \
	  dupload -c --nomail --to ${CODENAME} $${change} && \
	  rm -f $${change}; \
	done

update-apt update-apt-repo: dist/debs.done
	if test -d ${APTREPO}; then	\
	  make update-local-apt-repo;	\
	else				\
	  make update-remote-apt-repo;	\
	fi;

apt-upload upload-apt upload-deb: update-remote-apt-repo

.PHONY: apt-upload upload-apt upload-deb
.PHONY: update-apt-repo update-remote-apt-repo update-local-apt-repo

# Installation targets

install-status:
	@if test -f .malloc && test -f .buildmode; then \
	  echo "Installing" $(shell cat .buildmode) "build linked with" $(shell cat .malloc); \
	fi;
install: install-status install-core install-cmodules install-dbmodules \
		install-libscm install-modules @setup_target@
	@if test -f .malloc && test -f .buildmode; then \
	  echo "Installed" $(shell cat .buildmode) "build linked with" $(shell cat .malloc); \
	fi;
install-bin: install-static install-shared install-exe
install-text: install-headers install-scripts install-support
install-core: confdirs workdirs @INSTALLI18N@           \
	 install-bin install-text install-data

$(INCINSTALLDIR):
	@$(SYSINSTALL) @install_dir_opts@ $(INCINSTALLDIR)
$(BININSTALLDIR):
	@$(SYSINSTALL) @install_dir_opts@ $(BININSTALLDIR)
$(LIBINSTALLDIR):
	@$(SYSINSTALL) @install_dir_opts@ $(LIBINSTALLDIR)
${CMODULES}:
	@$(SYSINSTALL) @install_dir_opts@ ${CMODULES}
$(DESTDIR)@config_dir@ $(DESTDIR)@share_dir@ $(DATADIR):
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@
$(DESTDIR)@local_config@ $(DESTDIR)@shared_config@:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@
$(DESTDIR)@config_dir@/daemons $(DESTDIR)@config_dir@/servlets $(DESTDIR)@config_dir@/config_files: $(DESTDIR)@config_dir@
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@

install-static:  static-libs $(LIBINSTALLDIR)
	make $(LIBINSTALLDIR)/libfdcore@suffix@.a        \
		$(LIBINSTALLDIR)/libfdstorage@suffix@.a       \
		$(LIBINSTALLDIR)/libfddrivers@suffix@.a   \
		$(LIBINSTALLDIR)/libfddbserv@suffix@.a    \
		$(LIBINSTALLDIR)/libfdscheme@suffix@.a   \
		$(LIBINSTALLDIR)/libfdweb@suffix@.a      \
		$(LIBINSTALLDIR)/libtexttools@suffix@.a
install-shared: install-status shared-libs $(LIBINSTALLDIR) 				\
    $(LIBINSTALLDIR)/libfdcore@suffix@.@vshared_suffix@			\
    $(LIBINSTALLDIR)/libfdcore@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libfdcore@suffix@.@mshared_suffix@			\
    $(LIBINSTALLDIR)/libfdcore@suffix@.@shared_suffix@			\
    $(LIBINSTALLDIR)/libfdstorage@suffix@.@vshared_suffix@			\
    $(LIBINSTALLDIR)/libfdstorage@suffix@.@mmshared_suffix@			\
    $(LIBINSTALLDIR)/libfdstorage@suffix@.@mshared_suffix@			\
    $(LIBINSTALLDIR)/libfdstorage@suffix@.@shared_suffix@			\
    $(LIBINSTALLDIR)/libfddbserv@suffix@.@vshared_suffix@		\
    $(LIBINSTALLDIR)/libfddbserv@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libfddbserv@suffix@.@mshared_suffix@		\
    $(LIBINSTALLDIR)/libfddbserv@suffix@.@shared_suffix@			\
    $(LIBINSTALLDIR)/libfddrivers@suffix@.@vshared_suffix@		\
    $(LIBINSTALLDIR)/libfddrivers@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libfddrivers@suffix@.@mshared_suffix@		\
    $(LIBINSTALLDIR)/libfddrivers@suffix@.@shared_suffix@		\
    $(LIBINSTALLDIR)/libfdscheme@suffix@.@vshared_suffix@		\
    $(LIBINSTALLDIR)/libfdscheme@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libfdscheme@suffix@.@mshared_suffix@		\
    $(LIBINSTALLDIR)/libfdscheme@suffix@.@shared_suffix@		\
    $(LIBINSTALLDIR)/libfdweb@suffix@.@vshared_suffix@			\
    $(LIBINSTALLDIR)/libfdweb@suffix@.@mmshared_suffix@			\
    $(LIBINSTALLDIR)/libfdweb@suffix@.@mshared_suffix@			\
    $(LIBINSTALLDIR)/libfdweb@suffix@.@shared_suffix@			\
    $(LIBINSTALLDIR)/libtexttools@suffix@.@vshared_suffix@		\
    $(LIBINSTALLDIR)/libtexttools@suffix@.@mmshared_suffix@		\
    $(LIBINSTALLDIR)/libtexttools@suffix@.@mshared_suffix@		\
    $(LIBINSTALLDIR)/libtexttools@suffix@.@shared_suffix@

install-headers: $(INCINSTALLDIR)
	@$(SYSINSTALL) -p @install_file_opts@		\
		   $(LISP_HEADERS) $(APPLY_HEADERS) 	\
		   $(STORAGE_HEADERS) $(DRIVERS_H)	\
		   $(SCHEME_HEADERS) $(LIB_HEADERS)	\
		   $(REVISION_H)			\
		$(INCINSTALLDIR)

install-data: $(DATADIR)
	@$(SYSINSTALL) @install_file_opts@ docs/misc/data.README \
		$(DATADIR)/README
	@$(SYSINSTALL) @install_file_opts@ @DATAFILES@ $(DATADIR)

install-exe: $(BININSTALLDIR) $(EXECUTABLES)
	@$(SYSINSTALL) -p @install_exe_opts@ $(EXECUTABLES) $(BININSTALLDIR)

install-scripts: install-shell-scripts install-scheme-scripts
install-shell-scripts:
	@$(SYSINSTALL) @install_exe_opts@ $(SHELL_SCRIPTS) $(BININSTALLDIR)
install-scheme-scripts: $(BININSTALLDIR) $(SCHEME_SCRIPTS)
	@$(SYSINSTALL) @install_exe_opts@ $(SCHEME_SCRIPTS) $(BININSTALLDIR)

install-data: \
	$(DESTDIR)@config_dir@/boot/ex_daemon.service   \
	$(DESTDIR)@config_dir@/boot/ex_servlet.service  \
	$(DESTDIR)@config_dir@/boot/framerd.target	\
	$(DESTDIR)@config_dir@/boot/fdaemons.service	\
	$(DESTDIR)@config_dir@/boot/fdweb.service	\
	$(DESTDIR)@config_dir@/boot/framerd-rc.d 	\
	$(DESTDIR)@config_dir@/boot/framerd.conf 	\
	$(DESTDIR)@config_dir@/boot/logrotate

install-fastcgi: $(BININSTALLDIR)/fdcgiexec@suffix@
$(BININSTALLDIR)/fdcgiexec@suffix@:
	@$(SYSINSTALL) -p @install_exe_opts@ exe/fdcgiexec@suffix@ $(BININSTALLDIR)

install-cmodules: @INSTALLCMODULES@
install-dbmodules: @INSTALLDBMODULES@
install-odbc: ${CMODULES}/odbc.@shared_suffix@ ${CMODULES}/odbc.@vshared_suffix@
install-sqlite: ${CMODULES}/sqlite.@shared_suffix@ ${CMODULES}/sqlite.@vshared_suffix@
install-crypto: ${CMODULES}/crypto.@shared_suffix@ ${CMODULES}/crypto.@vshared_suffix@
install-mysql: ${CMODULES}/mysql.@shared_suffix@ ${CMODULES}/mysql.@vshared_suffix@
install-qrcode: ${CMODULES}/qrcode.@shared_suffix@ ${CMODULES}/qrcode.@vshared_suffix@
install-hyphenate: ${CMODULES}/hyphenate.@shared_suffix@ ${CMODULES}/hyphenate.@vshared_suffix@
install-hunspell: ${CMODULES}/hunspell.@shared_suffix@ ${CMODULES}/hunspell.@vshared_suffix@
install-ziptools: ${CMODULES}/ziptools.@shared_suffix@ ${CMODULES}/ziptools.@vshared_suffix@
install-tidy: ${CMODULES}/tidy.@shared_suffix@ ${CMODULES}/tidy.@vshared_suffix@
install-imagick: ${CMODULES}/imagick.@shared_suffix@ ${CMODULES}/imagick.@vshared_suffix@
install-mongodb: ${CMODULES}/mongodb.@shared_suffix@ ${CMODULES}/mongodb.@vshared_suffix@
install-leveldb: ${CMODULES}/leveldb.@shared_suffix@ ${CMODULES}/leveldb.@vshared_suffix@
install-rocksdb: ${CMODULES}/rocksdb.@shared_suffix@ ${CMODULES}/rocksdb.@vshared_suffix@
install-libarchive: ${CMODULES}/libarchive.@shared_suffix@ ${CMODULES}/libarchive.@vshared_suffix@
install-exif: ${CMODULES}/exif.@shared_suffix@ ${CMODULES}/exif.@vshared_suffix@
install-zlib: ${CMODULES}/zlib.@shared_suffix@ ${CMODULES}/zlib.@vshared_suffix@
install-sundown: ${CMODULES}/sundown.@shared_suffix@ ${CMODULES}/sundown.@vshared_suffix@
install-gperftools: ${CMODULES}/gperftools.@shared_suffix@ ${CMODULES}/gperftools.@vshared_suffix@

# Setup targets

workdirs: $(DESTDIR)@framerd_rundir@ $(DESTDIR)@framerd_logdir@ \
	$(DESTDIR)@daemon_rundir@ $(DESTDIR)@daemon_logdir@ \
	$(DESTDIR)@servlet_rundir@ $(DESTDIR)@servlet_logdir@ \
	$(DESTDIR)@bugjar@

confdirs: $(DESTDIR)@builtin_module_dir@ $(DESTDIR)@builtin_safe_module_dir@ \
	  $(DESTDIR)@installed_module_dir@ $(DESTDIR)@installed_safe_module_dir@ \
	  $(DESTDIR)@local_module_dir@ $(DESTDIR)@local_safe_module_dir@ \
	  $(DESTDIR)@unpackage_dir@ \
	  $(DESTDIR)@local_config@ $(DESTDIR)@shared_config@ \
	  $(DESTDIR)@config_dir@  $(DESTDIR)@config_dir@/config_files \
	  $(DESTDIR)@config_dir@/daemons $(DESTDIR)@config_dir@/servlets \
	  $(DESTDIR)@config_dir@/config
	@$(MSG) Setting up configuration directories
	@if test ! -f $(DESTDIR)@config_dir@/servers; then \
		$(SYSINSTALL) @install_file_opts@ /dev/null \
			$(DESTDIR)@config_dir@/servers; fi

$(DESTDIR)@builtin_module_dir@ $(DESTDIR)@builtin_safe_module_dir@ \
  $(DESTDIR)@installed_module_dir@ $(DESTDIR)@installed_safe_module_dir@ \
  $(DESTDIR)@local_module_dir@ $(DESTDIR)@local_safe_module_dir@:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@
$(DESTDIR)@unpackage_dir@:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $@

upstartdirs: $(DESTDIR)@config_dir@/daemons $(DESTDIR)@config_dir@/servlets

EXT_MODULE_DIRS=xhtml fdxml domutils textindex morph misc tests  knodules \
		jwt aws facebook paypal twitter twilio dropbox google

EXT_MODULE_DATA=textindex/data knodules/data aws/templates morph/data

install-modules: install-standard-modules install-safe-modules
install-standard-modules: install-module-source install-module-data

install-module-source: $(DESTDIR)@builtin_module_dir@
	@$(ECHO) Copying standard Scheme modules to @builtin_module_dir@
	@$(SYSINSTALL) @install_file_opts@ $(BUILD)/src/extmods/*.scm 		\
		$(DESTDIR)@builtin_module_dir@;
	@for dir in $(EXT_MODULE_DIRS); do					\
	  install_dir="$(DESTDIR)@builtin_module_dir@/$${dir}";			\
	  echo "Installing $${dir} module at $${install_dir}";			\
	  $(SYSINSTALL) @install_dir_opts@ $${install_dir};			\
	  $(SYSINSTALL) @install_file_opts@ $(BUILD)/src/extmods/$${dir}/*.scm	\
	      $${install_dir};							\
	done;

install-module-data: $(DESTDIR)@builtin_module_dir@
	@$(ECHO) Copying module data to @builtin_module_dir@;
	@for dir in $(EXT_MODULE_DATA); do					\
	  src_dir="$(BUILD)/src/extmods/$${dir}";				\
	  install_dir="$(DESTDIR)@builtin_module_dir@/$${dir}";			\
	  echo Installing data from $${src_dir} to $${install_dir};		\
	  $(SYSINSTALL) @install_dir_opts@ $${install_dir};			\
	  $(SYSINSTALL) @install_file_opts@ $${src_dir}/* $${install_dir};	\
	done

install-safe-modules: $(DESTDIR)@builtin_safe_module_dir@ \
		install-standard-modules
	@$(ECHO) Linking 'safe' Scheme modules \
		 from @builtin_module_dir@ to @builtin_safe_module_dir@
	@for safe_link in src/extmods/safe/*; do	\
	  if test -h "$${safe_link}"; then			\
            $(SUINSTALL) ln -sf `readlink $${safe_link}`	\
		          $(DESTDIR)@builtin_safe_module_dir@;	\
	 fi; 							\
	 done

install-support: $(DESTDIR)@share_dir@
	cd $(BUILD)/etc; $(SYSINSTALL) @install_file_opts@ 	\
		gdbinit makefile.include fdconsole.el 		\
		$(DESTDIR)@share_dir@
	cd $(BUILD)/src/web; $(SYSINSTALL) @install_file_opts@ 	\
		webinfo.fdcgi $(DESTDIR)@share_dir@

LIBSCM_DIRS=optimize bugjar storage flexdb brico brico/build mongodb xhtml
install-libscm:
	@if [ ! -d ${DESTDIR}${LIBSCM} ]; then 						\
	  make really-install-libscm; 							\
	elif [ "$(realpath ${DESTDIR}${LIBSCM})" != "$(realpath ./src/libscm)" ]; then 	\
	  make really-install-libscm; 							\
	fi;
really-install-libscm:
	@$(SYSINSTALL) @install_dir_opts@ $(DESTDIR)${LIBSCM};
	@$(SYSINSTALL) @install_file_opts@ src/libscm/*.scm $(DESTDIR)${LIBSCM};
	@for dir in ${LIBSCM_DIRS}; do 						\
	  $(SYSINSTALL) @install_dir_opts@ $(DESTDIR)${LIBSCM}/$$dir;		\
	  $(SYSINSTALL) @install_file_opts@ src/libscm/$$dir/*.scm 		\
	    $(DESTDIR)${LIBSCM}/$$dir; done;
	$(SYSINSTALL) @install_dir_opts@ $(DESTDIR)${LIBSCM}/bugjar/resources;
	$(SYSINSTALL) @install_file_opts@ src/libscm/bugjar/resources/*	\
	       $(DESTDIR)${LIBSCM}/bugjar/resources;
	$(SYSINSTALL) @install_dir_opts@ $(DESTDIR)${LIBSCM}/brico/data;
	$(SYSINSTALL) @install_file_opts@ src/libscm/brico/data/*		\
	       $(DESTDIR)${LIBSCM}/brico/data;

logdirs: $(DESTDIR)@framerd_logdir@ $(DESTDIR)@servlet_logdir@ \
	$(DESTDIR)@daemon_logdir@

statedirs: $(DESTDIR)@rundir@/framerd \
	$(DESTDIR)@daemon_rundir@ \
	$(DESTDIR)@servlet_rundir@ \
	logdirs
$(DESTDIR)/etc/init.d:
	@$(SYSINSTALL) -m 0755 -d $(DESTDIR)/etc/init.d
$(DESTDIR)/etc/init.d/framerd: etc/framerd-rc.d $(DESTDIR)/etc/init.d
	@$(MSG) Installing FramerD init.d
	@$(SYSINSTALL) -m 0555 @admininstall@ \
		   etc/framerd-rc.d $(DESTDIR)/etc/init.d/framerd
$(DESTDIR)@framerd_rundir@:
	@$(MSG) Installing FramerD run directory
	@$(SYSINSTALL) -m 0775  @fdaemoninstall@ @admininstall@ -d \
		   $(DESTDIR)@framerd_rundir@
$(DESTDIR)@daemon_rundir@: $(DESTDIR)@framerd_rundir@
	@$(MSG) Installing FramerD daemon run directory
	@$(SYSINSTALL) -m 0775  @fdaemoninstall@ @admininstall@ -d \
		   $(DESTDIR)@daemon_rundir@
$(DESTDIR)@servlet_rundir@: $(DESTDIR)@framerd_rundir@
	@$(MSG) Installing FramerD servlet run directory
	@$(SYSINSTALL) -m 0775  @wwwinstall@ @admininstall@ -d \
		   $(DESTDIR)@servlet_rundir@
$(DESTDIR)@framerd_logdir@:
	@$(MSG) Installing FramerD log directory
	@$(SYSINSTALL) -m 0775 @fdaemoninstall@  @admininstall@ -d \
		   $(DESTDIR)@framerd_logdir@
$(DESTDIR)@bugjar@: $(DESTDIR)@framerd_logdir@
	@$(MSG) Installing FramerD bugjar directory
	@$(SYSINSTALL) -m 0777 @fdaemoninstall@  @admininstall@ -d \
		   $(DESTDIR)@bugjar@
$(DESTDIR)@daemon_logdir@:  $(DESTDIR)@framerd_logdir@
	@$(SYSINSTALL) -m 0775 @fdaemoninstall@ @admininstall@ \
		-d $(DESTDIR)@daemon_logdir@
$(DESTDIR)@servlet_logdir@: $(DESTDIR)@framerd_logdir@
	@$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
		-d $(DESTDIR)@servlet_logdir@

$(DESTDIR)@config_dir@/boot:
	@$(SYSINSTALL) @install_dir_opts@ $@

setup-sysv: $(DESTDIR)/etc/init.d/framerd statedirs
enable-sysv: setup-sysv
	@if which update-rc.d; then \
		$(MSG) Updating rc.d; \
		$(SUINSTALL) update-rc.d framerd defaults; \
	 fi

info:
	@echo PREFIX= ${PREFIX}
	@echo LIBSCM= ${LIBSCM}

startupdirs: $(DESTDIR)@config_dir@/daemons $(DESTDIR)@config_dir@/servlets

setup-upstart: $(DESTDIR)/etc/init/framerd.conf startupdirs

$(DESTDIR)/etc/init:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $(DESTDIR)/etc/init
$(DESTDIR)/etc/init/framerd.conf: etc/framerd.conf $(DESTDIR)/etc/init
	@$(MSG) Installing framerd Upstart config to $(DESTDIR)/etc/init/framerd.conf
	@$(SYSINSTALL) -m 0555 @admininstall@ \
		   etc/framerd.conf $(DESTDIR)/etc/init/framerd.conf

$(DESTDIR)@systemd_loc@:
	@$(SYSINSTALL) -m 0775 @admininstall@ -d $(DESTDIR)@systemd_loc@
setup-systemd: $(DESTDIR)@systemd_loc@/framerd.target \
		$(DESTDIR)@systemd_loc@/fdaemons.service \
		$(DESTDIR)@systemd_loc@/fdweb.service \
		startupdirs
$(DESTDIR)@systemd_loc@/%: etc/% $(DESTDIR)@systemd_loc@
	@$(MSG) Installing systemd config in $@
	@$(SYSINSTALL) -m 0444 @admininstall@ $< $@
	@if test -z "${DESTDIR}" && test ! -z "${SUDO}"; then 	\
	   ${MSG} systemctl daemon-reload; 			\
	   ${SUDO} systemctl daemon-reload; 			\
	fi

setup-logrotate: etc/logrotate $(DESTDIR)/etc/logrotate.d/framerd logdirs
$(DESTDIR)/etc/logrotate.d:
	@$(SYSINSTALL) -m 0755 -d $@
$(DESTDIR)/etc/logrotate.d/framerd: etc/logrotate $(DESTDIR)/etc/logrotate.d
	@$(MSG) Installing logrotate script
	@$(SYSINSTALL) -T -m 0644 etc/logrotate $(DESTDIR)/etc/logrotate.d/framerd

setup-allboot: setup-sysv setup-upstart setup-systemd

setup-unix: @BOOTSETUP@ setup-logrotate
setup-linux: setup-unix

setup-osx: @share_dir@ startupdirs statedirs logdirs 
	@$(MSG) Setting up OSX system configuration
	@$(SUINSTALL) etc/setup-osx "@share_dir@" \
		"${INSTALL} @install_dir_opts@" \
		"${INSTALL} @install_exe_opts@" \
		"${INSTALL} @install_exe_opts@" \
		/Library /etc

setup-none:
	@echo "Not setting up a boot system"

.PHONY: setup-none setup-osx setup-linux setup-unix setup-allboot setup-logrotate \
	setup-sysv setup-upstart setup-systemd

# Build setups

staging/build-setup.debian.core:
	sudo apt-get install -ym libcurl4-openssl-dev libssl-dev libldns-dev \
		sqlite3 libzip-dev libzstd-dev libedit-dev \
		libarchive-dev libsasl2-dev libsqlite3-dev \
		dh-make devscripts dpkg-dev dh-systemd debsigs && \
	touch $@
staging/build-setup.debian.text: staging/build-setup.debian.core
	sudo apt-get install -ym libhyphen-dev libhunspell-dev && \
	touch $@
staging/build-setup.debian.graphics: staging/build-setup.debian.core
	sudo apt-get install -ym libexif-dev libmagickwand-dev \
		libqrencode-dev && \
	touch $@
staging/build-setup.debian.db: staging/build-setup.debian.odbc \
	staging/build-setup.debian.mongo staging/build-setup.debian.mysql
staging/build-setup.debian.malloc: staging/build-setup.debian.core
	sudo apt install -ym libgoogle-perftools-dev libjemalloc-dev && \
	touch $@

staging/build-setup.debian.odbc: staging/build-setup.debian.core
	sudo apt-get install -ym  unixodbc-dev && \
	touch $@
staging/build-setup.debian.mongo: staging/build-setup.debian.core
	sudo apt-get install -ym libmongoc-dev libbson-dev && \
	touch $@
staging/build-setup.debian.mysql: staging/build-setup.debian.core
	sudo apt-get install -ym libmysqlclient-dev || \
	sudo apt-get install -ym default-libmysqlclient-dev && \
	touch $@

build-setup.debian: staging/build-setup.debian.core \
	staging/build-setup.debian.text \
	staging/build-setup.debian.graphics \
	staging/build-setup.debian.db \
	staging/build-setup.debian.malloc

build-setup.redhat:
	sudo rpm -Uvh libedit-devel

.PHONY: debian-build-setup rpm-build-setup

# The mod_fdserv module

src/apache2/mod_fdserv.so: src/apache2/mod_fdserv.c @abs_top_srcdir@/fileinfo
	@$(ECHO) "#define _FILEINFO \""`@abs_top_srcdir@/fileinfo src/apache2/mod_fdserv.c .`"\"" \
		> src/apache2/mod_fdserv_fileinfo.h
	${APXS} -DUSEDTBLOCK=@USEDTBLOCK@ -DDEBUG_FDSERV=$(DEBUG_FDSERV) \
		-c src/apache2/mod_fdserv.c

mod_fdserv: src/apache2/mod_fdserv.so

# For OSX, try this
# apxs -Wc,'-arch x86_64' -Wl,'-arch x86_64'  -a -i -c src/apache2/mod_fdserv.c
install-fdserv: src/apache2/mod_fdserv.so $(DESTDIR)@apache_modinfo@ \
	$(DESTDIR)@apache_modules_dir@ $(DESTDIR)@servlet_logdir@
	@cd etc; $(SYSINSTALL) @install_file_opts@ fdserv.conf \
			$(DESTDIR)@apache_modinfo@;
	@cd etc; $(SYSINSTALL) @install_file_opts@ fdserv.load \
			$(DESTDIR)@apache_modinfo@;
	@$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
			-d $(DESTDIR)@rundir@/fdserv;
	@cd src/apache2; if test -f mod_fdserv.so; \
		then $(SUINSTALL) ${APXS} -i mod_fdserv.so; \
		else $(SUINSTALL) ${APXS} -i mod_fdserv.la; \
		fi
	@echo Installed fdserv module with @rundir@/fdserv @logdir@/fdserv

$(DESTDIR)@apache_modules_dir@:
	@$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
		-d $(DESTDIR)@apache_modules_dir@
$(DESTDIR)@apache_modinfo@:
	@$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
		-d $(DESTDIR)@apache_modinfo@

update-fdserv: src/apache2/mod_fdserv.so $(DESTDIR)@apache_modinfo@ \
		$(DESTDIR)@apache_modules_dir@
	@$(MSG) "STOPPING and STARTING Apache to INSTALL NEW mod_fdserv"
	@$(MSG) "THIS REQUIRES sudo PRIVILEGES; you may be prompted for your password"
	sudo apachectl stop
	cd etc; sudo ${INSTALL} @install_file_opts@ fdserv.conf fdserv.load \
			$(DESTDIR)@apache_modinfo@;
	$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
			-d $(DESTDIR)@rundir@/fdserv;
	$(SYSINSTALL) -m 0775 @wwwinstall@ @admininstall@ \
			-d $(DESTDIR)@logdir@/fdserv;
	cd src/apache2; if test -f mod_fdserv.so; \
		then sudo ${APXS} -i mod_fdserv.so; \
		else sudo ${APXS} -i mod_fdserv.la; fi
	sleep 5; sudo apachectl start

# Test targets

testclean:
	@make -s -C tests testclean 2>&1 > tests/testclean.log
tests: testclean
	@echo "#### Running test scripts, BUILD=${BUILDMODE} LINKED=${LINKEDWITH}"
	@if test ! -f tests/data/private.text; then \
	 echo "#### Can't test primitives on protected files, enable with 'make private_files'"; \
	 fi;
	@echo "#### Note that killed/exited messages for the 'countup' scripts are normal"
	@DATE=`date +%d%b%yT%T`; make -s -C tests -k -j && \
	 sort tests/timing.log -k 2 > tests/logs/timing-$${DATE}.log;
	@if test ! -f tests/data/private.text; then \
	 echo "#### Can't test primitives on protected files, enable with 'make private_files'"; \
	 fi;

tests.log: tests/fdexec tests/makefile.in makefile
	@echo "#### Running test scripts, output in" $@ "BUILD=${BUILDMODE} LINKED=${LINKEDWITH}"
	@echo "#### Note that killed/exited messages for the 'countup' scripts are normal"
	@make -s -C tests testclean 2>&1 > tests/testclean.log
	@DATE=`date +%d%b%yT%T`; make -s -C tests -k -j 2>&1 > tests.log && \
	 cp tests.log tests/logs/tests-$${DATE}.log; \
	 sort tests/timing.log -k 2 > tests/logs/timing-$${DATE}.log;

libtests.log: tests/fdexec tests/makefile.in
	@echo "#### Running libtests, output in" $@ "BUILD=${BUILDMODE} LINKED=${LINKEDWITH}"
	@make -s -C tests testclean 2>&1 > tests/testclean.log
	@DATE=`date +%d%b%yT%T`; \
	 make -s -C tests -k -j libtests loadmods optmods 2>&1 > libtests.log && \
	 cp libtests.log tests/logs/libtests-$${DATE}.log;
libtests: libtests.log

tests/memtests.log: tests/fdexec tests/makefile.in
	@echo "#### Running memory tests, output in" $@ "BUILD=${BUILDMODE} LINKED=${LINKEDWITH}"
	@make -s -C tests testclean 2>&1 > tests/testclean.log
	@DATE=`date +%d%b%yT%T`; \
	 make -s -C tests -k -j memtests 2>&1 > memtests.log && \
	 cp memtests.log tests/logs/memtests-`date +%d%b%yT%T`.log;
memtests: memtests.log

tests/leaktests.log: tests/fdexec tests/makefile.in
	@echo "#### Running leak tests, output in" $@ "BUILD=${BUILDMODE} LINKED=${LINKEDWITH}"
	@make -s -C tests testclean 2>&1 > tests/testclean.log
	@DATE=`date +%d%b%yT%T`; make -s -C tests -k -j leaktests 2>&1 > leaktests.log && \
	cp leaktests.log tests/logs/leaktests-`date +%d%b%yT%T`.log;
leaktests: leaktests.log

tests/schemetests.log: tests/fdexec tests/makefile.in
	@echo "#### Running scheme tests, output in" $@ "BUILD=${BUILDMODE} LINKED=${LINKEDWITH}"
	@make -s -C tests testclean 2>&1 > tests/testclean.log
	@DATE=`date +%d%b%yT%T`; \
	 make -s -C tests -k -j schemetests 2>&1 > schemetests.log && \
	 cp schemtests.log tests/logs/schemetests-`date +%d%b%yT%T`.log;
schemetests: schemetests.log

tests/cmdtests.log: tests/fdexec tests/makefile.in
	@echo "#### Running command tests, output in" $@ "BUILD=${BUILDMODE} LINKED=${LINKEDWITH}"
	@make -s -C tests testclean 2>&1 > tests/testclean.log
	@DATE=`date +%d%b%yT%T`; \
	 make -s -C tests -k -j cmdtests 2>&1 > tests/cmdtests.log && \
	 cp tests/cmdtests.log tests/logs/cmdtests-`date +%d%b%yT%T`.log;
cmdtests: tests/cmdtests.log

tests/dbtests.log: tests/fdexec tests/makefile.in
	@echo "#### Running database tests, output in" $@ "BUILD=${BUILDMODE} LINKED=${LINKEDWITH}"
	@make -s -C tests testclean 2>&1 > tests/testclean.log
	@DATE=`date +%d%b%yT%T`; \
	 make -s -C tests -k -j dbtests 2>&1 > dbtests.log && \
	 cp dbtests.log tests/logs/dbtests-`date +%d%b%yT%T`.log;
dbtests: tests/dbtests.log

private_files: tests/data/private.text tests/data/private.dtype tests/data/private

tests/data/private.text: tests/data/testobj.text
	@@SUDO@ cp $< $@
	@@SUDO@ chown nobody $@
	@@SUDO@ chmod og-rwx $@
tests/data/private.dtype: tests/data/testobj.dtype
	@@SUDO@ cp $< $@
	@@SUDO@ chown nobody $@
	@@SUDO@ chmod og-rwx $@
tests/data/private:
	@@SUDO@ mkdir $@
	@@SUDO@ chown nobody $@
	@@SUDO@ chmod og-w $@

.PHONY: tests libtests schemetests dbtests cmtdtests memtests leaktests

# DIY rules

mongodb.bundled: include/bson include/mongoc lib/libbson.a lib/libmongoc.a

include/bson include/mongoc lib/libbson.a lib/libmongoc.a: DIY/mongo-c-driver/built
	cd DIY; make mongo-c-driver/built;
	ln -sf ../DIY/mongo-c-driver/src/libbson/src/bson include/bson
	ln -sf ../DIY/mongo-c-driver/src/libmongoc/src/mongoc include/mongoc
	cp DIY/mongo-c-driver/libmongoc.a lib
	cp DIY/mongo-c-driver/libbson.a lib

DIY/mongo-c-driver/built:
	cd DIY; make mongo-c-driver/built

# Meta operations

update-modules:
	git submodule update --remote --merge src/extmods

.PHONY: fdserv update-fdserv install-fdserv update-modules

# Tracking revision information

include/framerd/revision.h: $(FRAMERD_SOURCES) $(FRAMERD_HEADERS) makefile
	@if test -f etc/revision.h; then				\
	    cp etc/revision.h etc/use_revision.h; 			\
	elif $(GITDESCRIBE) > /dev/null 2>&1; then			\
	    echo "#define FRAMERD_REVISION \""`@GITDESCRIBE@`"\"" 	\
		> etc/use_revision.h; 					\
	    echo >> etc/use_revision.h;					\
	    echo "#define FRAMERD_BRANCH \"${GITBRANCH}\"" \
		>> etc/use_revision.h; 					\
	else echo "#define FRAMERD_REVISION \"@FDVERSION@-exported\""	\
		> etc/use_revision.h; 					\
	    echo "#define FRAMERD_BRANCH \"exported\"" >> 		\
		etc/use_revision.h; 					\
	fi;
	@if test ! -f $@; then 						\
	  mv etc/use_revision.h $@; 					\
	elif diff etc/use_revision.h $@>/dev/null; then			\
	  rm etc/use_revision.h; 					\
	else 								\
	  echo "Revision changed to "`@GITDESCRIBE@`; 			\
	  mv $@ etc/old_revision.h; 					\
	  mv etc/use_revision.h $@;					\
	fi;
### Depending on the .buildmode
$(EXECUTABLES) $(STATIC_EXECUTABLES): .buildmode $(REVISION_H)
$(LISP_OBJS): $(LISP_HEADERS) $(REVISION_H)
$(SUPPORT_OBJS): $(LISP_HEADERS) $(REVISION_H)
$(APPLY_OBJS): $(LISP_HEADERS) $(APPLY_HEADERS) $(REVISION_H)
$(STORAGE_OBJS): $(LISP_HEADERS) $(STORAGE_HEADERS) $(REVISION_H)
$(DRIVER_OBJS): $(LISP_HEADERS) $(STORAGE_HEADERS) $(DRIVERS_H) $(REVISION_H)
$(SCHEME_OBJS): $(LISP_HEADERS) $(STORAGE_HEADERS) $(DRIVERS_H) \
	$(APPLY_HEADERS) $(SCHEME_HEADERS) $(REVISION_H)
$(WEB_OBJS): $(LISP_HEADERS) $(STORAGE_HEADERS) $(DRIVERS_H) \
	$(APPLY_HEADERS) $(SCHEME_HEADERS) $(REVISION_H) ./include/framerd/fdweb.h
$(TEXT_OBJS): $(LISP_HEADERS) $(STORAGE_HEADERS) $(DRIVERS_H) \
	$(APPLY_HEADERS) $(REVISION_H) $(SCHEME_HEADERS) ./include/framerd/texttools.h
$(LISP_OBJS) $(SUPPORT_OBJS) $(APPLY_OBJS): .buildmode
$(STORAGE_OBJS) $(DRIVER_OBJS): .buildmode
$(SCHEME_OBJS): .buildmode
$(WEB_OBJS) $(TEXT_OBJS): .buildmode
$(CMODULE_OBJS): $(LISP_HEADERS) $(STORAGE_HEADERS) $(DRIVERS_H) \
	$(APPLY_HEADERS) $(SCHEME_HEADERS) $(REVISION_H) .buildmode
src/eval/choiceops.o src/prims/seqprims.o: include/framerd/sorting.h
src/prims/procprims.o: include/framerd/procprims.h
# Driver dependencies
src/drivers/filepool.o: src/drivers/headers/filepool.h
src/drivers/fileindex.o: src/drivers/headers/fileindex.h
src/drivers/oidpool.o: src/drivers/headers/oidpool.h src/drivers/headers/zcompress.h
src/drivers/bigpool.o: src/drivers/headers/bigpool.h src/drivers/headers/zcompress.h
src/drivers/hashindex.o: src/drivers/headers/hashindex.h  src/drivers/headers/zcompress.h
src/drivers/memindex.o: src/drivers/headers/memindex.h
