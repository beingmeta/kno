# -*- Mode: Makefile; -*-
# Copyright (C) 2004-2005 beingmeta, inc.
# This file is a part of beingmeta's FramerD implementation, Fdb.
MAKEFILE_VERSION="$Id$"

CC	= @CC@
XCFLAGS=
CFLAGS=@CFLAGS@ @PROFILING@ @DREENTRANT@ @dynamic_cflag@ -I./include $(XCFLAGS)
LDFLAGS = @LDFLAGS@ -L./lib $(EFENCE)
EXELDFLAGS = @EXELDFLAGS@
LIBS=@LIBS@ -lm -lz -lu8 -lu8fns -lu8io -lu8data

DESTDIR		=
prefix		= @prefix@
exec_prefix	= @exec_prefix@
INCINSTALLDIR	= $(DESTDIR)@prefix@/include/fdb
LIBINSTALLDIR	= $(DESTDIR)@libdir@
BININSTALLDIR	= $(DESTDIR)@exec_prefix@/bin
LOCALEDIR	= $(DESTDIR)@exec_prefix@/share/locale
CONFDIR		= @data_dir@
APXS		= @APXS@
CLEAN		= @CLEAN@
INSTALL		= @INSTALL@
MKSTATIC	= @MKSTATIC@
MACOSX_DEPLOYMENT_TARGET=10.3
MKSO		= $(CC) $(CFLAGS) $(XCFLAGS) -shared $(LDFLAGS)
#MACLIBTOOL	= libtool -dynamic -single_module $(LDFLAGS) $(LIBS)
MACLIBTOOL	= MACOSX_DEPLOYMENT_TARGET=10.3 \
		  $(CC) -dynamiclib -single_module \
			-undefined dynamic_lookup \
			$(LDFLAGS) $(LIBS)
BUILD		= `pwd`

DTYPE_HEADERS=\
 include/fdb/config.h  \
 include/fdb/common.h include/fdb/defines.h   \
 include/fdb/support.h   \
 include/fdb/malloc.h include/fdb/dtype.h      \
 include/fdb/ptr.h include/fdb/cons.h         \
 include/fdb/choices.h include/fdb/tables.h   \
 include/fdb/dtypeio.h
DB_HEADERS=\
 include/fdb/dtypestream.h                       \
 include/fdb/apply.h                             \
 include/fdb/fddb.h                              \
 include/fdb/pools.h                             \
 include/fdb/indices.h                           \
 include/fdb/dtproc.h                            \
 include/fdb/frames.h                            \
 include/fdb/methods.h
SCHEME_HEADERS=include/fdb/eval.h include/fdb/sequences.h

BASE0OBJS=src/misc/stdio.o src/misc/simplerr.o
STDBASEOBJS=src/misc/stdio.o src/misc/dynamic.o
DTYPE_OBJS=src/dtype/cons.o src/dtype/oids.o src/dtype/pptrs.o \
	  src/dtype/symbols.o src/dtype/numbers.o \
          src/dtype/choices.o src/dtype/tables.o \
          src/dtype/dtypeio.o src/dtype/textio.o \
	  src/dtype/fdtype.o src/dtype/support.o
DB_OBJS=src/db/fddb.o src/db/dtypestream.o \
	src/db/indices.o src/db/netindices.o src/db/compoundindices.o \
	src/db/pools.o src/db/netpools.o  \
	src/db/apply.o src/db/dtproc.o src/db/methods.o src/db/xtables.o \
	src/db/ipeval.o src/db/frames.o
DBFILE_OBJS=src/db/dbfile.o src/db/filepools.o src/db/zpools.o \
	    src/db/hashdtype.o src/db/fileindices.o src/db/zindices.o
FDBSERV_OBJS=src/db/dbserv.o
CORE_SCHEME_OBJS=src/scheme/eval.o src/scheme/binders.o \
	         src/scheme/conditionals.o src/scheme/iterators.o
SCHEME_OBJS=$(CORE_SCHEME_OBJS) src/scheme/exceptions.o \
	    src/scheme/modules.o src/scheme/load.o src/scheme/history.o \
	    src/scheme/reflection.o \
	    src/scheme/coreprims.o src/scheme/dbprims.o \
	    src/scheme/tableprims.o src/scheme/choiceprims.o \
	    src/scheme/seqprims.o src/scheme/stringprims.o \
	    src/scheme/portprims.o src/scheme/timeprims.o \
	    src/scheme/arithprims.o src/scheme/side-effects.o
SCHEMEIO_OBJS=src/scheme/fileprims.o src/scheme/dbfileprims.o
FDWEB_OBJS=src/fdweb/xmloutput.o src/fdweb/xmlinput.o \
	src/fdweb/xmldata.o src/fdweb/mime.o src/fdweb/uriprims.o \
	src/fdweb/xmleval.o src/fdweb/cgiexec.o @exifo@ @curlo@
TEXTTOOLS_OBJS=src/texttools/texttools.o src/texttools/match.o \
	src/texttools/md5c.o src/texttools/porter.o \
	src/texttools/tagger.o src/texttools/tagxtract.o

EXECUTABLES=exe/fdexec@suffix@ exe/fdconsole@suffix@ \
            exe/fdbatch@suffix@ exe/fdexec@suffix@.static \
	    exe/fdserv@suffix@ exe/fdbserver@suffix@ exe/fdmanager@suffix@
SHELL_SCRIPTS=etc/fdsetconfig etc/fdgetconfig

FDB_SOURCES=\
	$(DTYPE_HEADERS) $(DB_HEADERS) $(SCHEME_HEADERS) \
	src/dtype/cons.c src/dtype/oids.c src/dtype/pptrs.c src/dtype/symbols.c \
        src/dtype/choices.c src/dtype/tables.c \
        src/dtype/dtypeio.c src/dtype/textio.c \
	src/dtype/fdtype.c src/dtype/support.c \
	src/db/fddb.c src/db/dtypestream.c  src/db/dbserv.c \
	src/db/indices.c src/db/netindices.c src/db/compoundindices.c \
	src/db/pools.c src/db/netpools.c \
	src/db/apply.c src/db/dtproc.c src/db/methods.c src/db/xtables.c \
	src/db/ipeval.c src/db/frames.c \
	src/db/dbfile.c src/db/filepools.c src/db/zpools.c \
	src/db/hashdtype.c src/db/fileindices.c src/db/zindices.c \
	src/scheme/eval.c src/scheme/binders.c src/scheme/exceptions.c \
	src/scheme/conditionals.c src/scheme/iterators.c \
	src/scheme/modules.c src/scheme/load.c src/scheme/reflection.c \
	src/scheme/coreprims.c src/scheme/dbprims.c \
	src/scheme/tableprims.c src/scheme/choiceprims.c \
	src/scheme/seqprims.c src/scheme/stringprims.c \
	src/scheme/portprims.c src/scheme/fileprims.c src/scheme/dbfileprims.c \
	src/scheme/arithprims.c src/scheme/side-effects.c src/scheme/timeprims.c \
	src/fdweb/xmloutput.c src/fdweb/xmlinput.c src/fdweb/xmldata.c \
	src/fdweb/xmleval.c src/fdweb/cgiexec.c src/fdweb/uriprims.c      \
	src/fdweb/curl.c src/fdweb/mime.c src/fdweb/exif.c \
	src/texttools/texttools.c include/fdb/texttools.h \
	src/texttools/match.c src/texttools/porter.c \
	src/texttools/md5c.c src/texttools/md5.h \
	src/texttools/tagger.c src/texttools/tagxtract.c \
	include/fdb/tagger.h \
	src/exe/fdconsole.c \
	src/exe/fdexec.c src/exe/fdbatch.c \
	src/exe/fdserv.c src/exe/fdbserver.c

# Targets

all: testbin exe TAGS
libs: static-libs @SHARED_LIB_TARGET@
static-libs: lib/libfdweb@suffix@.a lib/libtexttools@suffix@.a \
	lib/libfdschemeio@suffix@.a lib/libfdscheme@suffix@.a lib/libfdbserv@suffix@.a \
	lib/libfddbfile@suffix@.a lib/libfddb@suffix@.a lib/libfdtype@suffix@.a
shared-libs: lib/libfdtype@suffix@.@shared_suffix@ \
	lib/libfddb@suffix@.@shared_suffix@ \
        lib/libfddbfile@suffix@.@shared_suffix@ \
	lib/libfdbserv@suffix@.@shared_suffix@ \
	lib/libfdscheme@suffix@.@shared_suffix@ \
	lib/libfdschemeio@suffix@.@shared_suffix@ \
	lib/libfdweb@suffix@.@shared_suffix@ \
	lib/libtexttools@suffix@.@shared_suffix@
testbin: dtypetestbin dbtestbin schemetestbin etc/usememory
dtypetestbin: libs  src/exe/revision.h
	cd tests/dtype; make
dbtestbin: libs  src/exe/revision.h
	cd tests/db; make
schemetestbin: libs  src/exe/revision.h
	cd tests/scheme; make
exe: $(EXECUTABLES)

etc/usememory: etc/usememory.c

# Rules

# We selectively link some executables statically to avoid library dependencies
# with programs which will typicall run as daemons
exe/fdexec@suffix@.static: src/exe/fdexec.c \
	@xstatic_exe_libs@ lib/libfdscheme@suffix@.a \
	lib/libfddbfile@suffix@.a lib/libfddb@suffix@.a \
	lib/libfdtype@suffix@.a
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^ -lu8stdio $(LIBS)
exe/fdserv@suffix@: src/exe/fdserv.c \
	@xstatic_exe_libs@ lib/libfdweb@suffix@.a lib/libfdscheme@suffix@.a \
	lib/libfddbfile@suffix@.a lib/libfddb@suffix@.a \
	lib/libfdtype@suffix@.a
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^ -lu8stdio $(LIBS)
exe/fdbserver@suffix@: src/exe/fdbserver.c \
	@xstatic_exe_libs@ lib/libfdbserv@suffix@.a lib/libfdscheme@suffix@.a \
	lib/libfddbfile@suffix@.a lib/libfddb@suffix@.a \
	lib/libfdtype@suffix@.a
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^ -lu8stdio $(LIBS)
exe/fdmanager@suffix@: src/exe/fdmanager.c lib/libfdtype@suffix@.a
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^ -lu8syslog $(LIBS)

exe/%@suffix@: src/exe/%.c
	$(CC) $(EXELDFLAGS) $(CFLAGS) $(LDFLAGS) \
		-o $@ $< \
		$(LIBS) -lu8stdio \
		-lfdtype@suffix@ -lfddb@suffix@ -lfddbfile@suffix@ \
		-lfdscheme@suffix@ -lfdschemeio@suffix@ \
		@xdynamic_scheme_libs@

exe/fdexec@suffix@ exe/fdbatch@suffix@ exe/fdconsole@suffix@: \
	@xstatic_exe_libs@ lib/libfdbserv@suffix@.a lib/libfdscheme@suffix@.a \
	lib/libfddbfile@suffix@.a lib/libfddb@suffix@.a \
	lib/libfdtype@suffix@.a

%.o: %.c
	$(CC) $(CFLAGS) -o $@ -c $<

lib/%@suffix@.a:
	$(MKSTATIC) $@ $^
lib/%@suffix@.so.@VERSION@:
	$(MKSO) -Wl,-soname=$(@F) -o $@ $^
lib/%@suffix@.so: lib/%.so.@VERSION@
	ln -sf $(<F) $@
lib/%@suffix@.@VERSION@.dylib:
	$(MACLIBTOOL) -install_name $(@F) -o $@ $^
lib/%@suffix@.dylib: lib/%@suffix@.@VERSION@.dylib
	ln -sf $(<F) $@

$(LIBINSTALLDIR)/%.a: lib/%.a
	$(INSTALL) @install_file_opts@ $< $(LIBINSTALLDIR)
$(LIBINSTALLDIR)/%@suffix@.so: lib/%@suffix@.so.@VERSION@
	$(INSTALL) @install_file_opts@ $< $(LIBINSTALLDIR)
	ln -sf $(shell basename $<) $@
$(LIBINSTALLDIR)/%@suffix@.dylib: lib/%@suffix@.@VERSION@.dylib
	$(INSTALL) @install_file_opts@ $< $(LIBINSTALLDIR)
	ln -sf $(shell basename $<) $@
$(BININSTALLDIR)/%: exe/%

# Utility targets

TAGS: tests/dtype/*.c tests/db/*.c tests/scheme/*.c src/exe/*.c \
		src/dtype/*.c src/db/*.c src/scheme/*.c src/fdweb/*.c \
		src/texttools/*.c src/texttools/*.h \
		include/fdb/*.h 
	etags tests/dtype/*.c tests/db/*.c tests/scheme/*.c src/exe/*.c \
	      src/dtype/*.c src/db/*.c src/scheme/*.c src/fdweb/*.c \
	      src/texttools/*.c src/texttools/*.h \
	      include/fdb/*.h

profile-clean:
	find . -name "*.gcda" | xargs rm -f
	find . -name "*.gcno" | xargs rm -f
	find . -name "*.gcov" | xargs rm -f
	find . -name "*.bb" | xargs rm -f
	find . -name "*.bbg" | xargs rm -f
	find . -name "*.da" | xargs rm -f
	find . -name "gmon.out" | xargs rm -f
tidy: profile-clean
	rm -f src/dtype/*~ src/db/*~ src/scheme/*~ src/fdweb/*~
	rm -f include/fdb/*~
	rm -f tests/dtype/*~ tests/db/*.o tests/scheme/*.o
	rm -f config.log
clean: tidy
	rm -f src/dtype/*.o src/db/*.o src/scheme/*.o src/fdweb/*.o
	rm -f src/fdweb/*.o src/texttools/*.o src/exe/*.o
	rm -f lib/*.a lib/*@suffix@.so lib/*.dylib lib/*@suffix@.so.* 
	rm -f exe/fdexec@suffix@ exe/fdexec@suffix@.static exe/fdbatch@suffix@
	rm -f exe/fdserv@suffix@ exe/fdbserver@suffix@
	rm -f exe/fdconsole@suffix@
	rm -f TAGS
	cd tests/dtype; make clean
	cd tests/db; make clean
	cd tests/scheme; make clean
distclean: clean
	rm -f makefile config.log config.status config.cache
	rm -f tests/dtype/makefile tests/db/makefile tests/scheme/makefile
	rm -f etc/fdgetconfig etc/fdsetconfig etc/framerd-rc.d
	rm -f include/fdb/config.h

lib/libfdtype@suffix@.a: $(DTYPE_OBJS)
lib/libfdtype@suffix@.so.@VERSION@: $(DTYPE_OBJS)
lib/libfdtype@suffix@.so: lib/libfdtype.so.@VERSION@
lib/libfdtype@suffix@.@VERSION@.dylib: $(DTYPE_OBJS)
lib/libfdtype@suffix@.dylib: lib/libfdtype@suffix@.@VERSION@.dylib

lib/libfddb@suffix@.a: $(DB_OBJS)
lib/libfddb@suffix@.so.@VERSION@: $(DB_OBJS)
lib/libfddb@suffix@.so: lib/libfddb@suffix@.so.@VERSION@
lib/libfddb@suffix@.@VERSION@.dylib: $(DB_OBJS)  lib/libfdtype@suffix@.@VERSION@.dylib
lib/libfddb@suffix@.dylib: lib/libfddb@suffix@.@VERSION@.dylib

lib/libfddbfile@suffix@.a: $(DBFILE_OBJS)
lib/libfddbfile@suffix@.so.@VERSION@: $(DBFILE_OBJS)
lib/libfddbfile@suffix@.so: lib/libfddbfile@suffix@.so.@VERSION@
lib/libfddbfile@suffix@.@VERSION@.dylib: $(DBFILE_OBJS) lib/libfddb@suffix@.@VERSION@.dylib lib/libfdtype@suffix@.@VERSION@.dylib
lib/libfddbfile@suffix@.dylib: lib/libfddbfile@suffix@.@VERSION@.dylib

lib/libfdbserv@suffix@.a: $(FDBSERV_OBJS)
lib/libfdbserv@suffix@.so.@VERSION@: $(FDBSERV_OBJS)
lib/libfdbserv@suffix@.so: lib/libfdbserv@suffix@.so.@VERSION@
lib/libfdbserv@suffix@.@VERSION@.dylib: $(FDBSERV_OBJS) \
	lib/libfdscheme@suffix@.@VERSION@.dylib lib/libfddbfile@suffix@.@VERSION@.dylib \
	lib/libfddb@suffix@.@VERSION@.dylib lib/libfdtype@suffix@.@VERSION@.dylib
	$(MACLIBTOOL) -install_name $(@F) -o $@ $^
lib/libfdserv@suffix@.dylib: lib/libfdbserv@suffix@.@VERSION@.dylib

lib/libfdscheme@suffix@.a: $(SCHEME_OBJS)
lib/libfdscheme@suffix@.so.@VERSION@: $(SCHEME_OBJS)
lib/libfdscheme@suffix@.so: lib/libfdscheme@suffix@.so.@VERSION@
lib/libfdscheme@suffix@.@VERSION@.dylib: $(SCHEME_OBJS) \
	lib/libfddb@suffix@.@VERSION@.dylib lib/libfdtype@suffix@.@VERSION@.dylib
lib/libfdscheme@suffix@.dylib: lib/libfdscheme@suffix@.@VERSION@.dylib

lib/libfdschemeio@suffix@.a: $(SCHEMEIO_OBJS)
lib/libfdschemeio@suffix@.so.@VERSION@: $(SCHEMEIO_OBJS)
lib/libfdschemeio@suffix@.so: lib/libfdschemeio@suffix@.so.@VERSION@
lib/libfdschemeio@suffix@.@VERSION@.dylib: $(SCHEMEIO_OBJS) \
	lib/libfdscheme@suffix@.@VERSION@.dylib lib/libfddbfile@suffix@.@VERSION@.dylib \
	lib/libfddb@suffix@.@VERSION@.dylib lib/libfdtype@suffix@.@VERSION@.dylib 
lib/libfdschemeio.dylib: lib/libfdschemeio@suffix@.@VERSION@.dylib

lib/libfdweb@suffix@.a: $(FDWEB_OBJS)
lib/libfdweb@suffix@.so.@VERSION@: $(FDWEB_OBJS)
	$(MKSO) @curlconfig@ -o $@ $^ 
lib/libfdweb@suffix@.so: lib/libfdweb@suffix@.so.@VERSION@
lib/libfdweb@suffix@.@VERSION@.dylib: $(FDWEB_OBJS) \
	lib/libfdscheme@suffix@.@VERSION@.dylib lib/libfddbfile@suffix@.@VERSION@.dylib \
	lib/libfddb@suffix@.@VERSION@.dylib lib/libfdtype@suffix@.@VERSION@.dylib
	$(MACLIBTOOL) -install_name $(@F) -o $@ $(FDWEB_OBJS)
lib/libfdweb@suffix@.dylib: lib/libfdweb@suffix@.@VERSION@.dylib

lib/libtexttools@suffix@.a: $(TEXTTOOLS_OBJS)
lib/libtexttools@suffix@.so.@VERSION@: $(TEXTTOOLS_OBJS)
	$(MKSO) @curlconfig@ -o $@ $^ 
lib/libtexttools@suffix@.so: lib/libtexttools@suffix@.so.@VERSION@
lib/libtexttools@suffix@.@VERSION@.dylib: $(TEXTTOOLS_OBJS) \
	lib/libfdscheme@suffix@.@VERSION@.dylib lib/libfddbfile@suffix@.@VERSION@.dylib \
	lib/libfddb@suffix@.@VERSION@.dylib lib/libfdtype@suffix@.@VERSION@.dylib
	$(MACLIBTOOL) -install_name $(@F) -o $@ $(TEXTTOOLS_OBJS)
lib/libtexttools.dylib: lib/libtexttools@suffix@.@VERSION@.dylib

# Internationalization stuff

$(LOCALEDIR)/%/LC_MESSAGES/fdb.mo: etc/intl/%.gmo
	install $^ $@

etc/intl/fdb.pot: $(FDB_SOURCES)
	xgettext -dfdb -oetc/intl/fdb.pot -k_ $(FDB_SOURCES)
etc/intl/%.po: etc/intl/fdb.pot
	msgmerge -U $@ $<
etc/intl/%.gmo: etc/intl/%.po
	msgfmt $^ -o $@ 

install-i18n: $(LOCALEDIR)/fr/LC_MESSAGES/fdb.mo \
		$(LOCALEDIR)/es/LC_MESSAGES/fdb.mo \
		$(LOCALEDIR)/nl/LC_MESSAGES/fdb.mo
i18n: etc/intl/fr.gmo etc/intl/nl.gmo etc/intl/es.gmo

# Installation targets

install: confdirs @INSTALLI18N@ \
	 install-static install-shared install-headers \
         install-exe install-scripts
install-static: static-libs
	make $(LIBINSTALLDIR)/libfdtype@suffix@.a \
		$(LIBINSTALLDIR)/libfddb@suffix@.a \
		$(LIBINSTALLDIR)/libfddbfile@suffix@.a \
		$(LIBINSTALLDIR)/libfdbserv@suffix@.a \
		$(LIBINSTALLDIR)/libfdscheme@suffix@.a \
		$(LIBINSTALLDIR)/libfdschemeio@suffix@.a \
		$(LIBINSTALLDIR)/libfdweb@suffix@.a \
		$(LIBINSTALLDIR)/libtexttools@suffix@.a
install-shared: shared-libs 
	make install-@shared_suffix@
install-so: $(LIBINSTALLDIR)/libfdtype@suffix@.so \
		$(LIBINSTALLDIR)/libfddb@suffix@.so \
		$(LIBINSTALLDIR)/libfdbserv@suffix@.so \
		$(LIBINSTALLDIR)/libfddbfile@suffix@.so \
		$(LIBINSTALLDIR)/libfdscheme@suffix@.so \
		$(LIBINSTALLDIR)/libfdschemeio@suffix@.so \
		$(LIBINSTALLDIR)/libfdweb@suffix@.so \
		$(LIBINSTALLDIR)/libtexttools@suffix@.so
install-dylib: $(LIBINSTALLDIR)/libfdtype@suffix@.dylib \
	$(LIBINSTALLDIR)/libfddb@suffix@.dylib \
	$(LIBINSTALLDIR)/libfdbserv@suffix@.dylib \
	$(LIBINSTALLDIR)/libfddbfile@suffix@.dylib \
	$(LIBINSTALLDIR)/libfdscheme@suffix@.dylib \
	$(LIBINSTALLDIR)/libfdschemeio@suffix@.dylib \
	$(LIBINSTALLDIR)/libfdweb@suffix@.dylib \
	$(LIBINSTALLDIR)/libtexttools@suffix@.dylib
install-headers: $(INCINSTALLDIR)
	$(INSTALL) -p @install_file_opts@ \
		   $(DTYPE_HEADERS) $(DB_HEADERS) $(SCHEME_HEADERS) \
		$(INCINSTALLDIR)
install-exe: $(BININSTALLDIR) $(EXECUTABLES)
	$(INSTALL) -p @install_exe_opts@ $(EXECUTABLES) $(BININSTALLDIR)
install-scripts: install-shell-scripts
install-shell-scripts:
	$(INSTALL) @install_exe_opts@ $(SHELL_SCRIPTS) $(BININSTALLDIR)

$(INCINSTALLDIR):
	$(INSTALL) @install_dir_opts@ $(INCINSTALLDIR)
$(BININSTALLDIR):
	$(INSTALL) @install_dir_opts@ $(BININSTALLDIR)

# Setup targets

confdirs: @data_dir@ @config_dir@ @module_dir@ @safe_module_dir@

@data_dir@ @config_dir@ @module_dir@ @safe_module_dir@:
	$(INSTALL) @install_dir_opts@ $@
	touch @data_dir@/servers
link-modules: $(CONFDIR)/scm
	ln -sf $(BUILD)/etc/*.el $(CONFDIR)/etc
	ln -sf $(BUILD)/src/modules/*.scm @module_dir@
	ln -sf $(BUILD)/src/modules/*.table @module_dir@
	ln -sf $(BUILD)/src/fdweb/xhtml @module_dir@
copy-modules: $(CONFDIR)/scm
	cp -pf `pwd`/etc/*.el $(CONFDIR)/etc
	cp -pf src/modules/*.scm @module_dir@
	cp -pf src/modules/*.table @module_dir@
	cp -rf src/fdweb/xhtml @module_dir@

setup-rc.d:
	$(INSTALL) --mode=0555 etc/framerd-rc.d /etc/init.d/framerd
setup-osx: @data_dir@
	etc/setup-osx "@data_dir@" \
		"${INSTALL} @install_dir_opts@" \
		"${INSTALL} @install_exe_opts@" \
		"${INSTALL} @install_exe_opts@" \
		/Library /etc

# The mod_fdserv module

etc/mod_fdserv.so: etc/mod_fdserv.c
	cd etc; ${APXS} -c mod_fdserv.c

mod_fdserv: etc/mod_fdserv.so

install-fdserv: etc/mod_fdserv.so
	cd etc; ${APXS} -i -c mod_fdserv.c
	if test -d @apache_conf_dir@/mods-available; \
	   then ${INSTALL} @install_file_opts@ \
		etc/fdserv.conf etc/fdserv.load \
		@apache_conf_dir@/mods-available; \
	fi

activate-fdserv: etc/mod_fdserv.so
	cd etc; ${APXS} -i -a -c mod_fdserv.c

# Tracking revision information

src/exe/revision.h: $(FDB_SOURCES)
	echo "#define SVN_REVISION \""`svnversion`"\"" > src/exe/revision.h
$(EXECUTABLES): src/exe/revision.h

# Dependency information

$(DTYPE_OBJS): $(DTYPE_HEADERS)
$(DB_OBJS): $(DB_HEADERS) $(DTYPE_HEADERS) 
$(FDBSERV_OBJS): $(DB_HEADERS) $(DTYPE_HEADERS)
$(CORE_SCHEME_OBJS): src/scheme/eval_internals.h \
	$(SCHEME_HEADERS) $(DB_HEADERS) $(DTYPE_HEADERS)
$(SCHEME_OBJS): $(SCHEME_HEADERS) $(DB_HEADERS) $(DTYPE_HEADERS)
$(SCHEMEIO_OBJS): include/fdb/ports.h $(SCHEME_HEADERS) $(DB_HEADERS) $(DTYPE_HEADERS)
$(FDWEB_OBJS): include/fdb/fdweb.h \
	$(DTYPE_HEADERS) $(DB_HEADERS) $(SCHEME_HEADERS)
$(TEXTTOOLS_OBJS): include/fdb/texttools.h include/fdb/tagger.h \
	$(DTYPE_HEADERS) $(DB_HEADERS) $(SCHEME_HEADERS)

