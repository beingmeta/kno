# -*- Mode: Makefile; -*-
# Copyright (C) 2004-2017 beingmeta, inc.
# This file is a part of beingmeta's FramerD implementation

FD_INIT_DLOADPATH=../../lib/framerd/%..@shared_suffix@:../../../aikit/c/%..@shared_suffix@:@prefix@/lib/framerd/%.@shared_suffix@
export FD_INIT_LOADPATH
FD_INIT_LOADPATH=../../src/modules/%.scm:../../src/modules/%/module.scm:@default_module_path@
export FD_INIT_LOADPATH
FD_INIT_SAFELOADPATH=../../src/modules/safe/%.scm:../../src/modules/safe/%/module.scm:@default_safe_module_path@
export FD_INIT_SAFELOADPATH
FD_LOADPATH=../../src/modules/%/module.scm:../../src/modules/%.scm:
export FD_LOADPATH
FD_DLOADPATH=../../lib/framerd
export FD_DLOADPATH
LD_LIBRARY_PATH=../../lib
export LD_LIBRARY_PATH
DYLD_LIBRARY_PATH=../../lib
export DYLD_LIBRARY_PATH
PPROF_PATH      = @GOOGLE_PPROF@
export PPROF_PATH

CC	= @CC@
XCFLAGS=  
CFLAGS=-I../../include @CFLAGS@ @PROFILING@ @DREENTRANT@ @dynamic_cflag@ \
       -DFD_TESTCONFIG=1 -I../../include $(XCFLAGS)
LDFLAGS=-L../../lib @LDFLAGS@ $(EFENCE) @TESTLDFLAGS@ -L../../lib
RPATH   = @rpath@
RPATHFLAGS = @RPATHFLAGS@
BASELIBS=@LIBS@ -lm -lz
BMLIBS=-lu8io -lu8data -lu8
XLIBS=
LIBS=$(XLIBS) $(BMLIBS) $(BASELIBS)
EXELDFLAGS = @EXELDFLAGS@
CORE_LIBS	= ../../lib/libfdscheme@suffix@.a       \
	  	  	../../lib/libfdbserv@suffix@.a  \
	 		../../lib/libfddbdrivers@suffix@.a \
			../../lib/libfddb@suffix@.a     \
			../../lib/libfdtype@suffix@.a
EXTRA_LIBS	= ../../lib/libtexttools@suffix@.a \
		  ../../lib/libfdweb@suffix@.a \
		  ../../lib/libfdschemeio@suffix@.a

DESTDIR		=
prefix		= @prefix@
exec_prefix	= @exec_prefix@
LIBINSTALLDIR	= $(DESTDIR)@libdir@
CLEAN		= @CLEAN@
INSTALL		= @INSTALL@
VALGRIND	= INVALGRIND=yes MEMCHECKING=yes valgrind --tool=memcheck --num-callers=9
VALGRINDHEAP	= INVALGRIND=yes MEMCHECKING=yes valgrind --tool=memcheck --leak-check=yes --num-callers=9
TESTPROG	= 
TESTENV		= @TESTENV@
TESTSIZE	= 512
SMALLTESTSIZE	= 64
TESTCONFIG	= LOADPATH=../../src/modules/%/module.scm:../../src/modules/%.scm
RUNTEST		= $(TESTENV) $(TESTPROG)
DBTEST_FILES	= r4rs.scm misctest.scm seqtest.scm choicetest.scm dbtest.scm

TESTBIN=fdeval fdconsole fdexec fdbatch fdserver fdservlet fdcgiexec # fdsh

# Note that we don't add @suffix@ to these executables because they're
# never installed
%.o: %.c
	@$(CC) $(CFLAGS) -o $@ -c $<
	@echo CC $@ $<

# This is for making shared test programs, when there are associated problems
%.shared: %.c
	@echo MKTEST_SHARED $@
	@$(CC) $(CFLAGS) $(EXELDFLAGS) $(LDFLAGS) -o $@ $^ $(LIBS) \
		-lfdtype@suffix@ -lfddb@suffix@ -lfddbdrivers@suffix@ \
		-lfdscheme@suffix@ -lfdschemeio@suffix@

%: %.c $(EXTRA_LIBS) $(CORE_LIBS)
	@echo MKTEST_STATIC $@
	$(CC) $(CFLAGS) $(LDFLAGS) $(EXELDFLAGS) -o $@ $< 	\
		$(EXTRA_LIBS) $(CORE_LIBS) $(LIBS) -lu8stdio

# Base targets

default: alltests

testbin: $(TESTBIN) 

fdcgiexec fdconsole fdexec fdserver fdservlet: main.c main.h

fdcgiexec fdservlet: webcommon.h

# Linking targets

fdconsole.c: ../../src/exe/fdconsole.c
	ln -s $< $@

fdexec.c: ../../src/exe/fdexec.c
	ln -s $< $@

fdbatch.c: ../../src/exe/fdbatch.c
	ln -s $< $@

fdserver.c: ../../src/exe/fdserver.c
	ln -s $< $@

fdservlet.c: ../../src/exe/fdservlet.c
	ln -s $< $@

fdcgiexec.c: ../../src/exe/fdcgiexec.c
	ln -s $< $@

main.c: ../../src/exe/main.c
	ln -s $< $@

main.h: ../../src/exe/main.h
	ln -s $< $@

webcommon.h: ../../src/exe/webcommon.h
	ln -s $< $@

# Clean targets

clean: testclean
	rm -f $(TESTBIN)
	find . -name "vgcore.*" | xargs rm -f
	find . -name "*.pid" | xargs rm -f
	rm -rf mongodb/dbdata;

testclean:
	rm -f *.log *.err *.done *.finished *.pid *.died
	rm -f temp.* utf8-temp.* testdb* memoization.index test.dtype
	rm -f logfile thirty2fifty thirtythree 


# Static lib targets

../../lib/libfdweb@suffix@.a:
	cd ../..; make lib/libfdweb@suffix@.a
../../lib/libfdschemeio@suffix@.a:
	cd ../..; make lib/libfdschemeio@suffix@.a
../../lib/libfdscheme@suffix@.a:
	cd ../..; make lib/libfdscheme@suffix@.a
../../lib/libfdtype@suffix@.a:
	cd ../..; make lib/libfdtype@suffix@.a
../../lib/libfddb@suffix@.a:
	cd ../..; make lib/libfddb@suffix@.a
../../lib/libfddbdrivers@suffix@.a:
	cd ../..; make lib/libfddbdrivers@suffix@.a
../../lib/libtexttools@suffix@.a:
	cd ../..; make lib/libtexttools@suffix@.a
../../lib/libfdbserv@suffix@.a:
	cd ../..; make lib/libfdbserv@suffix@.a

# Extra dependencies

$(TESTBIN): $(EXTRA_LIBS) \
            ../../lib/libfdscheme@suffix@.a \
	    ../../lib/libfddb@suffix@.a ../../lib/libfdtype@suffix@.a

fdservlet: ../../src/exe/webcommon.h
fdcgiexec: ../../src/exe/webcommon.h

# Test targets

alltests: \
	scheme tables pools indexes frames \
	execscripts chainscripts batchscripts  \
	chained_batchscripts optimize_modules
	@echo "*** Done with alltests"

alltests_but_optmod: \
	scheme tables pools indexes frames \
	execscripts chainscripts batchscripts  \
	chained_batchscripts
	@echo "*** Done with alltests"

cmdtests: execscripts chainscripts batchscripts chained_batchscripts
	@echo "*** Done with alltests"

scheme:
	@echo "*** Running scheme tests to exercise the data/eval layer"
	$(RUNTEST) ./fdexec@suffix@ r4rs.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ TESTOPTIMIZED=yes r4rs.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ exceptions.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ choicetest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ TESTOPTIMIZED=yes choicetest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ seqtest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ TESTOPTIMIZED=yes seqtest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ numvecs.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ picktest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ cachecall.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ texttest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ fdwebtest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ timefns.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ threadtest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ i18n.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ misctest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ TESTOPTIMIZED=yes misctest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ xmltest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ cryptotest.scm ${TESTCONFIG}
	@echo "*** Completed scheme tests to exercise the data/eval layer"
optimizer-tests:
	$(RUNTEST) ./fdexec@suffix@ TESTOPTIMIZED=yes r4rs.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ TESTOPTIMIZED=yes choicetest.scm ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ TESTOPTIMIZED=yes seqtest.scm ${TESTCONFIG}

loadmods: optimize_modules
	$(RUNTEST) ./fdexec@suffix@ loadmods.scm ${TESTCONFIG}
optimize_modules:
	$(RUNTEST) ./fdexec@suffix@ optmods.scm ${TESTCONFIG}

tables:
	@echo "*** Running scheme tests to exercise the table/index layer"
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.table $(TESTSIZE) ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.table ${TESTCONFIG}
	@echo "*** Completed scheme tests to exercise the table/index layer"

pools:
	@echo "*** Running file pool tests ****"
	@rm -f temp.pool
	$(RUNTEST) ./fdexec@suffix@ pooltest.scm ${TESTSIZE} POOLTYPE=filepool
	$(RUNTEST) ./fdexec@suffix@ pooltest.scm ${TESTSIZE} CACHELEVEL=1
	$(RUNTEST) ./fdexec@suffix@ pooltest.scm ${TESTSIZE} CACHELEVEL=2
	@echo "*** Running oidpool tests ****"
	@rm -f temp.pool
	$(RUNTEST) ./fdexec@suffix@ pooltest.scm ${TESTSIZE} POOLTYPE=iodpool
	$(RUNTEST) ./fdexec@suffix@ pooltest.scm ${TESTSIZE} CACHELEVEL=1
	$(RUNTEST) ./fdexec@suffix@ pooltest.scm ${TESTSIZE} CACHELEVEL=2
	@echo "*** Running bigpool tests ****"
	@rm -f temp.pool
	$(RUNTEST) ./fdexec@suffix@ pooltest.scm ${TESTSIZE} POOLTYPE=iodpool
	$(RUNTEST) ./fdexec@suffix@ pooltest.scm ${TESTSIZE} CACHELEVEL=1
	$(RUNTEST) ./fdexec@suffix@ pooltest.scm ${TESTSIZE} CACHELEVEL=2


runindexes:
	@echo "*** Running scheme tests to exercise various kinds of file indexes"
	@rm -f edit.dtype
	# The cache is off by default
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} $(TESTSIZE) ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} ${TESTCONFIG}
	# Test reading with the cache on, consed indices, and both
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} CACHELEVEL=2  ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} CONSINDEX=yes  ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} \
		${TESTCONFIG} CACHELEVEL=2 CONSINDEX=yes
	# Do test edits (no cache)
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} edit.dtype ${TESTCONFIG}
	# Verify test edits
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} edit.dtype ${TESTCONFIG}
	# New test, building with cache enabled
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} $(TESTSIZE) CACHELEVEL=2 ${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} CACHELEVEL=2 ${TESTCONFIG}
	# Try testing without the cache
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} ${TESTCONFIG}
	# Do test edits (with cache)
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} edit.dtype ${TESTCONFIG}
	# Verify test edits
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} edit.dtype ${TESTCONFIG}
	# Build with both cache and consindices
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} $(TESTSIZE) \
		 ${TESTCONFIG} CACHELEVEL=2 CONSINDEX=yes
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} \
		${TESTCONFIG} CACHELEVEL=2 CONSINDEX=yes
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} ${TESTCONFIG}
	# Do test edits (with cache and consindex)
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} edit.dtype
		 ${TESTCONFIG} CACHELEVEL=2 CONSINDEX=yes
	# Verify test edits
	$(RUNTEST) ./fdexec@suffix@ tabletest.scm temp.${TEST_SUFFIX} edit.dtype ${TESTCONFIG}
	@echo "*** Completed scheme tests to exercise file indices "

fileindexes:
	@echo "*** Testing file indices "	
	@make TEST_SUFFIX=index runindexes
	@echo "*** Done testing file indices "	

hashindexes:
	@echo "*** Testing hash indices "	
	@make TEST_SUFFIX=hashindex runindexes
	@echo "*** Done testing hash indices "	

indexes: fileindexes hashindexes

dbtest:
	@echo "*** Running database layer tests"
	$(RUNTEST) ./fdexec@suffix@ dbtest.scm testdb init \
		COUNT=$(TESTSIZE) $(DBTEST_FILES) \
		${TESTCONFIG}
	$(RUNTEST) ./fdexec@suffix@ dbtest.scm testdb COUNT=$(TESTSIZE) ${TESTCONFIG} 
	$(RUNTEST) ./fdexec@suffix@ dbtest.scm testdb COUNT=$(TESTSIZE) \
		 ${TESTCONFIG} CACHELEVEL=2 
	@echo "*** Testing database creation with CACHELEVEL=2"
	$(RUNTEST) ./fdexec@suffix@ dbtest.scm testdb init COUNT=$(TESTSIZE) 	\
		$(DBTEST_FILES) 						\
		${TESTCONFIG} CACHELEVEL=2 	
	$(RUNTEST) ./fdexec@suffix@ dbtest.scm testdb COUNT=$(TESTSIZE) \
		 ${TESTCONFIG} CACHELEVEL=2
	@echo "*** Finished database layer tests"

frames:
	@echo "*** Database layer tests with oidpool/hashindex cofigurations ***"
	make TESTCONFIG="POOLTYPE=oidpool" dbtest
	make TESTCONFIG="POOLTYPE=bigpool" dbtest
	make TESTCONFIG="POOLTYPE=oidpool OFFTYPE=B64" dbtest
	make TESTCONFIG="POOLTYPE=bigpool OFFTYPE=B64" dbtest
	make TESTCONFIG="POOLTYPE=oidpool INDEXTYPE=hashindex" dbtest
	make TESTCONFIG="POOLTYPE=oidpool INDEXTYPE=memindex" dbtest
	make TESTCONFIG="POOLTYPE=bigpool INDEXTYPE=memindex" dbtest
	make dbtest
	@echo "*** Completed hashindex tests with B32 reprepresentation "***""

crypto:
	@echo "*** Running crypto tests ***"
	$(RUNTEST) ./fdexec@suffix@ cryptotest.scm $(TESTCONFIG)
	@echo "*** Completed crypto tests ***"

xmltests:
	@echo "*** Running xml tests ***"
	$(RUNTEST) ./fdexec@suffix@ xmltests.scm $(TESTCONFIG)
	@echo "*** Completed xml tests ***"
execscripts:
	@echo "*** Running exec tests ***"
	./fdexec ./exectest.scm a "b b" c foobar=8 quux=1/2 4 1/3 9/3 5.9 :x
	@echo "*** Running exec test as script ***"
	./exectest.scm a "b b" c foobar=8 quux=1/2 4 1/3 9/3 5.9 :x
	@echo "*** Done with exec tests ***"

randomtests:
	@echo "*** Running alltests with a really random seed"
	make TESTCONFIG="RANDOMSEED=TIME ${TESTCONFIG}" alltests
	@echo "*** Finished alltests with a really random seed"

chainscripts:
	@echo "*** Testing scripts which call CHAIN"
	./fdexec chaintest.scm
	./fdexec chaintest.scm 0 30
	./fdexec chaintest.scm 10 50
	@echo "*** Done testing scripts which call CHAIN"

batchscripts:
	@echo "*** Testing fdbatch execution success and cleanliness"
	@rm -f _countup.log _countup.err _countup.done
	@rm -f  _countup.finished _countup.died _countup.pid
	./fdbatch countup.scm "_countup.finished" 10 1; sleep 3
	@if (test ! -f _countup.pid); then 	\
		echo error; 			\
           exit 1; 				\
	   fi; 					\
	 sleep 12;
	# This was written by fdbatch itself
	@if (test ! -s _countup.done); then	\
		echo _countup.done error; 	\
	  	exit 1; 				\
         fi;
	# This was written by the script
	@if (test ! -s _countup.finished); then		\
	   echo fdbatch success _countup.finished error;	\
	   exit 1;  						\
	 fi;
	@if (test ! -f _countup.err); then		\
		echo fdbatch success _countup.err error;	\
		exit 1; 					\
         fi;
	@if (test ! -s _countup.log); then		\
		echo fdbatch success _countup.log error;	\
		exit 1; 					\
	 fi;
	# These should have been deleted on successful exit
	@if (test -f _countup.died); then			\
		echo fdbatch success _countup.died error;	\
		exit 1; 						\
	 fi;
	@if (test -f _countup.pid); then			\
		echo fdbatch success _countup.pid error; \
		exit 1; 					\
         fi;
	@rm -f _countup.pid _countup.log _countup.err
	@rm -f _countup.done _countup.finished _countup.died
	@echo "*** "Done with fdbatch success test""
	@echo "*** "Starting fdbatch failure test""
	./fdbatch countup.scm ERROR=yes "_countup.finished" 10 1;
	@sleep 12;
	@# This should have been deleted by the watch process
	@if (test -f _countup.pid); then 		\
		echo fdbatch failure _countup.pid error;	\
		exit 1; 					\
		fi;
	@if (test -f _countup.done); then			\
		echo fdbatch failure _countup.done error;	\
		exit 1; 						\
	 fi;
	# This should have been created at exit
	@if (test ! -f _countup.died); then 		\
		echo fdbatch failure countup.died error;	\
		exit 1; 					\
	 fi;
	@echo "*** "Done with fdbatch failure test""
	@echo "*** "Starting fdbatch kill test""
	./fdbatch countup.scm "_countup.killed" 10 1;
	@sleep 3;
	@kill -9 `cat _countup.pid`; sleep 12
	@# This should have been deleted by the watch process
	@if (test -f _countup.pid); then 		\
		echo fdbatch failure _countup.pid error; \
		exit 1; 					\
	 fi;
	@# This should have been deleted by the watch process
	@if (test -f _countup.done); then 		\
		echo fdbatch failure _countup.done error;\
		exit 1; 					\
	 fi;
	@# This should have been created at exit by the watch process
	@if (test ! -f _countup.died); then 		\
		echo fdbatch failure _countup.died error;\
		exit 1; 					\
	 fi;
	@echo "*** "Done with fdbatch kill test""

chained_batchscripts:
	@echo "*** Testing batch scripts which call CHAIN"
	@rm -f _chaintest.*
	./fdbatch chaintest.scm
	@echo "*** Done testing batch scripts which call CHAIN"

# Memory tests

memtest_all: memtest_scheme memtest_tables memtest_pools \
	memtest_indexes memtest_frames memtest_crypto \
	memtest_load_modules memtest_optimize_modules

memtest_scheme: @memtest_prefix@_memtest_scheme
memtest_tables: @memtest_prefix@_memtest_tables
memtest_indexes: @memtest_prefix@_memtest_indexes
memtest_frames: @memtest_prefix@_memtest_frames
memtest_crypto: @memtest_prefix@memcrypto



vg_memtest_all:
	@echo "*** Running alltests with valgrind memory debugging"
	make "TESTPROG=$(VALGRIND)" TESTSIZE=$(SMALLTESTSIZE) alltests
	@echo "*** Finished running alltests with valgrind memory debugging"

vg_memtest_scheme:
	@echo "*** Running tests on data/eval layers with valgrind memory debugging"
	make "TESTPROG=$(VALGRIND)" TESTSIZE=$(SMALLTESTSIZE) scheme
	@echo "*** Finished running tests on data/eval layers with valgrind memory debugging"

vg_memtest_tables:
	@echo "*** Running tests on table/index layers with valgrind memory debugging"
	make "TESTPROG=$(VALGRIND)" TESTSIZE=$(SMALLTESTSIZE) tables
	@echo "*** Finished running tests on table/index layers with valgrind memory debugging"

vg_memtest_pools:
	@echo "*** Running tests on pools with valgrind memory debugging"
	make "TESTPROG=$(VALGRIND)" TESTSIZE=$(SMALLTESTSIZE) pools
	@echo "*** Finished running tests on table/index layers with valgrind memory debugging"

vg_memtest_indexes:
	@echo "*** Running tests on table/index layers with valgrind memory debugging"
	make "TESTPROG=$(VALGRIND)" TESTSIZE=$(SMALLTESTSIZE) indexes
	@echo "*** Finished running tests on table/index layers with valgrind memory debugging"

vg_memtest_frames:
	@echo "*** Running tests on database layers with valgrind memory debugging"
	make "TESTPROG=$(VALGRIND)" TESTSIZE=$(SMALLTESTSIZE) frames
	@echo "*** Finished running tests on database layers with valgrind memory debugging"

vg_memtest_crypto:
	make "TESTPROG=$(VALGRIND)" crypto

vg_memtest_load_modules:
	make "TESTPROG=$(VALGRIND)" TESTSIZE=$(SMALLTESTSIZE) load_modules

vg_memtest_optimize_modules:
	make "TESTPROG=$(VALGRIND)" TESTSIZE=$(SMALLTESTSIZE) optimize_modules

# Gperftools memtests

gperf_memtest_all:
	@echo "*** Running alltests with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 alltests
	@echo "*** Finished running alltests with memory debugging"

gperf_memtest_scheme:
	@echo "*** Running tests on data/eval layers with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 scheme
	@echo "*** Finished running tests on data/eval layers with memory debugging"

gperf_memtest_tables:
	@echo "*** Running tests on table/index layers with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 tables
	@echo "*** Finished running tests on table/index layers with memory debugging"

gperf_memtest_pools:
	@echo "*** Running tests on pools with gperftools memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 pools
	@echo "*** Finished running tests on table/index layers with memory debugging"

gperf_memtest_indexes:
	@echo "*** Running tests on table/index layers with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 indexes
	@echo "*** Finished running tests on table/index layers with memory debugging"

gperf_memtest_frames:
	@echo "*** Running tests on database layers with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 frames
	@echo "*** Finished running tests on database layers with memory debugging"

gperf_memtest_crypto:
	make @memtest_env@ crypto

gperf_memtest_load_modules:
	make @memtest_env@ load_modules

gperf_memtest_optimize_modules:
	make @memtest_env@ optimize_modules

# Embedded Debugging Tools memtests

builtin_memtest_all:
	@echo "*** Running alltests with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 alltests
	@echo "*** Finished running alltests with memory debugging"

builtin_memtest_scheme:
	@echo "*** Running tests on data/eval layers with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 scheme
	@echo "*** Finished running tests on data/eval layers with memory debugging"

builtin_memtest_tables:
	@echo "*** Running tests on table/index layers with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 tables
	@echo "*** Finished running tests on table/index layers with memory debugging"

builtin_memtest_pools:
	@echo "*** Running tests on pools with embedded debugging tools memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 pools
	@echo "*** Finished running tests on table/index layers with memory debugging"

builtin_memtest_indexes:
	@echo "*** Running tests on table/index layers with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 indexes
	@echo "*** Finished running tests on table/index layers with memory debugging"

builtin_memtest_frames:
	@echo "*** Running tests on database layers with memory debugging"
	make @memtest_env@ TESTSIZE=$(TESTSIZE)/4 frames
	@echo "*** Finished running tests on database layers with memory debugging"

builtin_memtest_crypto:
	make @memtest_env@ crypto

builtin_memtest_load_modules:
	make @memtest_env@ load_modules

builtin_memtest_optimize_modules:
	make @memtest_env@ optimize_modules

# Heapchecks

heapcheck_all: heapcheck_scheme heapcheck_tables \
	heapcheck_pools heapcheck_indexes heapcheck_frames \
	heapcheck_crypto heapcheck_load_modules heapcheck_optimize_modules

heapcheck_scheme: @heapcheck_prefix@heapcheck_scheme
heapcheck_tables: @heapcheck_prefix@heacheck_ptables
heapcheck_pools: @heapcheck_prefix@heapcheck_pools
heapcheck_indexes: @heapcheck_prefix@heapcheck_indexes
heapcheck_frames: @heapcheck_prefix@heapcheck_frames
heapcheck_crypto: @heapcheck_prefix@heapcheck_crypto
heapcheck_load_modules: @heapcheck_prefix@heapcheck_load_modules
heapcheck_optimize_modules: @heapcheck_prefix@heapcheck_optimize_modules

# Valgrind heapcheck rules

vg_heapcheck_all:
	@echo "*** Running alltests with valgrind heap debugging"
	make TESTPROG="$(VALGRINDHEAP)" TESTSIZE=$(SMALLTESTSIZE) alltests
	@echo "*** Finished running alltests with valgrind heap debugging"

vg_heapcheck_scheme:
	@echo "*** Running tests on data/eval layers with valgrind heap debugging"
	make TESTPROG="$(VALGRINDHEAP)" TESTSIZE=$(SMALLTESTSIZE) scheme
	@echo "*** Finished running tests on data/eval layers with valgrind heap debugging"

vg_heapcheck_tables:
	@echo "*** Running tests on table/index layers with valgrind heap debugging"
	make TESTPROG="$(VALGRINDHEAP)" TESTSIZE=$(SMALLTESTSIZE) tables
	@echo "*** Finished running tests on table/index layers with valgrind heap debugging"

vg_heapcheck_pools:
	@echo "*** Running tests on pools with valgrind heap debugging"
	make TESTPROG="$(VALGRINDHEAP)" TESTSIZE=$(SMALLTESTSIZE) indexes
	@echo "*** Finished running tests on table/index layers with valgrind heap debugging"

vg_heapcheck_indexes:
	@echo "*** Running tests on table/index layers with valgrind heap debugging"
	make TESTPROG="$(VALGRINDHEAP)" TESTSIZE=$(SMALLTESTSIZE) indexes
	@echo "*** Finished running tests on table/index layers with valgrind heap debugging"

vg_heapcheck_frames:
	@echo "*** Running tests on database layers with valgrind heap debugging"
	make TESTPROG="$(VALGRINDHEAP)" TESTSIZE=$(SMALLTESTSIZE) frames
	@echo "*** Finished running tests on database layers with valgrind heap debugging"

vg_heapcheck_crypto:
	make TESTPROG="$(VALGRINDHEAP)" crypto

vg_heapcheck_load_modules:
	make TESTPROG="$(VALGRINDHEAP)" TESTSIZE=$(SMALLTESTSIZE) load_modules

vg_heapcheck_optimize_modules:
	@echo "Skipping leaktest for optimize modules"

# Gperftools heapcheck rules

gperf_heapcheck_all:
	@echo "*** Running alltests with gperftools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) alltests_but_optmod
	@echo "*** Finished running alltests with gperftools memory debugging"

gperf_heapcheck_scheme:
	@echo "*** Running tests on data/eval layers with gperftools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) scheme
	@echo "*** Finished running tests on data/eval layers with gperftools memory debugging"

gperf_heapcheck_tables:
	@echo "*** Running tests on table/index layers with gperftools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) tables
	@echo "*** Finished running tests on table/index layers with gperftools memory debugging"

gperf_heapcheck_pools:
	@echo "*** Running tests on pools with gperftools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) pools
	@echo "*** Finished running tests on table/index layers with gperftools memory debugging"

gperf_heapcheck_indexes:
	@echo "*** Running tests on table/index layers with gperftools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) indexes
	@echo "*** Finished running tests on table/index layers with gperftools memory debugging"

gperf_heapcheck_frames:
	@echo "*** Running tests on database layers with gperftools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) frames
	@echo "*** Finished running tests on database layers with gperftools memory debugging"

gperf_heapcheck_crypto:
	make @heapcheck_env@ crypto

gperf_heapcheck_load_modules:
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) load_modules

gperf_heapcheck_optimize_modules:
	echo "Skip leak-checking for optimize modules"

# Embedded Debugging Tools heapcheck rules

builtin_heapcheck_all:
	@echo "*** Running alltests with gperftools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) alltests_but_optmod
	@echo "*** Finished running alltests with gperftools memory debugging"

builtin_heapcheck_scheme:
	@echo "*** Running tests on data/eval layers with embedded debugging tools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) scheme
	@echo "*** Finished running tests on data/eval layers with embedded debugging tools memory debugging"

builtin_heapcheck_tables:
	@echo "*** Running tests on table/index layers with embedded debugging tools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) tables
	@echo "*** Finished running tests on table/index layers with embedded debugging tools memory debugging"

builtin_heapcheck_pools:
	@echo "*** Running tests on pools with embedded debugging tools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) pools
	@echo "*** Finished running tests on table/index layers with embedded debugging tools memory debugging"

builtin_heapcheck_indexes:
	@echo "*** Running tests on table/index layers with embedded debugging tools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) indexes
	@echo "*** Finished running tests on table/index layers with embedded debugging tools memory debugging"

builtin_heapcheck_frames:
	@echo "*** Running tests on database layers with embedded debugging tools memory debugging"
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) frames
	@echo "*** Finished running tests on database layers with embedded debugging tools memory debugging"

builtin_heapcheck_crypto:
	make @heapcheck_env@ crypto

builtin_heapcheck_load_modules:
	make @heapcheck_env@ TESTSIZE=$(SMALLTESTSIZE) load_modules

builtin_heapcheck_optimize_modules:
	echo "Skip leak-checking for optimize modules"

