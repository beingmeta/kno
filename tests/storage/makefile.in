# -*- Mode: Makefile; -*-
# Copyright (C) 2004-2019 beingmeta, inc.
# This file is a part of beingmeta's Kno implementation

KNO_LOADPATH=../../src/extmods/:
export KNO_LOADPATH
KNO_DLOADPATH=../../lib/kno
export KNO_DLOADPATH
LD_LIBRARY_PATH=../../lib
export LD_LIBRARY_PATH
DYLD_LIBRARY_PATH=../../lib
export DYLD_LIBRARY_PATH
PPROF_PATH      = @GOOGLE_PPROF@
export PPROF_PATH

CC		= @CC@
XCFLAGS		=
CFLAGS          = -I../../include @CFLAGS@ @PROFILING@ 	\
		  @DREENTRANT@ @dynamic_cflag@ 		\
		  -I../../include $(XCFLAGS)
LDFLAGS         =-L../../lib @LDFLAGS@ $(EFENCE) @TESTLDFLAGS@ -L../../lib 
RPATH           = @rpath@
RPATHFLAGS      = @RPATHFLAGS@
BASELIBS        = @LIBS@ -lm -lz
BMLIBS          = -lu8stdio -lu8io -lu8data -lu8
LIBS            = $(BASELIBS) $(BMLIBS)
EXEFLAGS        = @EXEFLAGS@
EXELIBS         = @EXELIBS@

DESTDIR		=
prefix		= @prefix@
exec_prefix	= @exec_prefix@
LIBINSTALLDIR	= $(DESTDIR)@libdir@
CLEAN		= @CLEAN@
INSTALL		= @INSTALL@
RANLIB		= @RANLIB@
VALGRIND	= valgrind --tool=memcheck --leak-check=yes --num-callers=9 --error-exitcode=-1
TESTPROG	= 
#RUNENV		= LD_LIBRARY_PATH=../../lib DYLD_LIBRARY_PATH=../../lib 
RUNENV		= 
RUNTEST		= $(RUNENV)$(TESTPROG)

NETBRICOPOOL	= brico@dev.beingmeta.com
FILEBRICOPOOL	= /data/brico/brico.pool
ZFILEBRICOPOOL	= /data/bg/brico.pool
NETBRICOINDEX	= brico@dev.beingmeta.com
FILEBRICOINDEX	= /data/brico/brico.index
ZFILEBRICOINDEX	= /data/bg/brico.index
BRICOPOOL	= $(FILEBRICOPOOL)
BRICOINDEX	= $(FILEBRICOINDEX)

TESTBIN=pool-get dtcall indexop index-get dbtool
SHAREDBIN=pool-get.shared dtcall.shared indexop.shared \
          index-get.shared dbtool.shared

all: $(TESTBIN) $(SHAREDBIN)

%.o: %.c
	@$(CC) $(CFLAGS) -o $@ $<
	@echo CC $@ $<

$(TESTBIN): ../../lib/libknodrivers@suffix@.a 	\
	../../lib/libknostorage@suffix@.a 		\
	../../lib/libknocore@suffix@.a

# Note that we don't add @suffix@ to these executables because they're
# never installed
%: %.c ../../lib/libknodrivers@suffix@.a 	\
	../../lib/libknostorage@suffix@.a 		\
	../../lib/libknocore@suffix@.a
	@echo MKTEST_STATIC $@
	@$(CC) $(CFLAGS) $(EXEFLAGS) @STATICLDFLAGS@ $(LDFLAGS) $(EXELIBS) -o $@ $^ \
		$(LIBS) $(EXELIBS)

# This is for making shared (dynamically linked) versions of the test programs
%.shared: %.c
	@echo MKTEST_SHARED $@
	@$(CC) $(CFLAGS) $(EXEFLAGS) $(LDFLAGS) -o $@ $^ $(LIBS) $(EXELIBS) \
		-lfdcore@suffix@ -lfdstorage@suffix@ -lfddrivers@suffix@ $(LIBS) $(EXELIBS)
../../lib/libknocore@suffix@.a:
	cd ../..; make lib/libknocore@suffix@.a
../../lib/libknostorage@suffix@.a:
	cd ../..; make lib/libknostorage@suffix@.a
../../lib/libknodrivers@suffix@.a:
	cd ../..; make lib/libknodrivers@suffix@.a

clean:
	rm -f $(TESTBIN)

alltests: allpooltests allindextests

pooltests:
	$(RUNTEST) ./pool-get $(BRICOPOOL) @1/13800
	$(RUNTEST) ./pool-get $(BRICOPOOL) @1/13800 @1/13ad9 \
			@1/1525d @1/1bbe8 @1/1bdff @1/1cb47
	$(RUNTEST) ./pool-get $(BRICOPOOL) @/brico/13800 @/brico/13ad9 \
			@/brico/1525d @/brico/1bbe8 @/brico/1bdff @/brico/1cb47

filepooltests:
	@echo "***" Running file pool tests
	make BRICOPOOL=$(FILEBRICOPOOL) pooltests
netpooltests:
	@echo "***" Running netpool tests
	make BRICOPOOL=$(NETBRICOPOOL) pooltests

allpooltests: filepooltests netpooltests

indextests:
	$(RUNTEST) ./index-get $(BRICOINDEX) "(@1/2c1c7 . \"example\")"
	$(RUNTEST) ./index-get $(BRICOINDEX) "(@1/2c1c7 . \"example\")" \
		"(@1/2c1c7 . \"fish\")" "(@1/2c1c7 . \"dog\")"

fileindextests:
	@echo "***" Running file index tests
	make BRICOINDEX=$(FILEBRICOINDEX) indextests
netindextests:
	@echo "***" Running netindex tests
	make BRICOINDEX=$(NETBRICOINDEX) indextests

allindextests: fileindextests netindextests
