#!/bin/sh

if test $# -eq 0; then
   echo "Usage: runtest <program> [args...]";
   exit;
fi
PROGNAME=$1; shift;
LOGFILE=${USELOG:-state/$$.log}
LOGTIME=state/t$$.elapsed
KEEPTIMES=no
KEEPLOGS=no
COMBOLOG=state/success.log

if [ ! -z "${DEBUGGING}" ]; then
    echo "Testing: @test_env@ ${PROGNAME} $* LOGTIME=${LOGTIME} > ${LOGFILE}";
fi;
echo "$$ @test_env@ ${PROGNAME} $* LOGTIME=${LOGTIME} > ${LOGFILE}" >> state/alltests.log
echo "$$ @test_env@ ${PROGNAME} $* LOGTIME=${LOGTIME} > ${LOGFILE}" > state/$$.cmd
    
if test ! -z ${PREAMBLE}; then
   echo "TEST: " ${PROGNAME} $*;
fi;

. ../dbg/runenv.sh
. ./testenv.sh

if [ "${LOGFILE}" != "none" ]; then
    if @test_env@ ${PROGNAME} $* LOGTIME=${LOGTIME} > ${LOGFILE}; then
	MSG="SUCCESS"
	SUCCESS=yes
    else
	MSG="FAILURE"
	COMBOLOG=state/failure.log
	SUCCESS=no
    fi;
else
    if @test_env@ ${PROGNAME} $* LOGTIME=${LOGTIME}; then
	MSG="SUCCESS"
	SUCCESS=yes
    else
	MSG="FAILURE"
	COMBOLOG=state/failure.log
	SUCCESS=no
    fi;
fi;

if test -f ${LOGTIME}; then
    TIMING=$(awk '{ print $2}' ${LOGTIME});
    printf "%f\t %s\n" ${TIMING} "${PROGNAME} $*" >> state/timing.log
    if [ "${KEEPTIMES}" = "no" ]; then
	rm -f ${LOGTIME};
    fi;
else
    TIMING=untimed;
fi;

# Save the log file
printf "# TEST: %s\t(t%d) (%ssecs)\n" "${PROGNAME} $*" "$$" "${TIMING}" >> ${COMBOLOG}
if [ -f ${LOGFILE} ]; then
    if [ ! -z "${DEBUGGING}" ]; then
	cat ${LOGFILE} >> ${COMBOLOG} || echo "Log file ${LOGFILE} has disappeared";
    else
	cat ${LOGFILE} >> ${COMBOLOG} || true;
    fi;
    if [ "$SUCCESS" = "no" ]; then
	printf "Log file in %s\n" "${LOGFILE}";
    elif [ "$KEEPLOGS" = "no" ]; then
	rm -f ${LOGFILE} $$.*.started $$.*.cmd;
    fi;
elif [ ! -z "${DEBUGGING}" ]; then
    echo "Warning, log file ${LOGFILE} doesn't exist for ($MSG) test $*";
fi;

# Output the result message
printf "%s: (%s) (t%d)\t%s\n" "$MSG" "$TIMING" "$$" "${PROGNAME} $*";
    
